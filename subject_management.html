<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alama Hub - Teacher Allocation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <style>
        :root {
            --primary-green: #075824;
            --secondary-green: #377437;
            --accent-green: #9BAE30;
            --muted-green: #5D8B70;
            --accent-blue: #333687;
            --background-light: #F4F4F4;
            --text-light: #FFFFFF;
            --warning-orange: #ff9800;
            --error-red: #dc3545;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-light);
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background-image: linear-gradient(rgba(244, 244, 244, 0.9), rgba(244, 244, 244, 0.9)), 
                              url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23075824" opacity="0.03"/><path d="M20,20 L80,80 M80,20 L20,80" stroke="%23337437" stroke-width="1" opacity="0.05"/></svg>');
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(7, 88, 36, 0.15);
            overflow: hidden;
        }

        .header {
            background-color: var(--primary-green);
            color: var(--text-light);
            text-align: center;
            padding: 25px 20px;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 5px;
            letter-spacing: 1px;
        }

        .header h2 {
            font-size: 1.2rem;
            font-weight: 400;
            opacity: 0.9;
        }

        .badge-container {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        }

        .school-badge {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 5px;
        }

        .badge-fallback {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-green);
            color: white;
            font-size: 24px;
        }

        .form-container {
            padding: 30px;
        }

        .page-title {
            color: var(--primary-green);
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .page-subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1rem;
        }

        /* Form Layout */
        .form-section {
            background-color: #f9f9f9;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e0e0e0;
        }

        .section-title {
            color: var(--primary-green);
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--accent-green);
        }

        /* Form Grid */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-green);
        }

        .input-with-icon {
            position: relative;
        }

        .input-with-icon i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--muted-green);
            z-index: 2;
        }

        .input-with-icon input,
        .input-with-icon select {
            width: 100%;
            padding: 14px 14px 14px 45px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background-color: white;
        }

        .input-with-icon input:focus,
        .input-with-icon select:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 2px rgba(155, 174, 48, 0.2);
        }

        /* Teacher Search */
        .teacher-search-container {
            position: relative;
            margin-bottom: 10px;
        }

        #teacher-search {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        #teacher-search:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 2px rgba(155, 174, 48, 0.2);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--muted-green);
        }

        .clear-search {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            display: none;
        }

        .clear-search:hover {
            color: #666;
        }

        .teacher-list-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: white;
            margin-top: 10px;
            display: none;
            position: absolute;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .teacher-list-container.active {
            display: block;
        }

        .teacher-option {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.2s ease;
        }

        .teacher-option:hover {
            background-color: rgba(7, 88, 36, 0.05);
        }

        .teacher-option.selected {
            background-color: rgba(155, 174, 48, 0.1);
            color: var(--primary-green);
            font-weight: 600;
        }

        .teacher-option .tsc-number {
            font-size: 0.85rem;
            color: var(--muted-green);
            margin-left: 5px;
        }

        .teacher-details {
            margin-top: 10px;
            padding: 15px;
            background-color: rgba(155, 174, 48, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(155, 174, 48, 0.2);
            display: none;
        }

        .teacher-details.active {
            display: block;
        }

        .teacher-detail-row {
            display: flex;
            margin-bottom: 8px;
        }

        .teacher-detail-label {
            font-weight: 600;
            min-width: 120px;
            color: var(--primary-green);
        }

        .teacher-detail-value {
            color: #555;
        }

        /* Subject Search */
        .subject-search-container {
            position: relative;
            margin-bottom: 10px;
        }

        #subject-search {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        #subject-search:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 2px rgba(155, 174, 48, 0.2);
        }

        .subject-list-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: white;
            margin-top: 10px;
            display: none;
            position: absolute;
            width: 100%;
            z-index: 999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .subject-list-container.active {
            display: block;
        }

        .subject-option {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.2s ease;
        }

        .subject-option:hover {
            background-color: rgba(7, 88, 36, 0.05);
        }

        .subject-option.selected {
            background-color: rgba(155, 174, 48, 0.1);
            color: var(--primary-green);
            font-weight: 600;
        }

        .subject-option .subject-code {
            font-size: 0.85rem;
            color: var(--muted-green);
            margin-left: 5px;
        }

        /* Stream Management */
        .streams-section {
            margin-top: 25px;
        }

        .stream-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stream-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background-color: white;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        .stream-item input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.95rem;
        }

        .stream-item input:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        .add-stream-btn {
            background-color: var(--muted-green);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }

        .add-stream-btn:hover {
            background-color: var(--secondary-green);
        }

        /* Button Section */
        .button-section {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            padding-top: 25px;
            border-top: 1px solid #eee;
        }

        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            min-width: 200px;
            justify-content: center;
        }

        .btn-primary {
            background-color: var(--primary-green);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-green);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(7, 88, 36, 0.2);
        }

        .btn-primary:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background-color: white;
            color: var(--primary-green);
            border: 2px solid var(--primary-green);
        }

        .btn-secondary:hover {
            background-color: rgba(7, 88, 36, 0.05);
            transform: translateY(-3px);
        }

        /* Assigned Teachers Section */
        .assigned-teachers {
            margin-top: 40px;
        }

        .assignments-search-container {
            margin-bottom: 20px;
            position: relative;
        }

        .assignments-search {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .assignments-search:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 2px rgba(155, 174, 48, 0.2);
        }

        .assignments-search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--muted-green);
        }

        .clear-assignments-search {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            display: none;
        }

        .clear-assignments-search:hover {
            color: #666;
        }

        .assignments-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            color: var(--muted-green);
            font-size: 0.95rem;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 10px;
        }

        .assignments-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }

        .assignments-table th {
            background-color: var(--primary-green);
            color: white;
            text-align: left;
            padding: 15px;
            font-weight: 600;
        }

        .assignments-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        .assignments-table tr:hover {
            background-color: rgba(7, 88, 36, 0.03);
        }

        .stream-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .stream-tag {
            background-color: rgba(155, 174, 48, 0.1);
            color: var(--accent-green);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        /* Status Message */
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .status-success {
            background-color: rgba(155, 174, 48, 0.1);
            color: var(--accent-green);
            border: 1px solid rgba(155, 174, 48, 0.3);
        }

        .status-error {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }

        .status-warning {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--warning-orange);
            border: 1px solid rgba(255, 152, 0, 0.3);
        }

        .status-info {
            background-color: rgba(51, 54, 135, 0.1);
            color: var(--accent-blue);
            border: 1px solid rgba(51, 54, 135, 0.3);
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(155, 174, 48, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-green);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Footer */
        .footer {
            margin-top: 30px;
            text-align: center;
            color: var(--muted-green);
            font-size: 0.9rem;
        }

        .footer a {
            color: var(--accent-blue);
            text-decoration: none;
        }

        /* Responsive adjustments */
        @media (max-width: 850px) {
            .container {
                max-width: 100%;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .header h2 {
                font-size: 1rem;
            }
            
            .badge-container {
                width: 50px;
                height: 50px;
                top: 15px;
                left: 15px;
            }
            
            .form-container {
                padding: 20px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .button-section {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }
            
            .stream-container {
                grid-template-columns: 1fr;
            }
            
            .assignments-stats {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }

        @media (max-width: 500px) {
            .header h1 {
                font-size: 1.8rem;
                margin-top: 10px;
            }
            
            .badge-container {
                position: relative;
                top: 0;
                left: 0;
                margin: 0 auto 15px;
            }
            
            .header {
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 20px 15px;
            }
            
            .section-title {
                font-size: 1.1rem;
            }
        }

        /* Search highlight */
        .highlight {
            background-color: rgba(155, 174, 48, 0.2);
            font-weight: 600;
            padding: 0 2px;
            border-radius: 2px;
        }
        
        /* Table row highlight for search */
        .search-highlight {
            background-color: rgba(155, 174, 48, 0.1);
        }

        /* Database status indicator */
        .db-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 1000;
        }

        .db-status.connected {
            background-color: rgba(155, 174, 48, 0.1);
            color: var(--accent-green);
            border: 1px solid rgba(155, 174, 48, 0.3);
        }

        .db-status.disconnected {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }

        .db-status.loading {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--warning-orange);
            border: 1px solid rgba(255, 152, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="badge-container">
                <img src="images/badge.png" alt="Alliance Girls High School Badge" class="school-badge" onerror="this.style.display='none'; document.querySelector('.badge-fallback').style.display='flex';">
                <div class="badge-fallback" style="display: none;">
                    <i class="fas fa-graduation-cap"></i>
                </div>
            </div>
            <h1>Alama Hub</h1>
            <h2>Teacher Allocation System</h2>
        </div>
        
        <div class="form-container">
            <h1 class="page-title">Allocate Teacher to Subject & Form</h1>
            <p class="page-subtitle">Assign teachers to subjects, forms/classes, and manage streams</p>
            
            <!-- Status Message -->
            <div id="status-message" class="status-message"></div>
            
            <!-- Teacher Selection Section -->
            <div class="form-section">
                <h2 class="section-title">
                    <i class="fas fa-user-tie"></i> Select Teacher from Database
                </h2>
                
                <div class="form-group">
                    <label for="teacher-search">Search Teacher by Name or TSC Number</label>
                    <div class="teacher-search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="teacher-search" placeholder="Start typing teacher name or TSC number...">
                        <button type="button" class="clear-search" id="clear-teacher-search">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="teacher-list-container" id="teacher-list">
                        <!-- Teacher options will be populated here -->
                    </div>
                    
                    <div class="teacher-details" id="teacher-details">
                        <div class="teacher-detail-row">
                            <span class="teacher-detail-label">Full Name:</span>
                            <span class="teacher-detail-value" id="teacher-full-name"></span>
                        </div>
                        <div class="teacher-detail-row">
                            <span class="teacher-detail-label">TSC Number:</span>
                            <span class="teacher-detail-value" id="teacher-tsc-number"></span>
                        </div>
                        <div class="teacher-detail-row">
                            <span class="teacher-detail-label">Email:</span>
                            <span class="teacher-detail-value" id="teacher-email"></span>
                        </div>
                        <div class="teacher-detail-row">
                            <span class="teacher-detail-label">Phone:</span>
                            <span class="teacher-detail-value" id="teacher-phone"></span>
                        </div>
                    </div>
                    
                    <input type="hidden" id="selected-teacher-id" value="">
                    <input type="hidden" id="selected-teacher-name" value="">
                    <input type="hidden" id="selected-teacher-tsc" value="">
                </div>
            </div>
            
            <!-- Teaching Allocation Section -->
            <div class="form-section">
                <h2 class="section-title">
                    <i class="fas fa-chalkboard-teacher"></i> Teaching Allocation
                </h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="form-grade">Form/Grade</label>
                        <div class="input-with-icon">
                            <i class="fas fa-graduation-cap"></i>
                            <select id="form-grade" required>
                                <option value="">Select Form/Grade</option>
                                <option value="form_3">Form 3</option>
                                <option value="form_4">Form 4</option>
                                <option value="grade_10">Grade 10</option>
                                <option value="grade_11">Grade 11</option>
                                <option value="grade_12">Grade 12</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Subject to Teach</label>
                        <div class="subject-search-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="subject-search" placeholder="Search for a subject...">
                            <button type="button" class="clear-search" id="clear-subject-search">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="subject-list-container" id="subject-list">
                            <!-- Subject options will be populated here -->
                        </div>
                        
                        <input type="hidden" id="selected-subject" value="">
                        <input type="hidden" id="selected-subject-display" value="">
                    </div>
                </div>
                
                <!-- Stream Management -->
                <div class="streams-section">
                    <h3 style="color: var(--primary-green); margin-bottom: 15px; font-size: 1.1rem;">
                        <i class="fas fa-stream"></i> Streams for Selected Form/Grade
                    </h3>
                    
                    <div id="stream-container" class="stream-container">
                        <!-- Stream items will be added here dynamically -->
                        <div class="stream-item">
                            <input type="text" class="stream-input" placeholder="Enter stream name (e.g., North, South)">
                        </div>
                    </div>
                    
                    <button type="button" id="add-stream-btn" class="add-stream-btn">
                        <i class="fas fa-plus"></i> Add Another Stream
                    </button>
                </div>
            </div>
            
            <!-- Button Section -->
            <div class="button-section">
                <button type="button" id="assign-btn" class="btn btn-primary" disabled>
                    <i class="fas fa-user-check"></i> Assign Teacher
                </button>
                <button type="button" id="clear-btn" class="btn btn-secondary">
                    <i class="fas fa-eraser"></i> Clear Form
                </button>
            </div>
            
            <!-- Assigned Teachers Section -->
            <div class="assigned-teachers">
                <h2 class="section-title">
                    <i class="fas fa-list"></i> Currently Assigned Teachers
                </h2>
                
                <!-- Search Bar for Assigned Teachers -->
                <div class="assignments-search-container">
                    <i class="fas fa-search assignments-search-icon"></i>
                    <input type="text" id="assignments-search" class="assignments-search" placeholder="Search assigned teachers by name, TSC, subject, or form...">
                    <button type="button" class="clear-assignments-search" id="clear-assignments-search">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- Assignments Statistics -->
                <div class="assignments-stats">
                    <div id="assignments-count">Total Assignments: 0</div>
                    <div id="search-results-count"></div>
                    <button type="button" id="refresh-assignments" class="action-btn edit-btn" style="font-size: 0.8rem;">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                
                <div class="table-container">
                    <table class="assignments-table" id="assignments-table">
                        <thead>
                            <tr>
                                <th>Teacher Name</th>
                                <th>TSC No.</th>
                                <th>Subject</th>
                                <th>Form/Grade</th>
                                <th>Streams</th>
                            </tr>
                        </thead>
                        <tbody id="assignments-body">
                            <!-- Assigned teachers will be added here dynamically -->
                            <tr>
                                <td colspan="5" class="no-results" id="no-results-message">
                                    Loading assignments...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>Â© 2023 Alliance Girls High School - Alama Hub. All rights reserved.</p>
        <p><a href="#">Teacher Dashboard</a> | <a href="#">Manage Subjects</a> | <a href="#">Help Center</a></p>
    </div>

    <!-- Database Connection Status -->
    <div id="db-status" class="db-status loading">
        <span class="spinner"></span>
        <span>Connecting to database...</span>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://eloqizcahwxavsbalxii.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVsb3FpemNhaHd4YXZzYmFseGlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTQ4OTUsImV4cCI6MjA4MzI5MDg5NX0.SGogIbdShzCLv2TovpdS1BDf6GJx4mu0iz9s25BGRRQ';

        // All subjects data
        const allSubjects = [
            { code: "ENG", name: "English Language" },
            {code: "MFT", name: "Maritime & Fisheries Technology" },
            {code: "ENV", name: "Environmental Science" },
            {code: "AUT" , name: "Automotive Technology" },
            { code: "KIS", name: "Kiswahili" },
            { code: "KSL", name: "Kenya Sign Language (KSL)" },
            { code: "CMAT", name: "Core Mathematics" },
            { code: "EMAT", name: "Essential Mathematics" },
            { code: "CSL", name: "Community Service Learning (CSL)" },
            { code: "BIO", name: "Biology" },
            { code: "CHE", name: "Chemistry" },
            { code: "PHY", name: "Physics" },
            { code: "AMAT", name: "Advanced Mathematics" },
            { code: "AGR", name: "Agriculture" },
            { code: "CST", name: "Computer Studies" },
            { code: "HSC", name: "Home Science" },
            { code: "BST", name: "Business Studies" },
            { code: "AVT", name: "Aviation Technology" },
            { code: "BCT", name: "Building Construction" },
            { code: "PMT", name: "Power Mechanics" },
            { code: "ELT", name: "Electricity" },
            { code: "MDT", name: "Metal Technology" },
            {code: "FTT" , name: "Fashion & Textile Technology" },
            { code: "WDT", name: "Woodwork Technology (woodwork)" },
            { code: "MFT", name: "Marine & Fisheries Technology" },
            { code: "HCT", name: "History and Citizenship" },
            { code: "GEO", name: "Geography" },
            { code: "CRE", name: "Christian Religious Education (CRE)" },
            { code: "IRE", name: "Islamic Religious Education (IRE)" },
            { code: "HRE", name: "Hindu Religious Education (HRE)" },
            { code: "LIT", name: "Literature in English" },
            { code: "FAS", name: "Fasihi ya Kiswahili" },
            { code: "IL", name: "Indigenous Languages" },
            { code: "ARB", name: "Arabic" },
            { code: "FRE", name: "French" },
            { code: "GER", name: "German" },
            { code: "MAN", name: "Mandarin Chinese" },
            { code: "FAT", name: "Fine Art" },
            { code: "TFM", name: "Theatre and Film" },
            { code: "MUS", name: "Music" },
            { code: "DAN", name: "Dance" },
            { code: "SR", name: "Sports and Recreation" }
        ];

        // Global variables
        let supabase = null;
        let assignedTeachers = [];
        let filteredAssignments = [];
        let currentSearchTerm = '';
        let allTeachers = [];
        
        // DOM Elements
        const teacherSearch = document.getElementById('teacher-search');
        const clearTeacherSearchBtn = document.getElementById('clear-teacher-search');
        const teacherList = document.getElementById('teacher-list');
        const teacherDetails = document.getElementById('teacher-details');
        const teacherFullNameSpan = document.getElementById('teacher-full-name');
        const teacherTscNumberSpan = document.getElementById('teacher-tsc-number');
        const teacherEmailSpan = document.getElementById('teacher-email');
        const teacherPhoneSpan = document.getElementById('teacher-phone');
        const selectedTeacherIdInput = document.getElementById('selected-teacher-id');
        const selectedTeacherNameInput = document.getElementById('selected-teacher-name');
        const selectedTeacherTscInput = document.getElementById('selected-teacher-tsc');
        
        const teacherNameInput = document.getElementById('teacher-name');
        const tscNumberInput = document.getElementById('tsc-number');
        const formGradeSelect = document.getElementById('form-grade');
        const subjectSearch = document.getElementById('subject-search');
        const clearSubjectSearchBtn = document.getElementById('clear-subject-search');
        const subjectList = document.getElementById('subject-list');
        const selectedSubjectInput = document.getElementById('selected-subject');
        const selectedSubjectDisplayInput = document.getElementById('selected-subject-display');
        const streamContainer = document.getElementById('stream-container');
        const addStreamBtn = document.getElementById('add-stream-btn');
        const assignBtn = document.getElementById('assign-btn');
        const clearBtn = document.getElementById('clear-btn');
        const assignmentsBody = document.getElementById('assignments-body');
        const statusMessage = document.getElementById('status-message');
        const assignmentsSearch = document.getElementById('assignments-search');
        const clearAssignmentsSearchBtn = document.getElementById('clear-assignments-search');
        const assignmentsCount = document.getElementById('assignments-count');
        const searchResultsCount = document.getElementById('search-results-count');
        const noResultsMessage = document.getElementById('no-results-message');
        const refreshAssignmentsBtn = document.getElementById('refresh-assignments');
        const dbStatus = document.getElementById('db-status');

        // Initialize the application
        async function initApp() {
            try {
                // Initialize Supabase
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // Test database connection
                await testDatabaseConnection();
                
                // Load teachers from database
                await loadTeachersFromDatabase();
                
                // Load assignments from database
                await loadAssignmentsFromDatabase();
                
                // Set up event listeners
                setupEventListeners();
                
                // Populate subject list
                populateSubjectList();
                
                // Update database status
                updateDatabaseStatus(true, 'Connected to database');
                
            } catch (error) {
                console.error('Error initializing application:', error);
                updateDatabaseStatus(false, 'Database connection failed');
                showStatus('Failed to connect to database. Some features may not work.', 'error');
                
                // Still set up event listeners for offline mode
                setupEventListeners();
                populateSubjectList();
            }
        }
        
        // Test database connection
        async function testDatabaseConnection() {
            try {
                // Try to fetch teachers table to test connection
                const { data, error } = await supabase
                    .from('teachers')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    throw error;
                }
                
                return true;
            } catch (error) {
                console.error('Database connection test failed:', error);
                throw error;
            }
        }
        
        // Load teachers from database
        async function loadTeachersFromDatabase() {
            try {
                showLoadingStatus('Loading teachers from database...');
                
                const { data, error } = await supabase
                    .from('teachers')
                    .select('*')
                    .order('full_name', { ascending: true });
                
                if (error) {
                    throw error;
                }
                
                allTeachers = data || [];
                
                if (allTeachers.length === 0) {
                    showStatus('No teachers found in database. Please add teachers first.', 'warning');
                } else {
                    showStatus(`Loaded ${allTeachers.length} teachers from database`, 'success');
                }
                
            } catch (error) {
                console.error('Error loading teachers:', error);
                showStatus('Failed to load teachers from database', 'error');
                allTeachers = [];
            }
        }
        
        // Load assignments from database
        async function loadAssignmentsFromDatabase() {
            try {
                showLoadingStatus('Loading assignments from database...');
                
                const { data, error } = await supabase
                    .from('teacher_assignments')
                    .select(`
                        *,
                        teacher:teacher_id (full_name, tsc_number)
                    `)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    throw error;
                }
                
                assignedTeachers = data || [];
                filteredAssignments = [...assignedTeachers];
                
                // Update the table
                renderAssignmentsTable();
                
                // Update counts
                updateAssignmentsCount();
                
                showStatus(`Loaded ${assignedTeachers.length} assignments from database`, 'success');
                
            } catch (error) {
                console.error('Error loading assignments:', error);
                showStatus('Failed to load assignments from database', 'error');
                assignedTeachers = [];
                filteredAssignments = [];
                
                // Show error in table
                noResultsMessage.textContent = 'Failed to load assignments. Please check database connection.';
                noResultsMessage.style.display = 'table-cell';
            }
        }
        
        // Save assignment to database
        async function saveAssignmentToDatabase(assignment) {
            try {
                const { data, error } = await supabase
                    .from('teacher_assignments')
                    .insert([
                        {
                            teacher_id: assignment.teacherId,
                            subject_code: assignment.subjectCode,
                            subject_display: assignment.subjectDisplay,
                            form_grade: assignment.formGrade,
                            form_grade_display: assignment.formGradeDisplay,
                            streams: assignment.streams,
                            created_at: new Date().toISOString()
                        }
                    ])
                    .select(`
                        *,
                        teacher:teacher_id (full_name, tsc_number)
                    `);
                
                if (error) {
                    throw error;
                }
                
                return data ? data[0] : null;
                
            } catch (error) {
                console.error('Error saving assignment:', error);
                throw error;
            }
        }
        
        // Delete assignment from database
        async function deleteAssignmentFromDatabase(assignmentId) {
            try {
                const { error } = await supabase
                    .from('teacher_assignments')
                    .delete()
                    .eq('id', assignmentId);
                
                if (error) {
                    throw error;
                }
                
                return true;
                
            } catch (error) {
                console.error('Error deleting assignment:', error);
                throw error;
            }
        }
        
        // Populate teacher search list
        function populateTeacherList(filter = '') {
            teacherList.innerHTML = '';
            
            if (allTeachers.length === 0) {
                const option = document.createElement('div');
                option.className = 'teacher-option';
                option.textContent = 'No teachers found in database';
                teacherList.appendChild(option);
                teacherList.classList.add('active');
                return;
            }
            
            // Filter teachers based on search term
            const filteredTeachers = allTeachers.filter(teacher => {
                if (!filter) return true;
                
                const searchLower = filter.toLowerCase();
                const teacherNameLower = teacher.full_name ? teacher.full_name.toLowerCase() : '';
                const tscNumberLower = teacher.tsc_number ? teacher.tsc_number.toLowerCase() : '';
                const emailLower = teacher.email ? teacher.email.toLowerCase() : '';
                
                return teacherNameLower.includes(searchLower) || 
                       tscNumberLower.includes(searchLower) ||
                       emailLower.includes(searchLower);
            });
            
            // Display filtered teachers
            filteredTeachers.forEach(teacher => {
                const option = document.createElement('div');
                option.className = 'teacher-option';
                option.setAttribute('data-id', teacher.id);
                option.setAttribute('data-name', teacher.full_name);
                option.setAttribute('data-tsc', teacher.tsc_number);
                option.setAttribute('data-email', teacher.email || '');
                option.setAttribute('data-phone', teacher.phone || '');
                
                // Highlight matching text if there's a filter
                let displayName = teacher.full_name || 'Unknown Name';
                if (filter) {
                    displayName = highlightMatches(displayName, filter);
                }
                
                option.innerHTML = `
                    ${displayName}
                    <span class="tsc-number">(${teacher.tsc_number || 'No TSC'})</span>
                `;
                
                option.addEventListener('click', () => {
                    selectTeacher(
                        teacher.id,
                        teacher.full_name,
                        teacher.tsc_number,
                        teacher.email,
                        teacher.phone
                    );
                });
                
                teacherList.appendChild(option);
            });
            
            // Show/hide teacher list
            if (filteredTeachers.length > 0) {
                teacherList.classList.add('active');
            } else {
                teacherList.classList.remove('active');
            }
        }
        
        // Select a teacher
        function selectTeacher(id, name, tsc, email, phone) {
            selectedTeacherIdInput.value = id;
            selectedTeacherNameInput.value = name;
            selectedTeacherTscInput.value = tsc;
            teacherSearch.value = name;
            teacherList.classList.remove('active');
            clearTeacherSearchBtn.style.display = 'block';
            
            // Show teacher details
            teacherFullNameSpan.textContent = name || 'Not available';
            teacherTscNumberSpan.textContent = tsc || 'Not available';
            teacherEmailSpan.textContent = email || 'Not available';
            teacherPhoneSpan.textContent = phone || 'Not available';
            teacherDetails.classList.add('active');
            
            // Highlight selected option
            document.querySelectorAll('.teacher-option').forEach(option => {
                option.classList.remove('selected');
                if (option.getAttribute('data-id') === id.toString()) {
                    option.classList.add('selected');
                }
            });
            
            // Enable assign button if other fields are filled
            checkFormCompletion();
        }
        
        // Populate subject list
        function populateSubjectList(filter = '') {
            subjectList.innerHTML = '';
            
            // Filter subjects based on search term
            const filteredSubjects = allSubjects.filter(subject => {
                if (!filter) return true;
                
                const searchLower = filter.toLowerCase();
                const subjectNameLower = subject.name.toLowerCase();
                const subjectCodeLower = subject.code.toLowerCase();
                
                return subjectNameLower.includes(searchLower) || 
                       subjectCodeLower.includes(searchLower) ||
                       subjectNameLower.replace(/\s+/g, '').includes(searchLower.replace(/\s+/g, ''));
            });
            
            // Display filtered subjects
            filteredSubjects.forEach(subject => {
                const option = document.createElement('div');
                option.className = 'subject-option';
                option.setAttribute('data-code', subject.code);
                option.setAttribute('data-name', subject.name);
                
                // Highlight matching text if there's a filter
                let displayName = subject.name;
                if (filter) {
                    displayName = highlightMatches(subject.name, filter);
                }
                
                option.innerHTML = `
                    ${displayName}
                    <span class="subject-code">(${subject.code})</span>
                `;
                
                option.addEventListener('click', () => {
                    selectSubject(subject.code, subject.name);
                });
                
                subjectList.appendChild(option);
            });
            
            // Show/hide subject list
            if (filteredSubjects.length > 0) {
                subjectList.classList.add('active');
            } else {
                subjectList.classList.remove('active');
            }
        }
        
        // Select a subject
        function selectSubject(code, name) {
            selectedSubjectInput.value = code;
            selectedSubjectDisplayInput.value = name;
            subjectSearch.value = name;
            subjectList.classList.remove('active');
            clearSubjectSearchBtn.style.display = 'block';
            
            // Highlight selected option
            document.querySelectorAll('.subject-option').forEach(option => {
                option.classList.remove('selected');
                if (option.getAttribute('data-code') === code) {
                    option.classList.add('selected');
                }
            });
            
            // Enable assign button if other fields are filled
            checkFormCompletion();
        }
        
        // Highlight matching text in search results
        function highlightMatches(text, searchTerm) {
            if (!searchTerm || !text) return text;
            
            const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }
        
        // Check if form is complete and enable/disable assign button
        function checkFormCompletion() {
            const isTeacherSelected = selectedTeacherIdInput.value !== '';
            const isSubjectSelected = selectedSubjectInput.value !== '';
            const isFormSelected = formGradeSelect.value !== '';
            const streams = getStreamValues();
            const hasStreams = streams.length > 0;
            
            assignBtn.disabled = !(isTeacherSelected && isSubjectSelected && isFormSelected && hasStreams);
        }
        
        // Search assigned teachers
        function searchAssignments(searchTerm) {
            currentSearchTerm = searchTerm.toLowerCase().trim();
            
            if (!currentSearchTerm) {
                filteredAssignments = [...assignedTeachers];
                renderAssignmentsTable();
                updateSearchResultsCount();
                return;
            }
            
            // Filter assignments based on search term
            filteredAssignments = assignedTeachers.filter(assignment => {
                const teacherName = assignment.teacher?.full_name?.toLowerCase() || '';
                const tscNumber = assignment.teacher?.tsc_number?.toLowerCase() || '';
                const subjectDisplay = assignment.subject_display?.toLowerCase() || '';
                const subjectCode = assignment.subject_code?.toLowerCase() || '';
                const formGrade = assignment.form_grade_display?.toLowerCase() || '';
                const streams = (assignment.streams || []).join(' ').toLowerCase();
                
                // Search in all relevant fields
                return teacherName.includes(currentSearchTerm) ||
                       tscNumber.includes(currentSearchTerm) ||
                       subjectDisplay.includes(currentSearchTerm) ||
                       subjectCode.includes(currentSearchTerm) ||
                       formGrade.includes(currentSearchTerm) ||
                       streams.includes(currentSearchTerm);
            });
            
            renderAssignmentsTable();
            updateSearchResultsCount();
        }
        
        // Update assignments count
        function updateAssignmentsCount() {
            const total = assignedTeachers.length;
            assignmentsCount.textContent = `Total Assignments: ${total}`;
        }
        
        // Update search results count
        function updateSearchResultsCount() {
            if (!currentSearchTerm) {
                searchResultsCount.textContent = '';
                return;
            }
            
            const total = assignedTeachers.length;
            const filtered = filteredAssignments.length;
            
            if (filtered === total) {
                searchResultsCount.textContent = '';
            } else {
                searchResultsCount.textContent = `Showing ${filtered} of ${total} assignments`;
            }
        }
        
        // Update database status indicator
        function updateDatabaseStatus(isConnected, message) {
            if (isConnected) {
                dbStatus.className = 'db-status connected';
                dbStatus.innerHTML = `<i class="fas fa-check-circle"></i><span>${message}</span>`;
            } else {
                dbStatus.className = 'db-status disconnected';
                dbStatus.innerHTML = `<i class="fas fa-times-circle"></i><span>${message}</span>`;
            }
        }
        
        // Show loading status
        function showLoadingStatus(message) {
            dbStatus.className = 'db-status loading';
            dbStatus.innerHTML = `<span class="spinner"></span><span>${message}</span>`;
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Teacher search
            teacherSearch.addEventListener('input', (e) => {
                const searchTerm = e.target.value.trim();
                populateTeacherList(searchTerm);
                
                if (searchTerm) {
                    clearTeacherSearchBtn.style.display = 'block';
                } else {
                    clearTeacherSearchBtn.style.display = 'none';
                    teacherDetails.classList.remove('active');
                }
            });
            
            // Clear teacher search button
            clearTeacherSearchBtn.addEventListener('click', () => {
                teacherSearch.value = '';
                selectedTeacherIdInput.value = '';
                selectedTeacherNameInput.value = '';
                selectedTeacherTscInput.value = '';
                clearTeacherSearchBtn.style.display = 'none';
                teacherList.classList.remove('active');
                teacherDetails.classList.remove('active');
                
                // Clear selection highlights
                document.querySelectorAll('.teacher-option').forEach(option => {
                    option.classList.remove('selected');
                });
                
                checkFormCompletion();
            });
            
            // Subject search
            subjectSearch.addEventListener('input', (e) => {
                const searchTerm = e.target.value.trim();
                populateSubjectList(searchTerm);
                
                if (searchTerm) {
                    clearSubjectSearchBtn.style.display = 'block';
                } else {
                    clearSubjectSearchBtn.style.display = 'none';
                }
                
                checkFormCompletion();
            });
            
            // Clear subject search button
            clearSubjectSearchBtn.addEventListener('click', () => {
                subjectSearch.value = '';
                selectedSubjectInput.value = '';
                selectedSubjectDisplayInput.value = '';
                clearSubjectSearchBtn.style.display = 'none';
                subjectList.classList.remove('active');
                
                // Clear selection highlights
                document.querySelectorAll('.subject-option').forEach(option => {
                    option.classList.remove('selected');
                });
                
                checkFormCompletion();
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.teacher-search-container')) {
                    teacherList.classList.remove('active');
                }
                if (!e.target.closest('.subject-search-container')) {
                    subjectList.classList.remove('active');
                }
            });
            
            // Assignments search
            assignmentsSearch.addEventListener('input', (e) => {
                const searchTerm = e.target.value;
                searchAssignments(searchTerm);
                
                if (searchTerm) {
                    clearAssignmentsSearchBtn.style.display = 'block';
                } else {
                    clearAssignmentsSearchBtn.style.display = 'none';
                }
            });
            
            // Clear assignments search button
            clearAssignmentsSearchBtn.addEventListener('click', () => {
                assignmentsSearch.value = '';
                searchAssignments('');
                clearAssignmentsSearchBtn.style.display = 'none';
            });
            
            // Form grade change
            formGradeSelect.addEventListener('change', checkFormCompletion);
            
            // Add stream button
            addStreamBtn.addEventListener('click', addStreamField);
            
            // Assign teacher button
            assignBtn.addEventListener('click', assignTeacher);
            
            // Clear form button
            clearBtn.addEventListener('click', clearForm);
            
            // Refresh assignments button
            refreshAssignmentsBtn.addEventListener('click', async () => {
                await loadAssignmentsFromDatabase();
            });
            
            // Allow Enter key to add streams
            streamContainer.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.classList.contains('stream-input')) {
                    e.preventDefault();
                    addStreamField();
                    // Focus the new input field
                    const newInputs = streamContainer.querySelectorAll('.stream-input');
                    if (newInputs.length > 0) {
                        newInputs[newInputs.length - 1].focus();
                    }
                }
            });
            
            // Stream input changes
            streamContainer.addEventListener('input', (e) => {
                if (e.target.classList.contains('stream-input')) {
                    checkFormCompletion();
                }
            });
        }
        
        // Add a new stream input field
        function addStreamField() {
            const streamItem = document.createElement('div');
            streamItem.className = 'stream-item';
            streamItem.innerHTML = `
                <input type="text" class="stream-input" placeholder="Enter stream name (e.g., North, South)">
                <button type="button" class="remove-stream-btn" style="background: none; border: none; color: #dc3545; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            streamContainer.appendChild(streamItem);
            
            // Add event listener to remove button
            const removeBtn = streamItem.querySelector('.remove-stream-btn');
            removeBtn.addEventListener('click', () => {
                if (streamContainer.children.length > 1) {
                    streamItem.remove();
                } else {
                    // If it's the last stream, just clear the input
                    streamItem.querySelector('.stream-input').value = '';
                }
                checkFormCompletion();
            });
            
            // Add input listener for form validation
            const input = streamItem.querySelector('.stream-input');
            input.addEventListener('input', checkFormCompletion);
            
            checkFormCompletion();
        }
        
        // Get all stream values
        function getStreamValues() {
            const streamInputs = streamContainer.querySelectorAll('.stream-input');
            const streams = [];
            
            streamInputs.forEach(input => {
                const value = input.value.trim();
                if (value) {
                    streams.push(value);
                }
            });
            
            return streams;
        }
        
        // Assign teacher to subject and form
        async function assignTeacher() {
            // Get form values
            const teacherId = selectedTeacherIdInput.value;
            const teacherName = selectedTeacherNameInput.value;
            const tscNumber = selectedTeacherTscInput.value;
            const subjectCode = selectedSubjectInput.value;
            const subjectDisplay = selectedSubjectDisplayInput.value;
            const formGrade = formGradeSelect.value;
            const streams = getStreamValues();
            
            // Validation
            if (!teacherId) {
                showStatus('Please select a teacher from the database', 'error');
                return;
            }
            
            if (!subjectCode || !formGrade) {
                showStatus('Please fill in all required fields', 'error');
                return;
            }
            
            if (streams.length === 0) {
                showStatus('Please add at least one stream', 'error');
                return;
            }
            
            // Format display values
            const formGradeDisplay = formGrade.split('_').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
            
            // Create new assignment object
            const newAssignment = {
                teacherId: teacherId,
                subjectCode: subjectCode,
                subjectDisplay: subjectDisplay,
                formGrade: formGrade,
                formGradeDisplay: formGradeDisplay,
                streams: streams
            };
            
            try {
                // Save to database
                const savedAssignment = await saveAssignmentToDatabase(newAssignment);
                
                if (savedAssignment) {
                    // Add to local array
                    assignedTeachers.unshift(savedAssignment);
                    
                    // Update the table
                    renderAssignmentsTable();
                    
                    // Update search if active
                    if (currentSearchTerm) {
                        searchAssignments(currentSearchTerm);
                    }
                    
                    // Show success message
                    showStatus(`Teacher ${teacherName} has been assigned to ${subjectDisplay} for ${formGradeDisplay}`, 'success');
                    
                    // Clear the form
                    clearForm();
                    
                    // Update counts
                    updateAssignmentsCount();
                }
                
            } catch (error) {
                console.error('Error assigning teacher:', error);
                showStatus(`Failed to assign teacher: ${error.message}`, 'error');
            }
        }
        
        // Clear the form
        function clearForm() {
            teacherSearch.value = '';
            selectedTeacherIdInput.value = '';
            selectedTeacherNameInput.value = '';
            selectedTeacherTscInput.value = '';
            clearTeacherSearchBtn.style.display = 'none';
            teacherList.classList.remove('active');
            teacherDetails.classList.remove('active');
            
            subjectSearch.value = '';
            selectedSubjectInput.value = '';
            selectedSubjectDisplayInput.value = '';
            clearSubjectSearchBtn.style.display = 'none';
            subjectList.classList.remove('active');
            
            formGradeSelect.value = '';
            
            // Clear streams but keep one empty field
            streamContainer.innerHTML = `
                <div class="stream-item">
                    <input type="text" class="stream-input" placeholder="Enter stream name (e.g., North, South)">
                </div>
            `;
            
            // Clear selection highlights
            document.querySelectorAll('.teacher-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            document.querySelectorAll('.subject-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Disable assign button
            assignBtn.disabled = true;
            
            // Focus on teacher search
            teacherSearch.focus();
        }
        
        // Render assignments table
        function renderAssignmentsTable() {
            const assignmentsToRender = currentSearchTerm ? filteredAssignments : assignedTeachers;
            
            if (assignmentsToRender.length === 0) {
                let message = 'No teachers assigned yet. Use the form above to assign teachers.';
                if (currentSearchTerm && assignedTeachers.length > 0) {
                    message = `No assignments found for "${currentSearchTerm}". Try a different search term.`;
                }
                
                noResultsMessage.textContent = message;
                noResultsMessage.style.display = 'table-cell';
                assignmentsBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="no-results">
                            ${message}
                        </td>
                    </tr>
                `;
                return;
            }
            
            noResultsMessage.style.display = 'none';
            assignmentsBody.innerHTML = '';
            
            assignmentsToRender.forEach((assignment, index) => {
                const row = document.createElement('tr');
                
                // Check if this row matches the search
                const shouldHighlight = currentSearchTerm && (
                    (assignment.teacher?.full_name?.toLowerCase() || '').includes(currentSearchTerm) ||
                    (assignment.teacher?.tsc_number?.toLowerCase() || '').includes(currentSearchTerm) ||
                    (assignment.subject_display?.toLowerCase() || '').includes(currentSearchTerm) ||
                    (assignment.subject_code?.toLowerCase() || '').includes(currentSearchTerm) ||
                    (assignment.form_grade_display?.toLowerCase() || '').includes(currentSearchTerm)
                );
                
                if (shouldHighlight) {
                    row.classList.add('search-highlight');
                }
                
                // Create streams HTML
                let streamsHTML = '<div class="stream-list">';
                const streams = assignment.streams || [];
                streams.forEach(stream => {
                    // Highlight streams if they match search
                    const streamLower = stream.toLowerCase();
                    const displayStream = currentSearchTerm && streamLower.includes(currentSearchTerm) 
                        ? `<span class="highlight">${stream}</span>`
                        : stream;
                    
                    streamsHTML += `<span class="stream-tag">${displayStream}</span>`;
                });
                streamsHTML += '</div>';
                
                // Highlight text in table cells if searching
                const highlightText = (text) => {
                    if (!currentSearchTerm || !text || !text.toLowerCase().includes(currentSearchTerm)) {
                        return text || 'N/A';
                    }
                    
                    const regex = new RegExp(`(${currentSearchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                    return text.replace(regex, '<span class="highlight">$1</span>');
                };
                
                row.innerHTML = `
                    <td>${highlightText(assignment.teacher?.full_name)}</td>
                    <td>${highlightText(assignment.teacher?.tsc_number)}</td>
                    <td>${highlightText(assignment.subject_display)} (${assignment.subject_code})</td>
                    <td>${highlightText(assignment.form_grade_display)}</td>
                    <td>${streamsHTML}</td>
                `;
                
                assignmentsBody.appendChild(row);
            });
        }
        
        // Show status message
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`;
            statusMessage.style.display = 'block';
            
            // Hide after 5 seconds
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }
        
        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>