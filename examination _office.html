<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combined Results - Alliance Girls High School</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-green: #075824;
            --secondary-green: #377437;
            --accent-green: #9BAE30;
            --muted-green: #5D8B70;
            --accent-blue: #333687;
            --background-light: #F4F4F4;
            --text-light: #FFFFFF;
            --sidebar-width: 280px;
            --card-shadow: 0 5px 20px rgba(0,0,0,0.08);
            --hover-shadow: 0 15px 30px rgba(0,0,0,0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-light);
            color: #333;
            min-height: 100vh;
            display: flex;
            overflow-x: hidden;
        }

        /* Top Header with User Profile */
        .top-header {
            position: fixed;
            top: 0;
            right: 0;
            left: var(--sidebar-width);
            background-color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            z-index: 999;
            transition: left 0.3s ease;
        }

        .page-title h1 {
            color: var(--primary-green);
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .page-title p {
            color: var(--muted-green);
            font-size: 0.9rem;
        }

        .user-profile-top {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 8px 15px;
            background-color: rgba(7, 88, 36, 0.05);
            border-radius: 50px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .user-profile-top:hover {
            background-color: rgba(7, 88, 36, 0.1);
        }

        .user-avatar-top {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-green), var(--accent-green));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            overflow: hidden;
            position: relative;
            border: 3px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        .user-avatar-top img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-info-top h4 {
            color: var(--primary-green);
            font-size: 0.95rem;
            margin-bottom: 2px;
        }

        .user-info-top p {
            color: var(--muted-green);
            font-size: 0.8rem;
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 30px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            padding: 15px;
            min-width: 200px;
            display: none;
            z-index: 1001;
        }

        .user-dropdown.show {
            display: block;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            color: #555;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .dropdown-item:hover {
            background-color: rgba(7, 88, 36, 0.05);
            color: var(--primary-green);
        }

        .dropdown-item i {
            margin-right: 10px;
            width: 20px;
        }

        /* Sidebar Header */
        .sidebar-header {
            background-color: var(--primary-green);
            color: var(--text-light);
            padding: 25px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .badge-container {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-color: white;
            border: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
            margin: 0 auto 15px;
        }

        .school-badge {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 8px;
        }

        .badge-fallback {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-green);
            color: white;
            font-size: 28px;
        }

        .sidebar-title h1 {
            font-size: 1.8rem;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .sidebar-title h2 {
            font-size: 1rem;
            font-weight: 400;
            opacity: 0.9;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: var(--sidebar-width);
            background-color: white;
            box-shadow: 3px 0 15px rgba(0, 0, 0, 0.08);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1000;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .sidebar-nav {
            list-style: none;
            padding: 0;
        }

        .nav-section-title {
            padding: 20px 25px 10px;
            font-size: 0.85rem;
            color: var(--muted-green);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            border-bottom: 1px solid #eee;
            margin: 0 15px;
        }

        .nav-item {
            margin-bottom: 3px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 16px 25px;
            color: #555;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            position: relative;
        }

        .nav-link:hover {
            background-color: rgba(7, 88, 36, 0.05);
            color: var(--primary-green);
            border-left-color: var(--accent-green);
        }

        .nav-link.active {
            background-color: rgba(7, 88, 36, 0.1);
            color: var(--primary-green);
            font-weight: 600;
            border-left-color: var(--primary-green);
        }

        .nav-link i {
            margin-right: 15px;
            width: 22px;
            text-align: center;
            font-size: 1.2rem;
        }

        /* Main content area */
        .main-content {
            flex: 1;
            padding: 100px 40px 40px;
            margin-left: var(--sidebar-width);
            display: flex;
            flex-direction: column;
            transition: margin-left 0.3s ease;
            width: calc(100% - var(--sidebar-width));
        }

        /* Data display sections */
        .data-section {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto 40px;
        }

        .section-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(7, 88, 36, 0.1);
        }

        .section-title h2 {
            color: var(--primary-green);
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title h2 i {
            color: var(--accent-green);
        }

        .section-info {
            color: var(--muted-green);
            font-size: 1rem;
        }

        /* Form Controls */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--primary-green);
            font-weight: 600;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px rgba(155, 174, 48, 0.1);
        }

        /* Action Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-green);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-green);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(7, 88, 36, 0.2);
        }

        .btn-secondary {
            background-color: var(--accent-blue);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #2a2c6e;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(51, 54, 135, 0.2);
        }

        .btn-outline {
            background-color: transparent;
            color: var(--primary-green);
            border: 2px solid var(--primary-green);
        }

        .btn-outline:hover {
            background-color: rgba(7, 88, 36, 0.05);
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.9rem;
        }

        /* Hamburger menu for mobile */
        .hamburger {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1100;
            background-color: var(--primary-green);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 30px 20px;
            color: var(--muted-green);
            font-size: 0.9rem;
            margin-top: 60px;
            width: 100%;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            background: white;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .footer p {
            max-width: 800px;
            width: 100%;
            text-align: center;
            line-height: 1.5;
            margin: 0 auto 15px;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
            flex-wrap: wrap;
            max-width: 800px;
            width: 100%;
        }

        /* Excel-like Spreadsheet Styles */
        .excel-container {
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .excel-toolbar {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .excel-search {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .excel-search input {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            width: 250px;
        }

        .excel-stats {
            display: flex;
            gap: 20px;
            color: var(--muted-green);
            font-size: 0.9rem;
        }

        .excel-table-container {
            overflow-x: auto;
            max-height: 600px;
            border: 1px solid #dee2e6;
        }

        .excel-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        .excel-table th {
            background-color: var(--primary-green);
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            border: 1px solid rgba(255, 255, 255, 0.2);
            user-select: none;
        }

        .excel-table td {
            padding: 10px 15px;
            border: 1px solid #dee2e6;
            transition: background-color 0.2s;
        }

        .excel-table tr:hover td {
            background-color: rgba(7, 88, 36, 0.05);
        }

        .excel-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .excel-table .header-cell {
            position: relative;
            cursor: pointer;
        }

        .excel-table .header-cell:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .excel-table .sort-icon {
            margin-left: 5px;
            opacity: 0.7;
        }

        .cell-editable {
            cursor: pointer;
            position: relative;
        }

        .cell-editable:hover {
            background-color: rgba(155, 174, 48, 0.1);
        }

        .cell-editing {
            background-color: #fffde7;
            border: 2px solid var(--accent-green) !important;
        }

        .cell-input {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            font: inherit;
            padding: 2px;
            outline: none;
        }

        .excel-pagination {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-info {
            color: var(--muted-green);
            font-size: 0.9rem;
        }

        .page-btn {
            width: 35px;
            height: 35px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .page-btn:hover:not(:disabled) {
            background-color: var(--primary-green);
            color: white;
            border-color: var(--primary-green);
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .excel-filters {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 0.9rem;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px;
            background: white;
            border-radius: 12px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(7, 88, 36, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-green);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* No Data Message */
        .no-data {
            text-align: center;
            padding: 60px 30px;
            background: white;
            border-radius: 12px;
        }

        .no-data i {
            font-size: 4rem;
            color: var(--muted-green);
            opacity: 0.3;
            margin-bottom: 20px;
        }

        .no-data h3 {
            color: var(--primary-green);
            margin-bottom: 15px;
        }

        .no-data p {
            max-width: 500px;
            margin: 0 auto;
            color: #666;
        }

        /* Setup Database Message */
        .setup-database {
            text-align: center;
            padding: 60px 30px;
            background: white;
            border-radius: 12px;
        }

        .setup-database i {
            font-size: 4rem;
            color: var(--muted-green);
            opacity: 0.3;
            margin-bottom: 20px;
        }

        .setup-database h3 {
            color: var(--primary-green);
            margin-bottom: 15px;
        }

        .setup-database p {
            max-width: 600px;
            margin: 0 auto 25px;
            color: #666;
            line-height: 1.6;
        }

        /* Compute Results Button */
        .compute-results-btn {
            background: linear-gradient(135deg, var(--accent-blue), #4a4fc1);
            color: white;
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 20px auto;
            box-shadow: 0 5px 15px rgba(51, 54, 135, 0.2);
        }

        .compute-results-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(51, 54, 135, 0.3);
            background: linear-gradient(135deg, #2a2c6e, #3d42a8);
        }

        .compute-results-btn i {
            font-size: 1.3rem;
        }

        /* Analytics Cards */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .analytics-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s ease;
        }

        .analytics-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }

        .analytics-card h3 {
            color: var(--primary-green);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
        }

        .analytics-card h3 i {
            color: var(--accent-green);
        }

        .chart-container {
            height: 250px;
            width: 100%;
            position: relative;
        }

        .rank-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .rank-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }

        .rank-item:hover {
            background-color: rgba(7, 88, 36, 0.05);
        }

        .rank-position {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: var(--primary-green);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .rank-position.top-3 {
            background-color: var(--accent-green);
        }

        .rank-info {
            flex: 1;
        }

        .rank-info h4 {
            color: var(--primary-green);
            margin-bottom: 3px;
        }

        .rank-info p {
            color: var(--muted-green);
            font-size: 0.9rem;
        }

        .rank-score {
            font-weight: bold;
            color: var(--accent-blue);
            font-size: 1.1rem;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #666;
            font-size: 0.95rem;
        }

        .stat-value {
            font-weight: bold;
            color: var(--primary-green);
            font-size: 1.1rem;
        }

        .stat-change {
            font-size: 0.85rem;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 10px;
        }

        .stat-change.positive {
            background-color: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }

        .stat-change.negative {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }

        /* Tabs */
        .tabs-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
        }

        .tabs-header {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 0 20px;
        }

        .tab-btn {
            padding: 18px 25px;
            background: none;
            border: none;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            color: var(--primary-green);
        }

        .tab-btn.active {
            color: var(--primary-green);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background-color: var(--primary-green);
        }

        .tab-content {
            padding: 30px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Advanced Analytics */
        .insight-card {
            background: linear-gradient(135deg, rgba(7, 88, 36, 0.05), rgba(155, 174, 48, 0.05));
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 5px solid var(--primary-green);
        }

        .insight-card h4 {
            color: var(--primary-green);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .insight-card p {
            color: #666;
            line-height: 1.6;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .metric-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-green);
            margin-bottom: 5px;
        }

        .metric-label {
            color: var(--muted-green);
            font-size: 0.9rem;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 100px 20px 40px;
                width: 100%;
            }

            .top-header {
                left: 0;
            }

            .hamburger {
                display: flex;
            }
            
            .excel-toolbar, .excel-pagination {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                max-width: 320px;
            }

            .top-header {
                padding: 15px 20px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .user-profile-top {
                align-self: flex-end;
                margin-top: 10px;
            }

            .excel-search input {
                width: 200px;
            }

            .tabs-header {
                flex-direction: column;
                padding: 0;
            }

            .tab-btn {
                padding: 15px 20px;
                text-align: left;
                border-bottom: 1px solid #dee2e6;
            }

            .tab-btn.active::after {
                height: 100%;
                width: 3px;
                bottom: auto;
                left: 0;
                top: 0;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 120px 15px 30px;
            }

            .user-info-top {
                display: none;
            }
            
            .excel-stats {
                flex-direction: column;
                gap: 5px;
            }
            
            .excel-filters {
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
            }
            
            .filter-select {
                width: 100%;
            }

            .metric-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Hamburger Menu for Mobile -->
    <div class="hamburger" id="hamburger">
        <i class="fas fa-bars"></i>
    </div>

    <!-- Top Header with User Profile -->
    <div class="top-header" id="topHeader">
        <div class="page-title">
            <h1 id="pageTitle">Combined Results</h1>
            <p id="pageSubtitle">Examination Office - Alliance Girls High School</p>
        </div>
        
        <div class="user-profile-top" id="userProfileTop">
            <div class="user-avatar-top" id="userAvatar">
                EX
            </div>
            <div class="user-info-top">
                <h4 id="userName">Examination Officer</h4>
                <p id="userRole">Examination Office</p>
            </div>
            <i class="fas fa-chevron-down" id="dropdownArrow"></i>
        </div>
        
        <!-- User Dropdown Menu -->
        <div class="user-dropdown" id="userDropdown">
            <a href="#" class="dropdown-item" onclick="navigateTo('dashboard')">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a href="#" class="dropdown-item" onclick="navigateTo('analytics')">
                <i class="fas fa-chart-bar"></i> Analytics
            </a>
            <a href="#" class="dropdown-item">
                <i class="fas fa-user-edit"></i> Edit Profile
            </a>
            <a href="#" class="dropdown-item">
                <i class="fas fa-cog"></i> Settings
            </a>
            <a href="#" class="dropdown-item">
                <i class="fas fa-question-circle"></i> Help & Support
            </a>
            <div style="height: 1px; background-color: #eee; margin: 10px 0;"></div>
            <a href="#" class="dropdown-item" id="logoutLink">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </div>

    <!-- Left Navigation Pane -->
    <div class="sidebar" id="sidebar">
        <!-- Sidebar Header -->
        <div class="sidebar-header">
            <div class="badge-container">
                <div class="badge-fallback">
                    <i class="fas fa-graduation-cap"></i>
                </div>
            </div>
            <div class="sidebar-title">
                <h1>Examination Office</h1>
                <h2>Full Control Panel</h2>
            </div>
        </div>

        <!-- Navigation Menu -->
        <ul class="sidebar-nav">
            <li class="nav-section-title">Exam Management</li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="navigateTo('dashboard')">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="navigateTo('subjectManagement')">
                    <i class="fas fa-book"></i> Subject Management
                </a>
            </li>
            
            <li class="nav-section-title">Reporting & Analytics</li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="navigateTo('generateReports')">
                    <i class="fas fa-file-alt"></i> Generate Report Cards
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link active">
                    <i class="fas fa-cogs"></i> Combined Results
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="navigateTo('analytics')">
                    <i class="fas fa-chart-bar"></i> Analytics & Insights
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="navigateTo('emailParents')">
                    <i class="fas fa-envelope"></i> Email Parents
                </a>
            </li>
            
            <li class="nav-section-title">Administration</li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="navigateTo('settings')">
                    <i class="fas fa-cog"></i> System Settings
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" onclick="navigateTo('help')">
                    <i class="fas fa-question-circle"></i> Help Center
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link logout-sidebar">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </li>
        </ul>
    </div>

    <!-- Main Content Area -->
    <div class="main-content" id="mainContent">
        <div class="data-section">
            <div class="section-title">
                <h2><i class="fas fa-cogs"></i> Combine & Compute Examination Results</h2>
                <div class="section-info">View, combine, and analyze student performance data from all forms</div>
            </div>

            <!-- Compute Results Button -->
            <button class="compute-results-btn" id="computeResultsBtn">
                <i class="fas fa-brain"></i> Compute Results & Generate Analytics
            </button>

            <!-- Tabs Container -->
            <div class="tabs-container">
                <div class="tabs-header">
                    <button class="tab-btn active" data-tab="data-view">Data View</button>
                    <button class="tab-btn" data-tab="analytics">Analytics</button>
                    <button class="tab-btn" data-tab="rankings">Rankings</button>
                    <button class="tab-btn" data-tab="insights">Insights</button>
                </div>

                <!-- Data View Tab -->
                <div class="tab-content active" id="data-view">
                    <!-- Filter Controls -->
                    <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: var(--card-shadow); margin-bottom: 30px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div class="form-group">
                                <label>Form/Grade</label>
                                <select id="filterForm" class="filter-select">
                                    <option value="">All Forms</option>
                                    <option value="Form_3">Form_3</option>
                                    <option value="Form 4">Form 4</option>
                                    <option value="Grade 10">Grade 10</option>
                                    <option value="Grade 11">Grade 11</option>
                                    <option value="Grade 12">Grade 12</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Stream</label>
                                <select id="filterStream" class="filter-select">
                                    <option value="">All Streams</option>
                                    <option value="North">North</option>
                                    <option value="South">South</option>
                                    <option value="East">East</option>
                                    <option value="West">West</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Subject</label>
                                <select id="filterSubject" class="filter-select">
                                    <option value="">All Subjects</option>
                                    <!-- Options will be loaded dynamically -->
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Exam Type</label>
                                <select id="filterExamType" class="filter-select">
                                    <option value="">All Exam Types</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-top: 20px;">
                            <button class="btn btn-primary" id="applyFilters">
                                <i class="fas fa-filter"></i> Apply Filters
                            </button>
                            <button class="btn btn-outline" id="clearFilters">
                                <i class="fas fa-times"></i> Clear Filters
                            </button>
                            <button class="btn btn-secondary" id="fetchData">
                                <i class="fas fa-sync-alt"></i> Refresh Data
                            </button>
                        </div>
                    </div>

                    <!-- Excel-like Spreadsheet -->
                    <div class="excel-container" id="excelContainer">
                        <!-- Toolbar -->
                        <div class="excel-toolbar">
                            <div class="excel-search">
                                <input type="text" id="searchInput" placeholder="Search in all columns...">
                                <button class="btn btn-sm btn-outline" id="searchBtn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            
                            <div class="excel-stats">
                                <span id="rowCount">Loading...</span>
                                <span id="filteredCount"></span>
                            </div>
                            
                            <div class="excel-filters">
                                <select id="sortColumn" class="filter-select">
                                    <option value="">Sort by...</option>
                                </select>
                                <select id="sortDirection" class="filter-select">
                                    <option value="asc">Ascending</option>
                                    <option value="desc">Descending</option>
                                </select>
                            </div>
                        </div>

                        <!-- Loading State -->
                        <div class="loading-spinner" id="loadingSpinner">
                            <div class="spinner"></div>
                            <div style="margin-left: 15px; color: var(--primary-green);">Loading student performance data...</div>
                        </div>

                        <!-- No Data State -->
                        <div class="no-data" id="noDataMessage" style="display: none;">
                            <i class="fas fa-database"></i>
                            <h3>No Performance Data Found</h3>
                            <p>No student performance records found in the database. Please ensure marks have been submitted.</p>
                            <button class="btn btn-primary" onclick="fetchStudentPerformance()" style="margin-top: 20px;">
                                <i class="fas fa-sync-alt"></i> Try Again
                            </button>
                        </div>

                        <!-- Setup Database Message -->
                        <div class="setup-database" id="setupDatabaseMessage" style="display: none;">
                            <i class="fas fa-tools"></i>
                            <h3>Database Table Not Found</h3>
                            <p>The <code>student_performance</code> table doesn't exist in your database. Click the button below to create the table automatically.</p>
                            <p style="font-size: 0.9rem; color: var(--muted-green); margin-bottom: 25px;">
                                The table will be created with the correct structure for storing student performance data.
                            </p>
                            <button class="btn btn-primary" id="createTableBtn" style="margin-top: 20px;">
                                <i class="fas fa-plus-circle"></i> Create Performance Table
                            </button>
                            <button class="btn btn-outline" onclick="checkTableExists()" style="margin-top: 10px;">
                                <i class="fas fa-redo"></i> Check Again
                            </button>
                        </div>

                        <!-- Excel Table -->
                        <div class="excel-table-container" id="tableContainer" style="display: none;">
                            <table class="excel-table" id="excelTable">
                                <thead id="tableHeader">
                                    <!-- Header will be populated by JavaScript -->
                                </thead>
                                <tbody id="tableBody">
                                    <!-- Data will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <div class="excel-pagination" id="paginationContainer" style="display: none;">
                            <div class="pagination-controls">
                                <button class="page-btn" id="firstPage">
                                    <i class="fas fa-angle-double-left"></i>
                                </button>
                                <button class="page-btn" id="prevPage">
                                    <i class="fas fa-angle-left"></i>
                                </button>
                                <span class="page-info" id="pageInfo">Page 1 of 1</span>
                                <button class="page-btn" id="nextPage">
                                    <i class="fas fa-angle-right"></i>
                                </button>
                                <button class="page-btn" id="lastPage">
                                    <i class="fas fa-angle-double-right"></i>
                                </button>
                            </div>
                            
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="color: var(--muted-green); font-size: 0.9rem;">Rows per page:</span>
                                <select id="rowsPerPage" class="filter-select">
                                    <option value="20">20</option>
                                    <option value="50" selected>50</option>
                                    <option value="100">100</option>
                                    <option value="200">200</option>
                                    <option value="500">500</option>
                                </select>
                                
                                <button class="btn btn-success" id="exportCsv">
                                    <i class="fas fa-file-csv"></i> Export to CSV
                                </button>
                                <button class="btn btn-primary" id="exportSummary">
                                    <i class="fas fa-chart-bar"></i> Export Summary
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Data Summary -->
                    <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: var(--card-shadow); margin-bottom: 40px;">
                        <h3 style="color: var(--primary-green); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-chart-bar"></i> Data Summary
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                            <div style="text-align: center; padding: 20px; background: rgba(7, 88, 36, 0.05); border-radius: 8px;">
                                <div style="font-size: 2.5rem; color: var(--primary-green); font-weight: bold;" id="totalStudents">0</div>
                                <div style="color: var(--muted-green); margin-top: 5px;">Total Students</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(7, 88, 36, 0.05); border-radius: 8px;">
                                <div style="font-size: 2.5rem; color: var(--primary-green); font-weight: bold;" id="totalSubjects">0</div>
                                <div style="color: var(--muted-green); margin-top: 5px;">Subjects</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(7, 88, 36, 0.05); border-radius: 8px;">
                                <div style="font-size: 2.5rem; color: var(--primary-green); font-weight: bold;" id="avgScore">0%</div>
                                <div style="color: var(--muted-green); margin-top: 5px;">Avg Percentage</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(7, 88, 36, 0.05); border-radius: 8px;">
                                <div style="font-size: 2.5rem; color: var(--primary-green); font-weight: bold;" id="dataUpdated">-</div>
                                <div style="color: var(--muted-green); margin-top: 5px;">Last Updated</div>
                            </div>
                        </div>
                        
                        <!-- Grade Distribution -->
                        <div style="margin-top: 30px;">
                            <h4 style="color: var(--secondary-green); margin-bottom: 15px;">Grade Distribution</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                                <div style="text-align: center; padding: 15px; background: rgba(220, 53, 69, 0.1); border-radius: 8px;">
                                    <div style="font-size: 1.8rem; color: #dc3545; font-weight: bold;" id="gradeA">0</div>
                                    <div style="color: #666; margin-top: 5px;">Grade A</div>
                                </div>
                                <div style="text-align: center; padding: 15px; background: rgba(255, 193, 7, 0.1); border-radius: 8px;">
                                    <div style="font-size: 1.8rem; color: #ffc107; font-weight: bold;" id="gradeB">0</div>
                                    <div style="color: #666; margin-top: 5px;">Grade B</div>
                                </div>
                                <div style="text-align: center; padding: 15px; background: rgba(40, 167, 69, 0.1); border-radius: 8px;">
                                    <div style="font-size: 1.8rem; color: #28a745; font-weight: bold;" id="gradeC">0</div>
                                    <div style="color: #666; margin-top: 5px;">Grade C</div>
                                </div>
                                <div style="text-align: center; padding: 15px; background: rgba(108, 117, 125, 0.1); border-radius: 8px;">
                                    <div style="font-size: 1.8rem; color: #6c757d; font-weight: bold;" id="gradeD">0</div>
                                    <div style="color: #666; margin-top: 5px;">Grade D</div>
                                </div>
                                <div style="text-align: center; padding: 15px; background: rgba(23, 162, 184, 0.1); border-radius: 8px;">
                                    <div style="font-size: 1.8rem; color: #17a2b8; font-weight: bold;" id="gradeE">0</div>
                                    <div style="color: #666; margin-top: 5px;">Grade E</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Tab -->
                <div class="tab-content" id="analytics">
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <h3><i class="fas fa-chart-line"></i> Overall Performance</h3>
                            <div class="chart-container">
                                <canvas id="performanceChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="analytics-card">
                            <h3><i class="fas fa-balance-scale"></i> Subject Comparison</h3>
                            <div class="chart-container">
                                <canvas id="subjectChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="analytics-card">
                            <h3><i class="fas fa-users"></i> Stream Performance</h3>
                            <div class="chart-container">
                                <canvas id="streamChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="analytics-card">
                            <h3><i class="fas fa-chart-pie"></i> Grade Distribution</h3>
                            <div class="chart-container">
                                <canvas id="gradeChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics Cards -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px;">
                        <div class="analytics-card">
                            <h3><i class="fas fa-trophy"></i> Top Performers</h3>
                            <div class="stat-item">
                                <span class="stat-label">Best Student</span>
                                <span class="stat-value" id="bestStudent">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Best Subject</span>
                                <span class="stat-value" id="bestSubject">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Best Stream</span>
                                <span class="stat-value" id="bestStream">-</span>
                            </div>
                        </div>
                        
                        <div class="analytics-card">
                            <h3><i class="fas fa-chart-bar"></i> Performance Metrics</h3>
                            <div class="stat-item">
                                <span class="stat-label">Mean Score</span>
                                <span class="stat-value" id="meanScore">0%</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Median Score</span>
                                <span class="stat-value" id="medianScore">0%</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Standard Deviation</span>
                                <span class="stat-value" id="stdDev">0</span>
                            </div>
                        </div>
                        
                        <div class="analytics-card">
                            <h3><i class="fas fa-calendar-alt"></i> Exam Analysis</h3>
                            <div class="stat-item">
                                <span class="stat-label">Best Exam Type</span>
                                <span class="stat-value" id="bestExamType">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Total Exams</span>
                                <span class="stat-value" id="totalExams">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Pass Rate</span>
                                <span class="stat-value" id="passRate">0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rankings Tab -->
                <div class="tab-content" id="rankings">
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <h3><i class="fas fa-crown"></i> Overall Rankings</h3>
                            <div class="rank-list" id="overallRankings">
                                <!-- Rankings will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <div class="analytics-card">
                            <h3><i class="fas fa-book"></i> Subject Rankings</h3>
                            <div class="rank-list" id="subjectRankings">
                                <!-- Subject rankings will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <div class="analytics-card">
                            <h3><i class="fas fa-users"></i> Stream Rankings</h3>
                            <div class="rank-list" id="streamRankings">
                                <!-- Stream rankings will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <div class="analytics-card">
                            <h3><i class="fas fa-graduation-cap"></i> Form Rankings</h3>
                            <div class="rank-list" id="formRankings">
                                <!-- Form rankings will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Insights Tab -->
                <div class="tab-content" id="insights">
                    <div class="insight-card">
                        <h4><i class="fas fa-lightbulb"></i> Key Insights</h4>
                        <div id="keyInsights">
                            <!-- Insights will be generated dynamically -->
                        </div>
                    </div>
                    
                    <div class="insight-card">
                        <h4><i class="fas fa-exclamation-triangle"></i> Areas Needing Improvement</h4>
                        <div id="improvementAreas">
                            <!-- Improvement areas will be generated dynamically -->
                        </div>
                    </div>
                    
                    <div class="insight-card">
                        <h4><i class="fas fa-chart-line"></i> Performance Trends</h4>
                        <div id="performanceTrends">
                            <!-- Trends will be generated dynamically -->
                        </div>
                    </div>
                    
                    <div class="metric-grid" style="margin-top: 30px;">
                        <div class="metric-item">
                            <div class="metric-value" id="avgFormScore">0%</div>
                            <div class="metric-label">Avg Form Score</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value" id="improvementRate">0%</div>
                            <div class="metric-label">Improvement Rate</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value" id="consistencyScore">0</div>
                            <div class="metric-label">Consistency Score</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-value" id="excellenceRate">0%</div>
                            <div class="metric-label">Excellence Rate</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="footer">
                <p> 2026 Alliance Girls High School - Examination Office. All rights reserved.</p>
                <div class="footer-links">
                    <a href="#">Privacy Policy</a>
                    <a href="#">Terms of Service</a>
                    <a href="#">Help Center</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Combine Results Page
        (function() {
            // Prevent multiple initializations
            if (window.combineResultsInitialized) return;
            window.combineResultsInitialized = true;
            
            console.log('Initializing Enhanced Combine Results Page...');
            
            // Initialize Supabase client
            let supabase;
            let currentUser = null;
            let studentPerformanceData = [];
            let filteredData = [];
            let columns = [];
            let currentPage = 1;
            let rowsPerPage = 50;
            let totalPages = 1;
            let sortConfig = { column: '', direction: 'asc' };
            
            // Analytics data
            let analyticsData = {
                overallPerformance: {},
                subjectPerformance: {},
                streamPerformance: {},
                rankings: {},
                insights: {},
                trends: {}
            };
            
            // Chart instances
            let performanceChart = null;
            let subjectChart = null;
            let streamChart = null;
            let gradeChart = null;
            
            try {
                const supabaseUrl = 'https://eloqizcahwxavsbalxii.supabase.co';
                const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVsb3FpemNhaHd4YXZzYmFseGlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTQ4OTUsImV4cCI6MjA4MzI5MDg5NX0.SGogIbdShzCLv2TovpdS1BDf6GJx4mu0iz9s25BGRRQ';
                
                supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
                console.log('Supabase client initialized for Combine Results');
            } catch (error) {
                console.error('Failed to initialize Supabase:', error);
                alert('Failed to initialize application. Please refresh the page.');
                return;
            }

            // DOM Elements
            const hamburger = document.getElementById('hamburger');
            const sidebar = document.getElementById('sidebar');
            const userProfileTop = document.getElementById('userProfileTop');
            const userDropdown = document.getElementById('userDropdown');
            const dropdownArrow = document.getElementById('dropdownArrow');
            const logoutLink = document.getElementById('logoutLink');
            const logoutSidebarLinks = document.querySelectorAll('.logout-sidebar');
            
            // Filter elements
            const filterForm = document.getElementById('filterForm');
            const filterStream = document.getElementById('filterStream');
            const filterSubject = document.getElementById('filterSubject');
            const filterExamType = document.getElementById('filterExamType');
            const applyFilters = document.getElementById('applyFilters');
            const clearFilters = document.getElementById('clearFilters');
            const fetchData = document.getElementById('fetchData');
            
            // Compute results button
            const computeResultsBtn = document.getElementById('computeResultsBtn');
            
            // Tab elements
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            // Excel spreadsheet elements
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            const rowCount = document.getElementById('rowCount');
            const filteredCount = document.getElementById('filteredCount');
            const sortColumn = document.getElementById('sortColumn');
            const sortDirection = document.getElementById('sortDirection');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const noDataMessage = document.getElementById('noDataMessage');
            const setupDatabaseMessage = document.getElementById('setupDatabaseMessage');
            const createTableBtn = document.getElementById('createTableBtn');
            const tableContainer = document.getElementById('tableContainer');
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');
            const paginationContainer = document.getElementById('paginationContainer');
            const firstPage = document.getElementById('firstPage');
            const prevPage = document.getElementById('prevPage');
            const nextPage = document.getElementById('nextPage');
            const lastPage = document.getElementById('lastPage');
            const pageInfo = document.getElementById('pageInfo');
            const rowsPerPageSelect = document.getElementById('rowsPerPage');
            const exportCsv = document.getElementById('exportCsv');
            const exportSummary = document.getElementById('exportSummary');
            
            // Summary elements
            const totalStudents = document.getElementById('totalStudents');
            const totalSubjects = document.getElementById('totalSubjects');
            const avgScore = document.getElementById('avgScore');
            const dataUpdated = document.getElementById('dataUpdated');
            const gradeA = document.getElementById('gradeA');
            const gradeB = document.getElementById('gradeB');
            const gradeC = document.getElementById('gradeC');
            const gradeD = document.getElementById('gradeD');
            const gradeE = document.getElementById('gradeE');
            
            // Analytics elements
            const bestStudent = document.getElementById('bestStudent');
            const bestSubject = document.getElementById('bestSubject');
            const bestStream = document.getElementById('bestStream');
            const meanScore = document.getElementById('meanScore');
            const medianScore = document.getElementById('medianScore');
            const stdDev = document.getElementById('stdDev');
            const bestExamType = document.getElementById('bestExamType');
            const totalExams = document.getElementById('totalExams');
            const passRate = document.getElementById('passRate');
            
            // Rankings elements
            const overallRankings = document.getElementById('overallRankings');
            const subjectRankings = document.getElementById('subjectRankings');
            const streamRankings = document.getElementById('streamRankings');
            const formRankings = document.getElementById('formRankings');
            
            // Insights elements
            const keyInsights = document.getElementById('keyInsights');
            const improvementAreas = document.getElementById('improvementAreas');
            const performanceTrends = document.getElementById('performanceTrends');
            const avgFormScore = document.getElementById('avgFormScore');
            const improvementRate = document.getElementById('improvementRate');
            const consistencyScore = document.getElementById('consistencyScore');
            const excellenceRate = document.getElementById('excellenceRate');

            // Navigation function to prevent routing errors
            function navigateTo(page) {
                switch(page) {
                    case 'dashboard':
                        // If dashboard.html doesn't exist, show dashboard content inline
                        showDashboardContent();
                        break;
                    case 'subjectManagement':
                        // If subject_management.html doesn't exist, redirect to combined results
                        window.location.href = 'combined_results.html';
                        break;
                    case 'generateReports':
                        // Show report generation interface
                        showReportGeneration();
                        break;
                    case 'analytics':
                        // Switch to analytics tab
                        switchTab('analytics');
                        break;
                    case 'emailParents':
                        // Show email interface
                        showEmailInterface();
                        break;
                    case 'settings':
                        // Show settings interface
                        showSettings();
                        break;
                    case 'help':
                        // Show help content
                        showHelp();
                        break;
                    default:
                        console.log(`Navigation to ${page} requested`);
                }
            }

            // Function to show dashboard content
            function showDashboardContent() {
                alert('Dashboard functionality would be displayed here. For now, you can use the Combined Results page.');
                // You could also dynamically load dashboard content
            }

            // Function to switch tabs
            function switchTab(tabName) {
                // Update active tab button
                tabBtns.forEach(btn => {
                    if (btn.dataset.tab === tabName) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                
                // Show active tab content
                tabContents.forEach(content => {
                    if (content.id === tabName) {
                        content.classList.add('active');
                    } else {
                        content.classList.remove('active');
                    }
                });
                
                // If switching to analytics tab and data exists, compute analytics
                if (tabName === 'analytics' && studentPerformanceData.length > 0) {
                    computeAnalytics();
                    renderAnalytics();
                }
                
                // If switching to rankings tab, compute rankings
                if (tabName === 'rankings' && studentPerformanceData.length > 0) {
                    computeRankings();
                    renderRankings();
                }
                
                // If switching to insights tab, generate insights
                if (tabName === 'insights' && studentPerformanceData.length > 0) {
                    generateInsights();
                    renderInsights();
                }
            }

            // Function to load user data
            async function loadUserData() {
                try {
                    console.log('Loading examination officer data...');
                    
                    // Check if user is logged in
                    const { data: { user }, error: userError } = await supabase.auth.getUser();
                    
                    if (userError) {
                        console.error('Auth error:', userError);
                        redirectToLogin();
                        return;
                    }
                    
                    if (!user) {
                        console.error('No user found - redirecting to login');
                        redirectToLogin();
                        return;
                    }
                    
                    currentUser = user;
                    console.log('Examination officer authenticated:', user.id);
                    
                    // Initialize page
                    initializePage();
                    
                } catch (error) {
                    console.error('Error loading user data:', error);
                }
            }

            // Function to redirect to login
            function redirectToLogin() {
                window.location.href = 'index.html';
            }

            // Function to initialize the page
            async function initializePage() {
                console.log('Initializing Combine Results page...');
                
                // First check if the table exists
                await checkTableExists();
                
                // Setup event listeners
                setupEventListeners();
                
                console.log('Combine Results page initialized successfully');
            }

            // Function to check if table exists
            async function checkTableExists() {
                try {
                    console.log('Checking if student_performance table exists...');
                    
                    // Hide all containers
                    loadingSpinner.style.display = 'flex';
                    noDataMessage.style.display = 'none';
                    setupDatabaseMessage.style.display = 'none';
                    tableContainer.style.display = 'none';
                    paginationContainer.style.display = 'none';
                    
                    rowCount.textContent = 'Checking database...';
                    
                    // Try to query the table with a simple select
                    const { data, error } = await supabase
                        .from('student_performance')
                        .select('admission_no')
                        .limit(1);
                    
                    if (error) {
                        console.log('Table does not exist or error:', error.message);
                        
                        if (error.code === 'PGRST116' || error.message.includes('does not exist')) {
                            // Table doesn't exist, show setup message
                            showSetupDatabaseMessage();
                        } else {
                            // Other error
                            console.error('Error checking table:', error);
                            showNoDataMessage();
                        }
                    } else {
                        console.log('Table exists, proceeding with data fetch...');
                        // Table exists, proceed with normal flow
                        await loadDropdownOptions();
                        await fetchStudentPerformance();
                    }
                    
                } catch (error) {
                    console.error('Error in checkTableExists:', error);
                    showNoDataMessage();
                }
            }

            // Function to show setup database message
            function showSetupDatabaseMessage() {
                loadingSpinner.style.display = 'none';
                noDataMessage.style.display = 'none';
                setupDatabaseMessage.style.display = 'block';
                tableContainer.style.display = 'none';
                paginationContainer.style.display = 'none';
            }

            // Function to create the student_performance table
            async function createPerformanceTable() {
                try {
                    createTableBtn.disabled = true;
                    createTableBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Table...';
                    
                    console.log('Creating student_performance table...');
                    
                    // Show SQL to create table (for manual execution in Supabase SQL editor)
                    const createTableSQL = `
CREATE TABLE IF NOT EXISTS student_performance (
    id BIGSERIAL PRIMARY KEY,
    admission_no VARCHAR(50) NOT NULL,
    student_name VARCHAR(200) NOT NULL,
    stream VARCHAR(50),
    form_grade VARCHAR(50) NOT NULL,
    subject_code VARCHAR(50) NOT NULL,
    exam_type VARCHAR(50) NOT NULL,
    marks_obtained DECIMAL(5,2),
    max_score DECIMAL(5,2) DEFAULT 100.00,
    percentage DECIMAL(5,2),
    grade VARCHAR(2),
    exam_date DATE,
    teacher_name VARCHAR(200),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Create indexes for better performance
CREATE INDEX idx_student_performance_admission ON student_performance(admission_no);
CREATE INDEX idx_student_performance_form ON student_performance(form_grade);
CREATE INDEX idx_student_performance_subject ON student_performance(subject_code);
CREATE INDEX idx_student_performance_exam_type ON student_performance(exam_type);
CREATE INDEX idx_student_performance_stream ON student_performance(stream);
`;
                    
                    // Since we can't execute SQL directly from the client,
                    // we'll create the table by inserting a dummy record
                    // This will auto-create the table if RLS policies allow
                    console.log('Attempting to auto-create table by inserting dummy record...');
                    
                    const { data, error } = await supabase
                        .from('student_performance')
                        .insert([{
                            admission_no: 'TEST001',
                            student_name: 'Test Student',
                            stream: 'North',
                            form_grade: 'Form 3',
                            subject_code: 'MATH',
                            exam_type: 'Term 1',
                            marks_obtained: 85.5,
                            max_score: 100,
                            percentage: 85.5,
                            grade: 'A',
                            exam_date: new Date().toISOString().split('T')[0],
                            teacher_name: 'Test Teacher'
                        }])
                        .select();
                    
                    if (error) {
                        console.error('Error creating table:', error);
                        
                        // Show manual SQL creation instructions
                        alert(`Unable to create table automatically. Please run this SQL in your Supabase SQL Editor:\n\n${createTableSQL}\n\nAfter creating the table, refresh this page.`);
                    } else {
                        console.log('Table created successfully');
                        alert('Table created successfully! Now fetching data...');
                        
                        // Now fetch the data
                        await loadDropdownOptions();
                        await fetchStudentPerformance();
                    }
                    
                } catch (error) {
                    console.error('Error in createPerformanceTable:', error);
                    alert('Error creating table. Please check console for details.');
                } finally {
                    createTableBtn.disabled = false;
                    createTableBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Create Performance Table';
                }
            }

            // Function to load dropdown options from existing data
            async function loadDropdownOptions() {
                try {
                    // Load unique subjects from existing data
                    const { data: subjectsData, error: subjectsError } = await supabase
                        .from('student_performance')
                        .select('subject_code')
                        .order('subject_code');
                    
                    if (!subjectsError && subjectsData) {
                        // Get unique subjects
                        const uniqueSubjects = [...new Set(subjectsData.map(item => item.subject_code).filter(Boolean))];
                        filterSubject.innerHTML = '<option value="">All Subjects</option>' +
                            uniqueSubjects.map(subject => 
                                `<option value="${subject}">${subject}</option>`
                            ).join('');
                    }
                    
                    // Load unique exam types
                    const { data: examTypesData, error: examTypesError } = await supabase
                        .from('student_performance')
                        .select('exam_type')
                        .order('exam_type');
                    
                    if (!examTypesError && examTypesData) {
                        // Get unique exam types
                        const uniqueExamTypes = [...new Set(examTypesData.map(item => item.exam_type).filter(Boolean))];
                        // Update the exam type dropdown if we found new ones
                        if (uniqueExamTypes.length > 0) {
                            let currentOptions = Array.from(filterExamType.options).map(opt => opt.value);
                            uniqueExamTypes.forEach(type => {
                                if (!currentOptions.includes(type)) {
                                    filterExamType.innerHTML += `<option value="${type}">${type}</option>`;
                                }
                            });
                        }
                    }
                    
                } catch (error) {
                    console.error('Error loading dropdown options:', error);
                }
            }

            // Main function to fetch student performance data
            async function fetchStudentPerformance() {
                try {
                    console.log('Fetching student performance data from database...');
                    
                    // Show loading spinner
                    loadingSpinner.style.display = 'flex';
                    noDataMessage.style.display = 'none';
                    setupDatabaseMessage.style.display = 'none';
                    tableContainer.style.display = 'none';
                    paginationContainer.style.display = 'none';
                    rowCount.textContent = 'Loading data...';
                    
                    // Build query
                    let query = supabase
                        .from('student_performance')
                        .select('*');
                    
                    // Apply filters if any
                    const formFilter = filterForm.value;
                    const streamFilter = filterStream.value;
                    const subjectFilter = filterSubject.value;
                    const examTypeFilter = filterExamType.value;
                    
                    if (formFilter) {
                        query = query.eq('form_grade', formFilter);
                    }
                    if (streamFilter) {
                        query = query.eq('stream', streamFilter);
                    }
                    if (subjectFilter) {
                        query = query.eq('subject_code', subjectFilter);
                    }
                    if (examTypeFilter) {
                        query = query.eq('exam_type', examTypeFilter);
                    }
                    
                    // Execute query
                    const { data, error } = await query.order('exam_date', { ascending: false });
                    
                    if (error) {
                        console.error('Error fetching student performance:', error);
                        throw error;
                    }
                    
                    console.log(`Fetched ${data?.length || 0} student performance records`);
                    
                    // Process data
                    studentPerformanceData = data || [];
                    filteredData = [...studentPerformanceData];
                    
                    // Extract columns from data
                    if (studentPerformanceData.length > 0) {
                        extractColumns();
                        updateSummary();
                        renderExcelTable();
                    } else {
                        showNoDataMessage();
                    }
                    
                } catch (error) {
                    console.error('Error in fetchStudentPerformance:', error);
                    showNoDataMessage();
                }
            }

            // Function to extract columns from data
            function extractColumns() {
                if (studentPerformanceData.length === 0) return;
                
                // Get all unique keys from the first few records
                const sampleRecord = studentPerformanceData[0];
                columns = Object.keys(sampleRecord);
                
                // Define column display names and order based on your table structure
                const columnDisplayNames = {
                    id: 'ID',
                    admission_no: 'Admission No',
                    student_name: 'Student Name',
                    stream: 'Stream',
                    form_grade: 'Form/Grade',
                    subject_code: 'Subject Code',
                    exam_type: 'Exam Type',
                    marks_obtained: 'Marks Obtained',
                    max_score: 'Max Score',
                    percentage: 'Percentage',
                    grade: 'Grade',
                    exam_date: 'Exam Date',
                    teacher_name: 'Teacher Name',
                    created_at: 'Created At',
                    updated_at: 'Updated At'
                };
                
                // Sort columns in a logical order
                const columnOrder = [
                    'admission_no', 'student_name', 'form_grade', 'stream', 
                    'subject_code', 'exam_type', 'marks_obtained', 'max_score', 
                    'percentage', 'grade', 'exam_date', 'teacher_name',
                    'created_at', 'updated_at', 'id'
                ];
                
                // Reorder columns based on the defined order
                columns = columnOrder.filter(col => sampleRecord.hasOwnProperty(col));
                
                // Update sort dropdown
                updateSortDropdown();
            }

            // Function to update sort dropdown
            function updateSortDropdown() {
                sortColumn.innerHTML = '<option value="">Sort by...</option>';
                
                columns.forEach(column => {
                    const displayName = getColumnDisplayName(column);
                    if (displayName) {
                        sortColumn.innerHTML += `<option value="${column}">${displayName}</option>`;
                    }
                });
            }

            // Function to get column display name
            function getColumnDisplayName(column) {
                const displayNames = {
                    'admission_no': 'Admission No',
                    'student_name': 'Student Name',
                    'stream': 'Stream',
                    'form_grade': 'Form/Grade',
                    'subject_code': 'Subject Code',
                    'exam_type': 'Exam Type',
                    'marks_obtained': 'Marks Obtained',
                    'max_score': 'Max Score',
                    'percentage': 'Percentage',
                    'grade': 'Grade',
                    'exam_date': 'Exam Date',
                    'teacher_name': 'Teacher Name',
                    'created_at': 'Created At',
                    'updated_at': 'Updated At'
                };
                
                return displayNames[column] || column.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            }

            // Function to update data summary
            function updateSummary() {
                if (studentPerformanceData.length === 0) {
                    totalStudents.textContent = '0';
                    totalSubjects.textContent = '0';
                    avgScore.textContent = '0%';
                    dataUpdated.textContent = '-';
                    gradeA.textContent = '0';
                    gradeB.textContent = '0';
                    gradeC.textContent = '0';
                    gradeD.textContent = '0';
                    gradeE.textContent = '0';
                    return;
                }
                
                // Calculate unique students
                const uniqueStudents = new Set(studentPerformanceData.map(item => item.admission_no));
                totalStudents.textContent = uniqueStudents.size;
                
                // Calculate unique subjects
                const uniqueSubjects = new Set(studentPerformanceData.map(item => item.subject_code));
                totalSubjects.textContent = uniqueSubjects.size;
                
                // Calculate average percentage
                const percentages = studentPerformanceData
                    .filter(item => item.percentage && !isNaN(item.percentage))
                    .map(item => parseFloat(item.percentage));
                
                const avg = percentages.length > 0 ? 
                    Math.round(percentages.reduce((a, b) => a + b, 0) / percentages.length) : 0;
                avgScore.textContent = avg + '%';
                
                // Get last updated timestamp
                const latestTimestamp = studentPerformanceData
                    .map(item => new Date(item.updated_at || item.created_at || item.exam_date))
                    .filter(date => !isNaN(date.getTime()))
                    .sort((a, b) => b - a)[0];
                
                if (latestTimestamp) {
                    dataUpdated.textContent = latestTimestamp.toLocaleDateString();
                }
                
                // Calculate grade distribution
                const grades = studentPerformanceData
                    .filter(item => item.grade)
                    .map(item => item.grade.toUpperCase());
                
                gradeA.textContent = grades.filter(g => g === 'A').length;
                gradeB.textContent = grades.filter(g => g === 'B').length;
                gradeC.textContent = grades.filter(g => g === 'C').length;
                gradeD.textContent = grades.filter(g => g === 'D').length;
                gradeE.textContent = grades.filter(g => g === 'E').length;
            }

            // Function to compute comprehensive analytics
            function computeAnalytics() {
                if (studentPerformanceData.length === 0) return;
                
                console.log('Computing comprehensive analytics...');
                
                // Reset analytics data
                analyticsData = {
                    overallPerformance: {},
                    subjectPerformance: {},
                    streamPerformance: {},
                    rankings: {},
                    insights: {},
                    trends: {}
                };
                
                // 1. Compute overall performance
                computeOverallPerformance();
                
                // 2. Compute subject performance
                computeSubjectPerformance();
                
                // 3. Compute stream performance
                computeStreamPerformance();
                
                // 4. Compute rankings
                computeRankings();
                
                // 5. Generate insights
                generateInsights();
                
                console.log('Analytics computation complete');
            }

            // Function to compute overall performance
            function computeOverallPerformance() {
                const percentages = studentPerformanceData
                    .filter(item => item.percentage && !isNaN(item.percentage))
                    .map(item => parseFloat(item.percentage));
                
                if (percentages.length === 0) return;
                
                // Calculate statistics
                const sum = percentages.reduce((a, b) => a + b, 0);
                const mean = sum / percentages.length;
                const sorted = [...percentages].sort((a, b) => a - b);
                const median = sorted.length % 2 === 0 
                    ? (sorted[sorted.length/2 - 1] + sorted[sorted.length/2]) / 2
                    : sorted[Math.floor(sorted.length/2)];
                
                // Calculate standard deviation
                const squaredDiffs = percentages.map(x => Math.pow(x - mean, 2));
                const avgSquaredDiff = squaredDiffs.reduce((a, b) => a + b, 0) / percentages.length;
                const stdDev = Math.sqrt(avgSquaredDiff);
                
                // Calculate pass rate (assuming 40% is passing)
                const passCount = percentages.filter(p => p >= 40).length;
                const passRate = (passCount / percentages.length) * 100;
                
                analyticsData.overallPerformance = {
                    mean,
                    median,
                    stdDev,
                    passRate,
                    totalExams: studentPerformanceData.length,
                    uniqueStudents: new Set(studentPerformanceData.map(item => item.admission_no)).size
                };
            }

            // Function to compute subject performance
            function computeSubjectPerformance() {
                // Group by subject
                const subjectGroups = {};
                
                studentPerformanceData.forEach(item => {
                    if (!item.subject_code) return;
                    
                    if (!subjectGroups[item.subject_code]) {
                        subjectGroups[item.subject_code] = {
                            scores: [],
                            count: 0,
                            sum: 0
                        };
                    }
                    
                    if (item.percentage && !isNaN(item.percentage)) {
                        const score = parseFloat(item.percentage);
                        subjectGroups[item.subject_code].scores.push(score);
                        subjectGroups[item.subject_code].sum += score;
                        subjectGroups[item.subject_code].count++;
                    }
                });
                
                // Calculate averages for each subject
                for (const subject in subjectGroups) {
                    const group = subjectGroups[subject];
                    group.average = group.count > 0 ? group.sum / group.count : 0;
                }
                
                analyticsData.subjectPerformance = subjectGroups;
            }

            // Function to compute stream performance
            function computeStreamPerformance() {
                // Group by stream
                const streamGroups = {};
                
                studentPerformanceData.forEach(item => {
                    if (!item.stream) return;
                    
                    if (!streamGroups[item.stream]) {
                        streamGroups[item.stream] = {
                            scores: [],
                            count: 0,
                            sum: 0
                        };
                    }
                    
                    if (item.percentage && !isNaN(item.percentage)) {
                        const score = parseFloat(item.percentage);
                        streamGroups[item.stream].scores.push(score);
                        streamGroups[item.stream].sum += score;
                        streamGroups[item.stream].count++;
                    }
                });
                
                // Calculate averages for each stream
                for (const stream in streamGroups) {
                    const group = streamGroups[stream];
                    group.average = group.count > 0 ? group.sum / group.count : 0;
                }
                
                analyticsData.streamPerformance = streamGroups;
            }

            // Function to compute rankings
            function computeRankings() {
                // 1. Overall student rankings (by average percentage)
                const studentScores = {};
                
                studentPerformanceData.forEach(item => {
                    if (!item.admission_no || !item.percentage || isNaN(item.percentage)) return;
                    
                    const studentId = item.admission_no;
                    const studentName = item.student_name || 'Unknown';
                    const score = parseFloat(item.percentage);
                    
                    if (!studentScores[studentId]) {
                        studentScores[studentId] = {
                            name: studentName,
                            scores: [],
                            count: 0,
                            sum: 0
                        };
                    }
                    
                    studentScores[studentId].scores.push(score);
                    studentScores[studentId].sum += score;
                    studentScores[studentId].count++;
                });
                
                // Calculate averages and prepare for ranking
                const studentRankings = Object.keys(studentScores).map(studentId => {
                    const student = studentScores[studentId];
                    return {
                        id: studentId,
                        name: student.name,
                        average: student.count > 0 ? student.sum / student.count : 0,
                        count: student.count
                    };
                });
                
                // Sort by average (descending)
                studentRankings.sort((a, b) => b.average - a.average);
                
                // 2. Subject rankings
                const subjectRankings = Object.keys(analyticsData.subjectPerformance).map(subject => {
                    const perf = analyticsData.subjectPerformance[subject];
                    return {
                        subject,
                        average: perf.average || 0,
                        count: perf.count || 0
                    };
                }).sort((a, b) => b.average - a.average);
                
                // 3. Stream rankings
                const streamRankings = Object.keys(analyticsData.streamPerformance).map(stream => {
                    const perf = analyticsData.streamPerformance[stream];
                    return {
                        stream,
                        average: perf.average || 0,
                        count: perf.count || 0
                    };
                }).sort((a, b) => b.average - a.average);
                
                // 4. Form rankings
                const formGroups = {};
                
                studentPerformanceData.forEach(item => {
                    if (!item.form_grade || !item.percentage || isNaN(item.percentage)) return;
                    
                    const form = item.form_grade;
                    const score = parseFloat(item.percentage);
                    
                    if (!formGroups[form]) {
                        formGroups[form] = {
                            scores: [],
                            count: 0,
                            sum: 0
                        };
                    }
                    
                    formGroups[form].scores.push(score);
                    formGroups[form].sum += score;
                    formGroups[form].count++;
                });
                
                const formRankings = Object.keys(formGroups).map(form => {
                    const group = formGroups[form];
                    return {
                        form,
                        average: group.count > 0 ? group.sum / group.count : 0,
                        count: group.count
                    };
                }).sort((a, b) => b.average - a.average);
                
                analyticsData.rankings = {
                    students: studentRankings.slice(0, 20), // Top 20 students
                    subjects: subjectRankings.slice(0, 10), // Top 10 subjects
                    streams: streamRankings,
                    forms: formRankings
                };
            }

            // Function to generate insights
            function generateInsights() {
                const insights = [];
                const improvementAreas = [];
                const trends = [];
                
                // 1. Find best performing student
                if (analyticsData.rankings.students.length > 0) {
                    const topStudent = analyticsData.rankings.students[0];
                    insights.push(`Top performing student: ${topStudent.name} with an average of ${topStudent.average.toFixed(1)}%`);
                    
                    // Update best student element
                    bestStudent.textContent = `${topStudent.name} (${topStudent.average.toFixed(1)}%)`;
                }
                
                // 2. Find best performing subject
                if (analyticsData.rankings.subjects.length > 0) {
                    const topSubject = analyticsData.rankings.subjects[0];
                    insights.push(`Best performing subject: ${topSubject.subject} with an average of ${topSubject.average.toFixed(1)}%`);
                    
                    // Update best subject element
                    bestSubject.textContent = `${topSubject.subject} (${topSubject.average.toFixed(1)}%)`;
                }
                
                // 3. Find best performing stream
                if (analyticsData.rankings.streams.length > 0) {
                    const topStream = analyticsData.rankings.streams[0];
                    insights.push(`Best performing stream: ${topStream.stream} with an average of ${topStream.average.toFixed(1)}%`);
                    
                    // Update best stream element
                    bestStream.textContent = `${topStream.stream} (${topStream.average.toFixed(1)}%)`;
                }
                
                // 4. Find best exam type
                const examTypeGroups = {};
                
                studentPerformanceData.forEach(item => {
                    if (!item.exam_type || !item.percentage || isNaN(item.percentage)) return;
                    
                    const examType = item.exam_type;
                    const score = parseFloat(item.percentage);
                    
                    if (!examTypeGroups[examType]) {
                        examTypeGroups[examType] = {
                            scores: [],
                            count: 0,
                            sum: 0
                        };
                    }
                    
                    examTypeGroups[examType].scores.push(score);
                    examTypeGroups[examType].sum += score;
                    examTypeGroups[examType].count++;
                });
                
                const examTypeRankings = Object.keys(examTypeGroups).map(examType => {
                    const group = examTypeGroups[examType];
                    return {
                        examType,
                        average: group.count > 0 ? group.sum / group.count : 0,
                        count: group.count
                    };
                }).sort((a, b) => b.average - a.average);
                
                if (examTypeRankings.length > 0) {
                    const bestExam = examTypeRankings[0];
                    insights.push(`Best exam type: ${bestExam.examType} with an average of ${bestExam.average.toFixed(1)}%`);
                    
                    // Update best exam type element
                    bestExamType.textContent = `${bestExam.examType} (${bestExam.average.toFixed(1)}%)`;
                    totalExams.textContent = studentPerformanceData.length;
                }
                
                // 5. Identify subjects needing improvement
                if (analyticsData.rankings.subjects.length > 0) {
                    const bottomSubjects = analyticsData.rankings.subjects.slice(-3).reverse();
                    bottomSubjects.forEach(subject => {
                        improvementAreas.push(`${subject.subject}: Average score of ${subject.average.toFixed(1)}% needs improvement`);
                    });
                }
                
                // 6. Calculate pass rate
                const percentages = studentPerformanceData
                    .filter(item => item.percentage && !isNaN(item.percentage))
                    .map(item => parseFloat(item.percentage));
                
                if (percentages.length > 0) {
                    const passCount = percentages.filter(p => p >= 40).length;
                    const passRateValue = (passCount / percentages.length) * 100;
                    
                    insights.push(`Overall pass rate: ${passRateValue.toFixed(1)}% (${passCount} out of ${percentages.length} exams passed)`);
                    passRate.textContent = `${passRateValue.toFixed(1)}%`;
                    
                    if (passRateValue < 70) {
                        improvementAreas.push(`Overall pass rate of ${passRateValue.toFixed(1)}% is below the 70% target`);
                    }
                }
                
                // 7. Calculate mean and median
                if (analyticsData.overallPerformance.mean) {
                    const mean = analyticsData.overallPerformance.mean;
                    const median = analyticsData.overallPerformance.median;
                    const stdDev = analyticsData.overallPerformance.stdDev;
                    
                    meanScore.textContent = `${mean.toFixed(1)}%`;
                    medianScore.textContent = `${median.toFixed(1)}%`;
                    stdDev.textContent = stdDev.toFixed(1);
                    
                    insights.push(`Mean score: ${mean.toFixed(1)}%, Median: ${median.toFixed(1)}%, Standard Deviation: ${stdDev.toFixed(1)}`);
                    
                    // Insight based on standard deviation
                    if (stdDev > 15) {
                        trends.push(`High score variability (std dev: ${stdDev.toFixed(1)}) indicates inconsistent performance across students`);
                    } else {
                        trends.push(`Consistent performance across students (std dev: ${stdDev.toFixed(1)})`);
                    }
                }
                
                // 8. Form performance insights
                if (analyticsData.rankings.forms.length > 0) {
                    const topForm = analyticsData.rankings.forms[0];
                    const bottomForm = analyticsData.rankings.forms[analyticsData.rankings.forms.length - 1];
                    
                    insights.push(`Leading form: ${topForm.form} (${topForm.average.toFixed(1)}%), Needs attention: ${bottomForm.form} (${bottomForm.average.toFixed(1)}%)`);
                    
                    avgFormScore.textContent = `${topForm.average.toFixed(1)}%`;
                    
                    // Calculate improvement rate (difference between top and bottom forms)
                    const improvement = topForm.average - bottomForm.average;
                    improvementRate.textContent = `${improvement.toFixed(1)}%`;
                }
                
                // 9. Calculate consistency score
                const consistencyScoreValue = analyticsData.overallPerformance.stdDev ? 
                    100 - Math.min(analyticsData.overallPerformance.stdDev, 30) * 2 : 0;
                consistencyScore.textContent = Math.round(consistencyScoreValue);
                
                // 10. Calculate excellence rate (percentage of A grades)
                const totalGrades = studentPerformanceData.filter(item => item.grade).length;
                const aGrades = studentPerformanceData.filter(item => 
                    item.grade && item.grade.toUpperCase() === 'A').length;
                
                const excellenceRateValue = totalGrades > 0 ? (aGrades / totalGrades) * 100 : 0;
                excellenceRate.textContent = `${excellenceRateValue.toFixed(1)}%`;
                
                if (excellenceRateValue > 20) {
                    insights.push(`Excellent performance: ${excellenceRateValue.toFixed(1)}% of exams received A grade`);
                }
                
                // Store insights
                analyticsData.insights = {
                    keyInsights: insights,
                    improvementAreas: improvementAreas,
                    trends: trends
                };
            }

            // Function to render analytics
            function renderAnalytics() {
                // Update metrics
                if (analyticsData.overallPerformance.mean) {
                    meanScore.textContent = `${analyticsData.overallPerformance.mean.toFixed(1)}%`;
                    medianScore.textContent = `${analyticsData.overallPerformance.median.toFixed(1)}%`;
                    stdDev.textContent = analyticsData.overallPerformance.stdDev.toFixed(1);
                    passRate.textContent = `${analyticsData.overallPerformance.passRate.toFixed(1)}%`;
                }
                
                // Render charts
                renderCharts();
            }

            // Function to render charts
            function renderCharts() {
                // Destroy existing charts if they exist
                if (performanceChart) performanceChart.destroy();
                if (subjectChart) subjectChart.destroy();
                if (streamChart) streamChart.destroy();
                if (gradeChart) gradeChart.destroy();
                
                // 1. Overall Performance Chart (Line chart showing performance over time)
                const performanceCtx = document.getElementById('performanceChart').getContext('2d');
                
                // Group by date for performance over time
                const dateGroups = {};
                studentPerformanceData.forEach(item => {
                    if (!item.exam_date || !item.percentage || isNaN(item.percentage)) return;
                    
                    const date = new Date(item.exam_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    if (!dateGroups[date]) {
                        dateGroups[date] = {
                            scores: [],
                            sum: 0,
                            count: 0
                        };
                    }
                    
                    const score = parseFloat(item.percentage);
                    dateGroups[date].scores.push(score);
                    dateGroups[date].sum += score;
                    dateGroups[date].count++;
                });
                
                // Get sorted dates and calculate averages
                const sortedDates = Object.keys(dateGroups).sort((a, b) => {
                    return new Date(a) - new Date(b);
                });
                
                const dateLabels = sortedDates.slice(-10); // Last 10 dates
                const dateAverages = dateLabels.map(date => {
                    const group = dateGroups[date];
                    return group.count > 0 ? group.sum / group.count : 0;
                });
                
                performanceChart = new Chart(performanceCtx, {
                    type: 'line',
                    data: {
                        labels: dateLabels,
                        datasets: [{
                            label: 'Average Percentage',
                            data: dateAverages,
                            borderColor: 'rgba(7, 88, 36, 1)',
                            backgroundColor: 'rgba(7, 88, 36, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
                
                // 2. Subject Comparison Chart (Bar chart)
                const subjectCtx = document.getElementById('subjectChart').getContext('2d');
                
                // Get top 5 subjects by average
                const topSubjects = analyticsData.rankings.subjects.slice(0, 5);
                const subjectLabels = topSubjects.map(s => s.subject);
                const subjectAverages = topSubjects.map(s => s.average);
                
                subjectChart = new Chart(subjectCtx, {
                    type: 'bar',
                    data: {
                        labels: subjectLabels,
                        datasets: [{
                            label: 'Average Percentage',
                            data: subjectAverages,
                            backgroundColor: [
                                'rgba(7, 88, 36, 0.7)',
                                'rgba(55, 116, 55, 0.7)',
                                'rgba(155, 174, 48, 0.7)',
                                'rgba(93, 139, 112, 0.7)',
                                'rgba(51, 54, 135, 0.7)'
                            ],
                            borderColor: [
                                'rgba(7, 88, 36, 1)',
                                'rgba(55, 116, 55, 1)',
                                'rgba(155, 174, 48, 1)',
                                'rgba(93, 139, 112, 1)',
                                'rgba(51, 54, 135, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
                
                // 3. Stream Performance Chart (Bar chart)
                const streamCtx = document.getElementById('streamChart').getContext('2d');
                
                const streamLabels = analyticsData.rankings.streams.map(s => s.stream);
                const streamAverages = analyticsData.rankings.streams.map(s => s.average);
                
                streamChart = new Chart(streamCtx, {
                    type: 'bar',
                    data: {
                        labels: streamLabels,
                        datasets: [{
                            label: 'Average Percentage',
                            data: streamAverages,
                            backgroundColor: 'rgba(155, 174, 48, 0.7)',
                            borderColor: 'rgba(155, 174, 48, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
                
                // 4. Grade Distribution Chart (Pie chart)
                const gradeCtx = document.getElementById('gradeChart').getContext('2d');
                
                // Count grades
                const gradeCounts = {
                    'A': 0, 'B': 0, 'C': 0, 'D': 0, 'E': 0, 'F': 0
                };
                
                studentPerformanceData.forEach(item => {
                    if (item.grade) {
                        const grade = item.grade.toUpperCase();
                        if (gradeCounts.hasOwnProperty(grade)) {
                            gradeCounts[grade]++;
                        }
                    }
                });
                
                // Filter out grades with zero count
                const gradeLabels = Object.keys(gradeCounts).filter(grade => gradeCounts[grade] > 0);
                const gradeData = gradeLabels.map(grade => gradeCounts[grade]);
                
                gradeChart = new Chart(gradeCtx, {
                    type: 'pie',
                    data: {
                        labels: gradeLabels,
                        datasets: [{
                            data: gradeData,
                            backgroundColor: [
                                'rgba(40, 167, 69, 0.7)',    // Green for A
                                'rgba(255, 193, 7, 0.7)',    // Yellow for B
                                'rgba(23, 162, 184, 0.7)',   // Cyan for C
                                'rgba(108, 117, 125, 0.7)',  // Gray for D
                                'rgba(220, 53, 69, 0.7)',    // Red for E
                                'rgba(111, 66, 193, 0.7)'    // Purple for F
                            ],
                            borderColor: [
                                'rgba(40, 167, 69, 1)',
                                'rgba(255, 193, 7, 1)',
                                'rgba(23, 162, 184, 1)',
                                'rgba(108, 117, 125, 1)',
                                'rgba(220, 53, 69, 1)',
                                'rgba(111, 66, 193, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // Function to render rankings
            function renderRankings() {
                // 1. Overall student rankings
                let overallHTML = '';
                analyticsData.rankings.students.slice(0, 10).forEach((student, index) => {
                    const positionClass = index < 3 ? 'top-3' : '';
                    overallHTML += `
                        <div class="rank-item">
                            <div class="rank-position ${positionClass}">${index + 1}</div>
                            <div class="rank-info">
                                <h4>${student.name}</h4>
                                <p>${student.id}  ${student.count} exams</p>
                            </div>
                            <div class="rank-score">${student.average.toFixed(1)}%</div>
                        </div>
                    `;
                });
                overallRankings.innerHTML = overallHTML;
                
                // 2. Subject rankings
                let subjectHTML = '';
                analyticsData.rankings.subjects.slice(0, 10).forEach((subject, index) => {
                    subjectHTML += `
                        <div class="rank-item">
                            <div class="rank-position">${index + 1}</div>
                            <div class="rank-info">
                                <h4>${subject.subject}</h4>
                                <p>${subject.count} exams</p>
                            </div>
                            <div class="rank-score">${subject.average.toFixed(1)}%</div>
                        </div>
                    `;
                });
                subjectRankings.innerHTML = subjectHTML;
                
                // 3. Stream rankings
                let streamHTML = '';
                analyticsData.rankings.streams.forEach((stream, index) => {
                    streamHTML += `
                        <div class="rank-item">
                            <div class="rank-position">${index + 1}</div>
                            <div class="rank-info">
                                <h4>${stream.stream} Stream</h4>
                                <p>${stream.count} exams</p>
                            </div>
                            <div class="rank-score">${stream.average.toFixed(1)}%</div>
                        </div>
                    `;
                });
                streamRankings.innerHTML = streamHTML;
                
                // 4. Form rankings
                let formHTML = '';
                analyticsData.rankings.forms.forEach((form, index) => {
                    formHTML += `
                        <div class="rank-item">
                            <div class="rank-position">${index + 1}</div>
                            <div class="rank-info">
                                <h4>${form.form}</h4>
                                <p>${form.count} exams</p>
                            </div>
                            <div class="rank-score">${form.average.toFixed(1)}%</div>
                        </div>
                    `;
                });
                formRankings.innerHTML = formHTML;
            }

            // Function to render insights
            function renderInsights() {
                // 1. Key insights
                let insightsHTML = '';
                analyticsData.insights.keyInsights.forEach((insight, index) => {
                    insightsHTML += `
                        <div class="stat-item">
                            <span class="stat-label">${insight}</span>
                            <span class="stat-change positive">New</span>
                        </div>
                    `;
                });
                keyInsights.innerHTML = insightsHTML;
                
                // 2. Improvement areas
                let improvementHTML = '';
                analyticsData.insights.improvementAreas.forEach((area, index) => {
                    improvementHTML += `
                        <div class="stat-item">
                            <span class="stat-label">${area}</span>
                            <span class="stat-change negative">Needs Attention</span>
                        </div>
                    `;
                });
                improvementAreas.innerHTML = improvementHTML;
                
                // 3. Performance trends
                let trendsHTML = '';
                analyticsData.insights.trends.forEach((trend, index) => {
                    trendsHTML += `
                        <div class="stat-item">
                            <span class="stat-label">${trend}</span>
                        </div>
                    `;
                });
                performanceTrends.innerHTML = trendsHTML;
            }

            // Function to render Excel-like table
            function renderExcelTable() {
                // Hide loading, show table
                loadingSpinner.style.display = 'none';
                noDataMessage.style.display = 'none';
                setupDatabaseMessage.style.display = 'none';
                tableContainer.style.display = 'block';
                paginationContainer.style.display = 'flex';
                
                // Apply search filter if any
                applySearchFilter();
                
                // Apply sorting if configured
                if (sortConfig.column) {
                    applySorting();
                }
                
                // Update row counts
                rowCount.textContent = `Total Records: ${studentPerformanceData.length}`;
                filteredCount.textContent = filteredData.length === studentPerformanceData.length ? 
                    '' : `Filtered: ${filteredData.length}`;
                
                // Calculate pagination
                totalPages = Math.ceil(filteredData.length / rowsPerPage);
                if (currentPage > totalPages) {
                    currentPage = Math.max(1, totalPages);
                }
                
                // Update pagination controls
                updatePagination();
                
                // Render table header
                renderTableHeader();
                
                // Render table body
                renderTableBody();
            }

            // Function to apply search filter
            function applySearchFilter() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                
                if (!searchTerm) {
                    filteredData = [...studentPerformanceData];
                    return;
                }
                
                filteredData = studentPerformanceData.filter(row => {
                    return Object.values(row).some(value => {
                        if (value === null || value === undefined) return false;
                        return value.toString().toLowerCase().includes(searchTerm);
                    });
                });
            }

            // Function to apply sorting
            function applySorting() {
                if (!sortConfig.column) return;
                
                filteredData.sort((a, b) => {
                    let aValue = a[sortConfig.column];
                    let bValue = b[sortConfig.column];
                    
                    // Handle null/undefined values
                    if (aValue === null || aValue === undefined) aValue = '';
                    if (bValue === null || bValue === undefined) bValue = '';
                    
                    // Convert to string for comparison
                    aValue = aValue.toString();
                    bValue = bValue.toString();
                    
                    // Try to convert to numbers if possible
                    const aNum = parseFloat(aValue);
                    const bNum = parseFloat(bValue);
                    
                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        aValue = aNum;
                        bValue = bNum;
                    }
                    
                    if (sortConfig.direction === 'asc') {
                        return aValue < bValue ? -1 : aValue > bValue ? 1 : 0;
                    } else {
                        return aValue > bValue ? -1 : aValue < bValue ? 1 : 0;
                    }
                });
            }

            // Function to update pagination
            function updatePagination() {
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
                
                firstPage.disabled = currentPage === 1;
                prevPage.disabled = currentPage === 1;
                nextPage.disabled = currentPage === totalPages;
                lastPage.disabled = currentPage === totalPages;
                
                // Update page buttons display
                if (totalPages === 0) {
                    paginationContainer.style.display = 'none';
                }
            }

            // Function to render table header
            function renderTableHeader() {
                let headerHTML = '<tr>';
                
                columns.forEach(column => {
                    const displayName = getColumnDisplayName(column);
                    if (displayName) {
                        const isSorted = column === sortConfig.column;
                        const sortIcon = isSorted ? 
                            (sortConfig.direction === 'asc' ? 
                                '<i class="fas fa-sort-up sort-icon"></i>' : 
                                '<i class="fas fa-sort-down sort-icon"></i>') : 
                            '<i class="fas fa-sort sort-icon"></i>';
                        
                        headerHTML += `
                            <th class="header-cell" data-column="${column}">
                                ${displayName} ${sortIcon}
                            </th>
                        `;
                    }
                });
                
                headerHTML += '</tr>';
                tableHeader.innerHTML = headerHTML;
                
                // Add click handlers for sorting
                document.querySelectorAll('.header-cell').forEach(th => {
                    th.addEventListener('click', () => {
                        const column = th.dataset.column;
                        
                        if (sortConfig.column === column) {
                            // Toggle direction
                            sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
                        } else {
                            // New column, default to ascending
                            sortConfig.column = column;
                            sortConfig.direction = 'asc';
                        }
                        
                        // Update UI
                        sortColumn.value = column;
                        sortDirection.value = sortConfig.direction;
                        
                        // Re-render table
                        renderExcelTable();
                    });
                });
            }

            // Function to render table body
            function renderTableBody() {
                // Calculate start and end indices for current page
                const startIndex = (currentPage - 1) * rowsPerPage;
                const endIndex = Math.min(startIndex + rowsPerPage, filteredData.length);
                const pageData = filteredData.slice(startIndex, endIndex);
                
                let bodyHTML = '';
                
                pageData.forEach((row, rowIndex) => {
                    bodyHTML += '<tr>';
                    
                    columns.forEach(column => {
                        let cellValue = row[column];
                        
                        // Format special columns
                        if ((column === 'marks_obtained' || column === 'max_score' || column === 'percentage') 
                            && cellValue !== null && cellValue !== undefined) {
                            const numValue = parseFloat(cellValue);
                            if (!isNaN(numValue)) {
                                if (column === 'percentage') {
                                    cellValue = numValue.toFixed(1) + '%';
                                } else {
                                    cellValue = numValue.toFixed(1);
                                }
                            }
                        } else if ((column === 'created_at' || column === 'updated_at' || column === 'exam_date') && cellValue) {
                            try {
                                const date = new Date(cellValue);
                                if (!isNaN(date.getTime())) {
                                    if (column === 'exam_date') {
                                        cellValue = date.toLocaleDateString();
                                    } else {
                                        cellValue = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                                    }
                                }
                            } catch (e) {
                                // Keep original value if date parsing fails
                            }
                        }
                        
                        // Default for null/undefined
                        if (cellValue === null || cellValue === undefined) {
                            cellValue = '';
                        }
                        
                        // Add data attribute for searching
                        bodyHTML += `<td data-column="${column}" data-value="${String(cellValue).replace(/"/g, '&quot;')}">${cellValue}</td>`;
                    });
                    
                    bodyHTML += '</tr>';
                });
                
                tableBody.innerHTML = bodyHTML;
                
                // If no data on current page, show message
                if (pageData.length === 0 && filteredData.length > 0) {
                    bodyHTML = `<tr><td colspan="${columns.length}" style="text-align: center; padding: 40px; color: var(--muted-green);">
                        No data to display for this page
                    </td></tr>`;
                    tableBody.innerHTML = bodyHTML;
                }
            }

            // Function to show no data message
            function showNoDataMessage() {
                loadingSpinner.style.display = 'none';
                noDataMessage.style.display = 'block';
                setupDatabaseMessage.style.display = 'none';
                tableContainer.style.display = 'none';
                paginationContainer.style.display = 'none';
                
                totalStudents.textContent = '0';
                totalSubjects.textContent = '0';
                avgScore.textContent = '0%';
                dataUpdated.textContent = '-';
                gradeA.textContent = '0';
                gradeB.textContent = '0';
                gradeC.textContent = '0';
                gradeD.textContent = '0';
                gradeE.textContent = '0';
            }

            // Function to export to CSV
            function exportToCSV() {
                if (filteredData.length === 0) {
                    alert('No data to export.');
                    return;
                }
                
                try {
                    // Create CSV content
                    let csvContent = '';
                    
                    // Add header row
                    const headers = columns.map(col => `"${getColumnDisplayName(col)}"`);
                    csvContent += headers.join(',') + '\n';
                    
                    // Add data rows
                    filteredData.forEach(row => {
                        const rowData = columns.map(col => {
                            let value = row[col];
                            
                            // Format values for CSV
                            if (value === null || value === undefined) {
                                value = '';
                            } else if (typeof value === 'string') {
                                // Escape quotes and wrap in quotes
                                value = value.replace(/"/g, '""');
                                value = `"${value}"`;
                            } else if (typeof value === 'object') {
                                value = JSON.stringify(value).replace(/"/g, '""');
                                value = `"${value}"`;
                            } else {
                                // For numbers, just convert to string
                                value = value.toString();
                            }
                            
                            return value;
                        });
                        
                        csvContent += rowData.join(',') + '\n';
                    });
                    
                    // Create blob and download
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    
                    // Generate filename with timestamp
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/[:]/g, '-');
                    const filename = `student_performance_${timestamp}.csv`;
                    
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    console.log(`CSV exported: ${filename}, ${filteredData.length} records`);
                    alert(`CSV file downloaded: ${filename}\n${filteredData.length} records exported.`);
                    
                } catch (error) {
                    console.error('Error exporting CSV:', error);
                    alert('Error exporting to CSV. Please try again.');
                }
            }

            // Function to export summary statistics
            function exportSummaryStatistics() {
                if (studentPerformanceData.length === 0) {
                    alert('No data to export.');
                    return;
                }
                
                try {
                    // Calculate summary statistics
                    const uniqueStudents = new Set(studentPerformanceData.map(item => item.admission_no));
                    const uniqueSubjects = new Set(studentPerformanceData.map(item => item.subject_code));
                    
                    const percentages = studentPerformanceData
                        .filter(item => item.percentage && !isNaN(item.percentage))
                        .map(item => parseFloat(item.percentage));
                    const avgPercentage = percentages.length > 0 ? 
                        Math.round(percentages.reduce((a, b) => a + b, 0) / percentages.length) : 0;
                    
                    const grades = studentPerformanceData
                        .filter(item => item.grade)
                        .map(item => item.grade.toUpperCase());
                    
                    // Create summary CSV content
                    let csvContent = 'Category,Value\n';
                    csvContent += `Total Records,${studentPerformanceData.length}\n`;
                    csvContent += `Unique Students,${uniqueStudents.size}\n`;
                    csvContent += `Unique Subjects,${uniqueSubjects.size}\n`;
                    csvContent += `Average Percentage,${avgPercentage}%\n`;
                    csvContent += `Grade A Count,${grades.filter(g => g === 'A').length}\n`;
                    csvContent += `Grade B Count,${grades.filter(g => g === 'B').length}\n`;
                    csvContent += `Grade C Count,${grades.filter(g => g === 'C').length}\n`;
                    csvContent += `Grade D Count,${grades.filter(g => g === 'D').length}\n`;
                    csvContent += `Grade E Count,${grades.filter(g => g === 'E').length}\n`;
                    
                    // Add filter information
                    csvContent += '\nCurrent Filters\n';
                    csvContent += `Form/Grade,${filterForm.value || 'All'}\n`;
                    csvContent += `Stream,${filterStream.value || 'All'}\n`;
                    csvContent += `Subject,${filterSubject.value || 'All'}\n`;
                    csvContent += `Exam Type,${filterExamType.value || 'All'}\n`;
                    csvContent += `Search Term,${searchInput.value || 'None'}\n`;
                    csvContent += `Export Date,${new Date().toLocaleString()}\n`;
                    
                    // Create blob and download
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    
                    // Generate filename with timestamp
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/[:]/g, '-');
                    const filename = `performance_summary_${timestamp}.csv`;
                    
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    console.log(`Summary exported: ${filename}`);
                    alert(`Summary CSV file downloaded: ${filename}`);
                    
                } catch (error) {
                    console.error('Error exporting summary:', error);
                    alert('Error exporting summary. Please try again.');
                }
            }

            // Function to setup event listeners
            function setupEventListeners() {
                // Hamburger menu
                if (hamburger) {
                    hamburger.addEventListener('click', () => {
                        sidebar.classList.toggle('open');
                    });
                }

                // User dropdown
                if (userProfileTop) {
                    userProfileTop.addEventListener('click', (e) => {
                        e.stopPropagation();
                        userDropdown.classList.toggle('show');
                        dropdownArrow.classList.toggle('fa-chevron-down');
                        dropdownArrow.classList.toggle('fa-chevron-up');
                    });
                }

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (userProfileTop && userDropdown && 
                        !userProfileTop.contains(e.target) && !userDropdown.contains(e.target)) {
                        userDropdown.classList.remove('show');
                        dropdownArrow.classList.remove('fa-chevron-up');
                        dropdownArrow.classList.add('fa-chevron-down');
                    }
                    
                    // Close sidebar when clicking outside on mobile
                    if (window.innerWidth <= 1024 && 
                        sidebar && sidebar.classList.contains('open') && 
                        !sidebar.contains(e.target) && 
                        e.target !== hamburger) {
                        sidebar.classList.remove('open');
                    }
                });

                // Navigation function for dropdown
                window.navigateTo = navigateTo;

                // Logout handlers
                if (logoutLink) {
                    logoutLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        handleLogout();
                    });
                }

                if (logoutSidebarLinks.length > 0) {
                    logoutSidebarLinks.forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            handleLogout();
                        });
                    });
                }

                // Tab switching
                tabBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const tabName = btn.dataset.tab;
                        switchTab(tabName);
                    });
                });

                // Compute results button
                if (computeResultsBtn) {
                    computeResultsBtn.addEventListener('click', () => {
                        if (studentPerformanceData.length === 0) {
                            alert('No data to compute. Please fetch data first.');
                            return;
                        }
                        
                        // Show loading
                        computeResultsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Computing Results...';
                        computeResultsBtn.disabled = true;
                        
                        // Compute analytics
                        computeAnalytics();
                        renderAnalytics();
                        computeRankings();
                        renderRankings();
                        generateInsights();
                        renderInsights();
                        
                        // Switch to analytics tab
                        switchTab('analytics');
                        
                        // Restore button
                        setTimeout(() => {
                            computeResultsBtn.innerHTML = '<i class="fas fa-brain"></i> Compute Results & Generate Analytics';
                            computeResultsBtn.disabled = false;
                            alert('Results computed successfully! Advanced analytics are now available.');
                        }, 500);
                    });
                }

                // Filter controls
                if (applyFilters) {
                    applyFilters.addEventListener('click', () => {
                        currentPage = 1;
                        fetchStudentPerformance();
                    });
                }

                if (clearFilters) {
                    clearFilters.addEventListener('click', () => {
                        filterForm.value = '';
                        filterStream.value = '';
                        filterSubject.value = '';
                        filterExamType.value = '';
                        searchInput.value = '';
                        sortConfig = { column: '', direction: 'asc' };
                        sortColumn.value = '';
                        currentPage = 1;
                        fetchStudentPerformance();
                    });
                }

                if (fetchData) {
                    fetchData.addEventListener('click', () => {
                        currentPage = 1;
                        fetchStudentPerformance();
                    });
                }

                // Create table button
                if (createTableBtn) {
                    createTableBtn.addEventListener('click', createPerformanceTable);
                }

                // Search functionality
                if (searchInput) {
                    // Search on Enter key
                    searchInput.addEventListener('keyup', (e) => {
                        if (e.key === 'Enter') {
                            applySearchAndRender();
                        }
                    });
                    
                    // Clear search on Escape
                    searchInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape') {
                            searchInput.value = '';
                            applySearchAndRender();
                        }
                    });
                }

                if (searchBtn) {
                    searchBtn.addEventListener('click', () => {
                        applySearchAndRender();
                    });
                }

                // Sort functionality
                if (sortColumn) {
                    sortColumn.addEventListener('change', () => {
                        if (sortColumn.value) {
                            sortConfig.column = sortColumn.value;
                            renderExcelTable();
                        }
                    });
                }

                if (sortDirection) {
                    sortDirection.addEventListener('change', () => {
                        sortConfig.direction = sortDirection.value;
                        renderExcelTable();
                    });
                }

                // Pagination controls
                if (firstPage) {
                    firstPage.addEventListener('click', () => {
                        if (currentPage > 1) {
                            currentPage = 1;
                            renderExcelTable();
                        }
                    });
                }

                if (prevPage) {
                    prevPage.addEventListener('click', () => {
                        if (currentPage > 1) {
                            currentPage--;
                            renderExcelTable();
                        }
                    });
                }

                if (nextPage) {
                    nextPage.addEventListener('click', () => {
                        if (currentPage < totalPages) {
                            currentPage++;
                            renderExcelTable();
                        }
                    });
                }

                if (lastPage) {
                    lastPage.addEventListener('click', () => {
                        if (currentPage < totalPages) {
                            currentPage = totalPages;
                            renderExcelTable();
                        }
                    });
                }

                // Rows per page
                if (rowsPerPageSelect) {
                    rowsPerPageSelect.addEventListener('change', () => {
                        rowsPerPage = parseInt(rowsPerPageSelect.value);
                        currentPage = 1;
                        renderExcelTable();
                    });
                }

                // Export to CSV
                if (exportCsv) {
                    exportCsv.addEventListener('click', exportToCSV);
                }

                // Export summary
                if (exportSummary) {
                    exportSummary.addEventListener('click', exportSummaryStatistics);
                }
            }

            // Function to apply search and re-render table
            function applySearchAndRender() {
                currentPage = 1;
                renderExcelTable();
            }

            // Handle logout
            async function handleLogout() {
                if (confirm('Are you sure you want to logout?')) {
                    try {
                        const { error } = await supabase.auth.signOut();
                        if (error) throw error;
                        
                        console.log('Logout successful, redirecting to login...');
                        
                        // Redirect to login page
                        window.location.href = 'index.html';
                    } catch (error) {
                        console.error('Logout error:', error);
                        alert('Error during logout. Please try again.');
                    }
                }
            }

            // Placeholder functions for other pages
            function showReportGeneration() {
                alert('Report generation functionality would be displayed here.');
                // In a real implementation, this would load report generation UI
            }

            function showEmailInterface() {
                alert('Email parents functionality would be displayed here.');
                // In a real implementation, this would load email interface
            }

            function showSettings() {
                alert('System settings would be displayed here.');
                // In a real implementation, this would load settings interface
            }

            function showHelp() {
                alert('Help center would be displayed here.');
                // In a real implementation, this would load help content
            }

            // Make functions available globally
            window.fetchStudentPerformance = fetchStudentPerformance;
            window.checkTableExists = checkTableExists;

            // Start initialization when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', loadUserData);
            } else {
                loadUserData();
            }

        })();
    </script>
</body>
</html>