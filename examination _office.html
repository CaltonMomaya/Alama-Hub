<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alama Hub - Examination Office</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Add jsPDF library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- Add Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Add SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Add html2canvas for capturing patterns -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- Add QR Code generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        :root {
            --primary-green: #075824;
            --secondary-green: #377437;
            --accent-green: #9BAE30;
            --muted-green: #5D8B70;
            --accent-blue: #333687;
            --background-light: #F4F4F4;
            --text-light: #FFFFFF;
            --sidebar-width: 280px;
            --card-shadow: 0 5px 20px rgba(0,0,0,0.08);
            --hover-shadow: 0 15px 30px rgba(0,0,0,0.12);
            --exam-office-purple: #01270d;
            --exam-office-blue: #1565C0;
            --exam-office-red: #C62828;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-light);
            color: #333;
            min-height: 100vh;
            display: flex;
            overflow-x: hidden;
        }

        /* Top Header with User Profile */
        .top-header {
            position: fixed;
            top: 0;
            right: 0;
            left: var(--sidebar-width);
            background-color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            z-index: 999;
            transition: left 0.3s ease;
        }

        .page-title h1 {
            color: var(--exam-office-purple);
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .page-title p {
            color: var(--muted-green);
            font-size: 0.9rem;
        }

        .user-profile-top {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 8px 15px;
            background-color: rgba(106, 27, 154, 0.05);
            border-radius: 50px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .user-profile-top:hover {
            background-color: rgba(106, 27, 154, 0.1);
        }

        .user-avatar-top {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--exam-office-purple), var(--accent-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            overflow: hidden;
            position: relative;
            border: 3px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        .user-avatar-top img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            cursor: pointer;
        }

        .profile-upload-overlay:hover {
            opacity: 1;
        }

        .user-info-top h4 {
            color: var(--exam-office-purple);
            font-size: 0.95rem;
            margin-bottom: 2px;
        }

        .user-info-top p {
            color: var(--muted-green);
            font-size: 0.8rem;
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 30px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            padding: 15px;
            min-width: 200px;
            display: none;
            z-index: 1001;
        }

        .user-dropdown.show {
            display: block;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            color: #555;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .dropdown-item:hover {
            background-color: rgba(106, 27, 154, 0.05);
            color: var(--exam-office-purple);
        }

        .dropdown-item i {
            margin-right: 10px;
            width: 20px;
        }

        /* Sidebar Header */
        .sidebar-header {
            background-color: var(--exam-office-purple);
            color: var(--text-light);
            padding: 25px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .badge-container {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-color: white;
            border: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
            margin: 0 auto 15px;
        }

        .school-badge {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 8px;
        }

        .badge-fallback {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--exam-office-purple);
            color: white;
            font-size: 28px;
        }

        .sidebar-title h1 {
            font-size: 1.8rem;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .sidebar-title h2 {
            font-size: 1rem;
            font-weight: 400;
            opacity: 0.9;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: var(--sidebar-width);
            background-color: white;
            box-shadow: 3px 0 15px rgba(0, 0, 0, 0.08);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1000;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .sidebar-nav {
            list-style: none;
            padding: 0;
        }

        .nav-section-title {
            padding: 20px 25px 10px;
            font-size: 0.85rem;
            color: var(--muted-green);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            border-bottom: 1px solid #eee;
            margin: 0 15px;
        }

        .nav-item {
            margin-bottom: 3px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 16px 25px;
            color: #555;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            position: relative;
        }

        .nav-link:hover {
            background-color: rgba(106, 27, 154, 0.05);
            color: var(--exam-office-purple);
            border-left-color: var(--accent-blue);
        }

        .nav-link.active {
            background-color: rgba(106, 27, 154, 0.1);
            color: var(--exam-office-purple);
            font-weight: 600;
            border-left-color: var(--exam-office-purple);
        }

        .nav-link i {
            margin-right: 15px;
            width: 22px;
            text-align: center;
            font-size: 1.2rem;
        }

        .nav-badge {
            background-color: var(--accent-blue);
            color: white;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: auto;
        }

        /* Main content area */
        .main-content {
            flex: 1;
            padding: 100px 40px 40px;
            margin-left: var(--sidebar-width);
            display: flex;
            flex-direction: column;
            transition: margin-left 0.3s ease;
            width: calc(100% - var(--sidebar-width));
        }

        .main-content h1 {
            color: var(--exam-office-purple);
            font-size: 2.5rem;
            margin-bottom: 15px;
            text-align: center;
            width: 100%;
        }

        .main-content p {
            max-width: 800px;
            line-height: 1.6;
            font-size: 1.1rem;
            margin-bottom: 30px;
            text-align: center;
        }

        /* Data display sections */
        .data-section {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto 40px;
        }

        .section-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(106, 27, 154, 0.1);
        }

        .section-title h2 {
            color: var(--exam-office-purple);
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title h2 i {
            color: var(--accent-blue);
        }

        .section-info {
            color: var(--muted-green);
            font-size: 1rem;
        }

        /* Data Cards Layout */
        .data-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .data-card {
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: none;
        }

        .data-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }

        .card-header {
            background: linear-gradient(135deg, var(--exam-office-purple), var(--exam-office-blue));
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .card-header i {
            font-size: 1.8rem;
        }

        .card-header h3 {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .card-body {
            padding: 25px;
            flex-grow: 1;
        }

        .card-footer {
            padding: 15px 25px;
            background-color: rgba(106, 27, 154, 0.03);
            border-top: 1px solid rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 30px;
            background-color: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            margin: 30px 0;
        }

        .empty-state i {
            font-size: 4rem;
            color: var(--muted-green);
            opacity: 0.3;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            color: var(--exam-office-purple);
            margin-bottom: 15px;
        }

        .empty-state p {
            max-width: 500px;
            margin: 0 auto;
            color: #666;
        }

        /* Action Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--exam-office-purple);
            color: white;
        }

        .btn-primary:hover {
            background-color: #7B1FA2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(106, 27, 154, 0.2);
        }

        .btn-secondary {
            background-color: var(--exam-office-blue);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #0D47A1;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(21, 101, 192, 0.2);
        }

        .btn-outline {
            background-color: transparent;
            color: var(--exam-office-purple);
            border: 2px solid var(--exam-office-purple);
        }

        .btn-outline:hover {
            background-color: rgba(106, 27, 154, 0.05);
        }

        .btn-danger {
            background-color: var(--exam-office-red);
            color: white;
        }

        .btn-danger:hover {
            background-color: #B71C1C;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(198, 40, 40, 0.2);
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background-color: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.2);
        }

        .btn-success {
            background-color: var(--primary-green);
            color: white;
        }

        .btn-success:hover {
            background-color: var(--secondary-green);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(7, 88, 36, 0.2);
        }

        /* Modal Styles */
        .exam-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .exam-modal.show {
            display: flex;
        }

        .exam-modal-content {
            background-color: white;
            width: 90%;
            max-width: 1400px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: modalFadeIn 0.3s ease;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .exam-modal-header {
            background: linear-gradient(135deg, var(--exam-office-purple), var(--exam-office-blue));
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .exam-modal-header h3 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .exam-modal-body {
            padding: 30px;
            flex-grow: 1;
            overflow-y: auto;
            max-height: calc(90vh - 70px);
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .view-btn {
            padding: 8px 20px;
            border: 1px solid var(--exam-office-purple);
            background: white;
            color: var(--exam-office-purple);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-btn.active {
            background: var(--exam-office-purple);
            color: white;
        }

        .view-btn:hover {
            transform: translateY(-2px);
        }

        /* Excel-like Table */
        .excel-table-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            width: 100%;
            position: relative;
        }

        .excel-table-wrapper {
            overflow-x: auto;
            max-height: 60vh;
            width: 100%;
            position: relative;
        }

        .excel-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 100%;
            table-layout: auto;
            font-size: 0.9rem;
        }

        .excel-table th {
            background-color: var(--exam-office-purple);
            color: white;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            border-right: 1px solid rgba(255,255,255,0.2);
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            min-width: 120px;
            font-size: 0.9rem;
        }

        .excel-table th:last-child {
            border-right: none;
        }

        .excel-table td {
            padding: 10px;
            border: 1px solid #e0e0e0;
            transition: background-color 0.2s ease;
            background-color: white;
            vertical-align: middle;
            height: 45px;
            white-space: nowrap;
            min-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.9rem;
        }

        .excel-table tr:nth-child(even) td {
            background-color: #f9f9f9;
        }

        .excel-table tr:hover td {
            background-color: rgba(106, 27, 154, 0.05);
        }

        .excel-table .fixed-column {
            position: sticky;
            left: 0;
            background-color: white;
            z-index: 5;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .excel-table .fixed-column-header {
            position: sticky;
            left: 0;
            background-color: var(--exam-office-purple);
            z-index: 15;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .pagination-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            color: var(--exam-office-purple);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover {
            background: var(--exam-office-purple);
            color: white;
        }

        .pagination-btn.active {
            background: var(--exam-office-purple);
            color: white;
            border-color: var(--exam-office-purple);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-info {
            color: #666;
            font-size: 0.9rem;
        }

        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-size-selector select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* Form Groups */
        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--exam-office-purple);
            font-weight: 600;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(51, 54, 135, 0.1);
        }

        /* Manual year input style */
        .year-input-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .year-input-container input {
            text-align: center;
            letter-spacing: 2px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .year-separator {
            font-size: 1.5rem;
            color: var(--exam-office-purple);
            font-weight: bold;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(106, 27, 154, 0.1);
            border-radius: 50%;
            border-top-color: var(--exam-office-purple);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Chart Containers */
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
            position: relative;
        }

        .chart-container h3 {
            color: var(--exam-office-purple);
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        /* Report Card Preview */
        .report-card-preview {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
            position: relative;
            border: 2px solid transparent;
            background-image: 
                linear-gradient(white, white),
                linear-gradient(45deg, var(--exam-office-purple) 25%, transparent 25%),
                linear-gradient(-45deg, var(--exam-office-purple) 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, var(--exam-office-purple) 75%),
                linear-gradient(-45deg, transparent 75%, var(--exam-office-purple) 75%);
            background-size: 100% 100%, 20px 20px, 20px 20px, 20px 20px, 20px 20px;
            background-position: 0 0, 0 0, 10px 0, 10px -10px, 0px 10px;
            background-clip: padding-box, border-box, border-box, border-box, border-box;
        }

        .report-card-header {
            background: linear-gradient(135deg, var(--exam-office-purple), var(--exam-office-blue));
            color: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 25px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .report-card-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        .report-card-body {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .report-card-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid var(--accent-blue);
        }

        .security-features {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .security-features h4 {
            color: var(--exam-office-purple);
            margin-bottom: 10px;
        }

        .qr-code-container {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
        }

        /* Email Template Preview */
        .email-preview {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
            border: 1px solid #e0e0e0;
        }

        .email-header {
            background: linear-gradient(135deg, var(--exam-office-purple), var(--exam-office-blue));
            color: white;
            padding: 25px;
            border-radius: 8px 8px 0 0;
            margin: -30px -30px 30px -30px;
        }

        .email-body {
            line-height: 1.8;
            color: #333;
        }

        /* Analysis Cards */
        .analysis-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .analysis-card {
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            padding: 25px;
            transition: all 0.3s ease;
        }

        .analysis-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }

        .analysis-card h3 {
            color: var(--exam-office-purple);
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .analysis-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--exam-office-blue);
            margin: 15px 0;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--hover-shadow);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--exam-office-purple);
            margin: 10px 0;
        }

        .stat-label {
            color: var(--muted-green);
            font-size: 0.9rem;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 30px 20px;
            color: var(--muted-green);
            font-size: 0.9rem;
            margin-top: 60px;
            width: 100%;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            background: white;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .footer p {
            max-width: 800px;
            width: 100%;
            text-align: center;
            line-height: 1.5;
            margin: 0 auto 15px;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
            flex-wrap: wrap;
            max-width: 800px;
            width: 100%;
        }

        .footer a {
            color: var(--accent-blue);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer a:hover {
            color: var(--exam-office-purple);
            text-decoration: underline;
        }

        /* Hamburger menu for mobile */
        .hamburger {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1100;
            background-color: var(--exam-office-purple);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 100px 20px 40px;
                width: 100%;
            }

            .top-header {
                left: 0;
            }

            .hamburger {
                display: flex;
            }
            
            .data-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .analysis-cards {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                max-width: 320px;
            }

            .main-content h1 {
                font-size: 2rem;
            }

            .top-header {
                padding: 15px 20px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .user-profile-top {
                align-self: flex-end;
                margin-top: 10px;
            }

            .user-info-top h4 {
                font-size: 0.9rem;
            }

            .user-info-top p {
                font-size: 0.75rem;
            }
            
            .data-cards {
                grid-template-columns: 1fr;
            }
            
            .section-title {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 120px 15px 30px;
            }

            .user-info-top {
                display: none;
            }
            
            .footer-links {
                flex-direction: column;
                gap: 10px;
            }
            
            .exam-modal-content {
                width: 95%;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .view-toggle {
                flex-direction: column;
            }
            
            .view-btn {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- Hamburger Menu for Mobile -->
    <div class="hamburger" id="hamburger">
        <i class="fas fa-bars"></i>
    </div>

    <!-- Top Header with User Profile -->
    <div class="top-header" id="topHeader">
        <div class="page-title">
            <h1 id="pageTitle">Examination Office Dashboard</h1>
            <p id="pageSubtitle">Alliance Girls High School - Comprehensive Academic Oversight</p>
        </div>
        
        <div class="user-profile-top" id="userProfileTop">
            <div class="user-avatar-top" id="userAvatar">
                <!-- Profile image will be dynamically added here -->
            </div>
            <div class="user-info-top">
                <h4 id="userName">Loading...</h4>
                <p id="userRole">Examination Officer</p>
                <p id="userId">ID: Loading...</p>
            </div>
            <i class="fas fa-chevron-down" id="dropdownArrow"></i>
        </div>
        
        <!-- User Dropdown Menu -->
        <div class="user-dropdown" id="userDropdown">
            <a href="#" class="dropdown-item" id="editProfileLink">
                <i class="fas fa-user-edit"></i> Edit Profile
            </a>
            <a href="#" class="dropdown-item" id="changePasswordLink">
                <i class="fas fa-key"></i> Change Password
            </a>
            <a href="#" class="dropdown-item">
                <i class="fas fa-cog"></i> Settings
            </a>
            <a href="#" class="dropdown-item">
                <i class="fas fa-question-circle"></i> Help & Support
            </a>
            <div style="height: 1px; background-color: #eee; margin: 10px 0;"></div>
            <a href="#" class="dropdown-item" id="logoutLink">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </div>

    <!-- Cloud Access Modal -->
    <div class="exam-modal" id="compileResultsModal">
        <div class="exam-modal-content">
            <div class="exam-modal-header">
                <h3><i class="fas fa-cloud"></i> Cloud Access - Examination Results</h3>
                <button class="modal-close" id="compileModalClose">&times;</button>
            </div>
            <div class="exam-modal-body">
                <div class="view-toggle" id="compileViewToggle">
                    <button class="view-btn active" data-view="cloud">Cloud Data</button>
                    <button class="view-btn" data-view="analysis">Advanced Analysis</button>
                </div>
                
                <div id="compileFiltersSection" style="display: block;">
                    <div style="margin-bottom: 30px; text-align: center;">
                        <i class="fas fa-cloud" style="font-size: 4rem; color: var(--exam-office-blue); margin-bottom: 20px;"></i>
                        <h3 style="color: var(--exam-office-purple); margin-bottom: 10px;">Cloud Data Access</h3>
                        <p style="color: #666; max-width: 800px; margin: 0 auto;">Access all examination data stored in the cloud database. View, filter, and export results with real-time synchronization.</p>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <button class="btn btn-primary" id="accessCloudBtn" style="display: block; margin: 0 auto; padding: 15px 40px; font-size: 1.1rem;">
                            <i class="fas fa-cloud-download-alt"></i> Access Cloud Data
                        </button>
                    </div>
                </div>
                
                <div id="compilePreviewSection" style="display: none;">
                    <div class="table-actions" style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div class="table-info" style="flex: 1; min-width: 300px;">
                            <div style="background: #f8f9fa; padding: 12px 15px; border-radius: 8px; border-left: 4px solid var(--exam-office-blue);">
                                <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                                    <div><strong>Academic Year:</strong> <span id="previewAcademicYear">All Years</span></div>
                                    <div><strong>Exam Type:</strong> <span id="previewExamType">All</span></div>
                                    <div><strong>Grade:</strong> <span id="previewForm">All</span></div>
                                    <div><strong>Stream:</strong> <span id="previewStream">All</span></div>
                                    <div><strong>Records:</strong> <span id="previewRecordCount">0</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="action-buttons" style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <!-- NEW FILTER & COMPUTE BUTTON ADDED HERE -->
                            <button class="btn btn-warning" id="filterComputeBtn">
                                <i class="fas fa-filter"></i> Filter & Compute
                            </button>
                            <button class="btn btn-primary" id="exportResultsBtn">
                                <i class="fas fa-file-excel"></i> Export Excel
                            </button>
                            <button class="btn btn-secondary" id="exportPdfBtn">
                                <i class="fas fa-file-pdf"></i> Export PDF
                            </button>
                            <button class="btn btn-outline" id="analysisBtn">
                                <i class="fas fa-chart-pie"></i> Analysis
                            </button>
                            <button class="btn btn-outline" id="backToCloudBtn">
                                <i class="fas fa-arrow-left"></i> Back
                            </button>
                        </div>
                    </div>
                    
                    <!-- NEW FILTER FORM SECTION ADDED HERE -->
                    <div id="filterFormSection" style="display: none; background: white; padding: 20px; border-radius: 12px; box-shadow: var(--card-shadow); margin-bottom: 20px;">
                        <h3 style="color: var(--exam-office-purple); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-filter"></i> Filter & Compute Data
                        </h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label><i class="fas fa-users"></i> Grade</label>
                                <select id="filterGrade" class="form-control">
                                    <option value="">All Grades</option>
                                    <option value="grade_10">grade_10</option>
                                    <option value="grade_11">grade_11</option>
                                    <option value="grade_12">grade_12</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label><i class="fas fa-stream"></i> Stream</label>
                                <select id="filterStream" class="form-control">
                                    <option value="">All Streams</option>
                                    <!-- Streams will be dynamically populated -->
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label><i class="fas fa-file-alt"></i> Exam Type</label>
                                <select id="filterExamType" class="form-control">
                                    <option value="">All Exam Types</option>
                                    <option value="Opener">Opener Exam</option>
                                    <option value="Midterm">Midterm Exam</option>
                                    <option value="Endterm">Endterm Exam</option>
                                    <option value="CAT">CAT</option>
                                    <option value="Assignment">Assignment</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label><i class="fas fa-calendar"></i> Term</label>
                                <select id="filterTerm" class="form-control">
                                    <option value="">All Terms</option>
                                    <option value="Term 1">Term 1</option>
                                    <option value="Term 2">Term 2</option>
                                    <option value="Term 3">Term 3</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label><i class="fas fa-calendar-alt"></i> Academic Year</label>
                                <select id="filterYear" class="form-control">
                                    <option value="">All Years</option>
                                    <!-- Years will be dynamically populated -->
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label><i class="fas fa-user-check"></i> Recorded By</label>
                                <select id="filterRecordedBy" class="form-control">
                                    <option value="">All Teachers</option>
                                    <!-- Teachers will be dynamically populated -->
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
                            <button class="btn btn-primary" id="applyFilterBtn">
                                <i class="fas fa-check"></i> Apply Filters
                            </button>
                            <button class="btn btn-outline" id="clearFilterBtn">
                                <i class="fas fa-times"></i> Clear Filters
                            </button>
                            <button class="btn btn-success" id="computeAggregatesBtn">
                                <i class="fas fa-calculator"></i> Compute Aggregates
                            </button>
                        </div>
                    </div>
                    
                    <!-- NEW COMPUTATION RESULTS SECTION ADDED HERE -->
                    <div id="computationResultsSection" style="display: none; background: white; padding: 20px; border-radius: 12px; box-shadow: var(--card-shadow); margin-bottom: 20px;">
                        <h3 style="color: var(--exam-office-purple); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-calculator"></i> Computation Results
                        </h3>
                        
                        <div class="stats-grid" id="computationResultsGrid">
                            <!-- Computation results will be dynamically added here -->
                        </div>
                        
                        <div style="margin-top: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
                            <button class="btn btn-secondary" id="exportComputationResultsBtn">
                                <i class="fas fa-download"></i> Export Computation Results
                            </button>
                            <button class="btn btn-outline" id="backToFiltersBtn">
                                <i class="fas fa-arrow-left"></i> Back to Filters
                            </button>
                        </div>
                    </div>
                    
                    <!-- Pagination Controls -->
                    <div class="pagination" id="paginationControls" style="display: none;">
                        <button class="pagination-btn" id="prevBtn">
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        
                        <div id="pageNumbers" style="display: flex; gap: 5px;"></div>
                        
                        <button class="pagination-btn" id="nextBtn">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                        
                        <div class="page-info" id="pageInfo">Page 1 of 1</div>
                        
                        <div class="page-size-selector">
                            <span>Show:</span>
                            <select id="pageSize">
                                <option value="50">50</option>
                                <option value="100" selected>100</option>
                                <option value="200">200</option>
                                <option value="500">500</option>
                            </select>
                            <span>records</span>
                        </div>
                    </div>
                    
                    <div class="excel-table-container">
                        <div class="excel-table-wrapper">
                            <table class="excel-table" id="resultsTable">
                                <thead id="resultsTableHeader">
                                    <!-- Table header will be dynamically generated -->
                                </thead>
                                <tbody id="resultsTableBody">
                                    <!-- Results will be dynamically generated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Pagination Controls (bottom) -->
                    <div class="pagination" id="paginationControlsBottom" style="display: none; margin-top: 20px;">
                        <button class="pagination-btn" id="prevBtnBottom">
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        
                        <div id="pageNumbersBottom" style="display: flex; gap: 5px;"></div>
                        
                        <button class="pagination-btn" id="nextBtnBottom">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                        
                        <div class="page-info" id="pageInfoBottom">Page 1 of 1</div>
                    </div>
                </div>
                
                <div id="compileAnalysisSection" style="display: none;">
                    <div class="chart-container">
                        <h3><i class="fas fa-chart-line"></i> Performance Distribution</h3>
                        <canvas id="performanceChart" height="100"></canvas>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Overall Mean</div>
                            <div class="stat-value" id="overallMean">0.00</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Standard Deviation</div>
                            <div class="stat-value" id="stdDev">0.00</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Top 10% Average</div>
                            <div class="stat-value" id="top10Avg">0.00</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Bottom 10% Average</div>
                            <div class="stat-value" id="bottom10Avg">0.00</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; display: flex; gap: 15px;">
                        <button class="btn btn-primary" id="generateReportBtn">
                            <i class="fas fa-file-pdf"></i> Generate Statistical Report
                        </button>
                        <button class="btn btn-outline" id="backToDataBtn">
                            <i class="fas fa-arrow-left"></i> Back to Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Generate Report Cards Modal -->
    <div class="exam-modal" id="reportCardsModal">
        <div class="exam-modal-content">
            <div class="exam-modal-header">
                <h3><i class="fas fa-file-certificate"></i> Generate Report Cards</h3>
                <button class="modal-close" id="reportCardsModalClose">&times;</button>
            </div>
            <div class="exam-modal-body">
                <div class="view-toggle" id="reportCardsViewToggle">
                    <button class="view-btn active" data-view="selection">Select Students</button>
                    <button class="view-btn" data-view="template">Design Template</button>
                    <button class="view-btn" data-view="preview">Preview Report</button>
                    <button class="view-btn" data-view="security">Security Features</button>
                </div>
                
                <div id="reportCardsSelectionSection">
                    <div class="form-group">
                        <label><i class="fas fa-calendar"></i> Academic Year</label>
                        <div class="year-input-container">
                            <input type="text" id="reportAcademicYear1" class="form-control" maxlength="4" placeholder="YYYY" style="width: 100px; text-align: center;">
                            <span class="year-separator">-</span>
                            <input type="text" id="reportAcademicYear2" class="form-control" maxlength="4" placeholder="YYYY" style="width: 100px; text-align: center;">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-graduation-cap"></i> Term</label>
                        <select id="reportTerm" class="form-control">
                            <option value="Opener Term 1">Opener Term 1</option>
                            <option value="Mid Term 1">Mid Term 1</option>
                            <option value="End Term 1">End Term 1</option>
                            <option value="Opener Term 2">Opener Term 2</option>
                            <option value="Mid Term 2">Mid Term 2</option>
                            <option value="End Term 2">End Term 2</option>
                            <option value="Opener Term 3">Opener Term 3</option>
                            <option value="Mid Term 3">Mid Term 3</option>
                            <option value="End Term 3">End Term 3</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-users"></i> Grade</label>
                        <select id="reportForm" class="form-control">
                            <option value="">All Grades</option>
                            <option value="Grade_10">Grade_10</option>
                            <option value="Grade 11">Grade 11</option>
                            <option value="Grade 12">Grade 12</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-user-check"></i> Student Selection</label>
                        <div style="margin-top: 10px;">
                            <label style="display: flex; align-items: center; gap: 5px; margin-bottom: 10px;">
                                <input type="radio" name="studentSelection" value="all" checked> All Students
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; margin-bottom: 10px;">
                                <input type="radio" name="studentSelection" value="stream"> By Stream
                                <select id="reportStream" class="form-control" style="width: 200px; margin-left: 10px;">
                                    <!-- Streams will be dynamically populated -->
                                </select>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="studentSelection" value="range"> By Admission Range
                                <input type="number" id="reportFromAdm" placeholder="From" class="form-control" style="width: 100px; margin-left: 10px;">
                                <input type="number" id="reportToAdm" placeholder="To" class="form-control" style="width: 100px; margin-left: 5px;">
                            </label>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <button class="btn btn-primary" id="loadStudentsBtn">
                            <i class="fas fa-search"></i> Load Students
                        </button>
                        <button class="btn btn-outline" id="continueToTemplateBtn">
                            <i class="fas fa-forward"></i> Continue to Template
                        </button>
                    </div>
                </div>
                
                <div id="reportCardsTemplateSection" style="display: none;">
                    <div class="form-group">
                        <label><i class="fas fa-palette"></i> Report Card Template</label>
                        <select id="reportTemplate" class="form-control">
                            <option value="standard">Standard Template</option>
                            <option value="detailed">Detailed Template</option>
                            <option value="premium">Premium Security Template</option>
                            <option value="custom">Custom Template</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-cogs"></i> Customization Options</label>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="includeQR" checked> Include QR Code
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="includePatterns" checked> Include Security Patterns
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="includeComments" checked> Include Teacher Comments
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="includeGraphs" checked> Include Performance Graphs
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="includeRank" checked> Include Class Rank
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="includeWatermark" checked> Include School Watermark
                            </label>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; display: flex; gap: 15px;">
                        <button class="btn btn-primary" id="previewReportBtn">
                            <i class="fas fa-eye"></i> Preview Report Card
                        </button>
                        <button class="btn btn-outline" id="backToSelectionBtn">
                            <i class="fas fa-arrow-left"></i> Back to Selection
                        </button>
                    </div>
                </div>
                
                <div id="reportCardsPreviewSection" style="display: none;">
                    <div class="report-card-preview" id="reportCardPreview">
                        <!-- Report card preview will be generated here -->
                    </div>
                    
                    <div style="margin-top: 30px; display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="btn btn-primary" id="generateAllReportsBtn">
                            <i class="fas fa-print"></i> Generate All Report Cards
                        </button>
                        <button class="btn btn-secondary" id="downloadSampleBtn">
                            <i class="fas fa-download"></i> Download Sample
                        </button>
                        <button class="btn btn-outline" id="securityFeaturesBtn">
                            <i class="fas fa-shield-alt"></i> Security Features
                        </button>
                        <button class="btn btn-outline" id="backToTemplateBtn">
                            <i class="fas fa-arrow-left"></i> Back to Template
                        </button>
                    </div>
                </div>
                
                <div id="reportCardsSecuritySection" style="display: none;">
                    <div class="security-features">
                        <h4><i class="fas fa-shield-alt"></i> Anti-Forgery Security Features</h4>
                        <ul style="margin-top: 15px; padding-left: 20px; line-height: 1.8;">
                            <li><strong>Micro-text Patterns:</strong> Invisible text patterns embedded in background</li>
                            <li><strong>Holographic QR Codes:</strong> QR codes that change appearance at different angles</li>
                            <li><strong>UV-reactive Ink Patterns:</strong> Visible only under UV light</li>
                            <li><strong>Unique Serial Numbers:</strong> Each report card has a unique verifiable serial</li>
                            <li><strong>Digital Signature:</strong> Cryptographic signature for online verification</li>
                            <li><strong>Pattern Watermarks:</strong> Complex geometric patterns unique to each student</li>
                            <li><strong>Heat-sensitive Elements:</strong> Elements that disappear/reappear with temperature changes</li>
                            <li><strong>Layered Security:</strong> Multiple overlapping security layers</li>
                        </ul>
                    </div>
                    
                    <div style="margin-top: 30px; display: flex; gap: 15px;">
                        <button class="btn btn-primary" id="applySecurityBtn">
                            <i class="fas fa-lock"></i> Apply Security Features
                        </button>
                        <button class="btn btn-outline" id="backToPreviewBtn">
                            <i class="fas fa-arrow-left"></i> Back to Preview
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Parents Modal -->
    <div class="exam-modal" id="emailParentsModal">
        <div class="exam-modal-content">
            <div class="exam-modal-header">
                <h3><i class="fas fa-envelope"></i> Email Parents/Guardians</h3>
                <button class="modal-close" id="emailModalClose">&times;</button>
            </div>
            <div class="exam-modal-body">
                <div class="view-toggle" id="emailViewToggle">
                    <button class="view-btn active" data-view="recipients">Select Recipients</button>
                    <button class="view-btn" data-view="template">Email Template</button>
                    <button class="view-btn" data-view="preview">Preview & Send</button>
                </div>
                
                <div id="emailRecipientsSection">
                    <div class="form-group">
                        <label><i class="fas fa-users"></i> Recipient Selection</label>
                        <div style="margin-top: 10px;">
                            <label style="display: flex; align-items: center; gap: 5px; margin-bottom: 10px;">
                                <input type="radio" name="emailRecipients" value="all" checked> All Parents/Guardians
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; margin-bottom: 10px;">
                                <input type="radio" name="emailRecipients" value="grade"> By Grade
                                <select id="emailGrade" class="form-control" style="width: 200px; margin-left: 10px;">
                                    <option value="grade_10">grade_10</option>
                                    <option value="Grade 11">Grade 11</option>
                                    <option value="Grade 12">Grade 12</option>
                                </select>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; margin-bottom: 10px;">
                                <input type="radio" name="emailRecipients" value="stream"> By Stream
                                <select id="emailStream" class="form-control" style="width: 200px; margin-left: 10px;">
                                    <!-- Streams will be dynamically populated -->
                                </select>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="emailRecipients" value="performance"> By Performance
                                <select id="emailPerformance" class="form-control" style="width: 200px; margin-left: 10px;">
                                    <option value="top10">Top 10% Performers</option>
                                    <option value="bottom10">Bottom 10% Performers</option>
                                    <option value="improved">Most Improved</option>
                                    <option value="declined">Performance Declined</option>
                                </select>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-paperclip"></i> Attachments</label>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 10px;">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="attachReportCard"> Report Card (PDF)
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="attachProgressGraph"> Progress Graph
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="attachComments"> Teacher Comments
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" id="attachSchoolCalendar"> School Calendar
                            </label>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <button class="btn btn-primary" id="loadRecipientsBtn">
                            <i class="fas fa-search"></i> Load Recipients
                        </button>
                        <button class="btn btn-outline" id="continueToTemplateBtn2">
                            <i class="fas fa-forward"></i> Continue to Template
                        </button>
                    </div>
                </div>
                
                <div id="emailTemplateSection" style="display: none;">
                    <div class="form-group">
                        <label><i class="fas fa-envelope-open-text"></i> Email Template</label>
                        <select id="emailTemplateSelect" class="form-control">
                            <option value="results">Exam Results Notification</option>
                            <option value="progress">Progress Report</option>
                            <option value="warning">Performance Warning</option>
                            <option value="congratulations">Congratulations (Top Performers)</option>
                            <option value="meeting">Parent-Teacher Meeting</option>
                            <option value="custom">Custom Message</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-edit"></i> Subject</label>
                        <input type="text" id="emailSubject" class="form-control" value="Exam Results Notification - Alliance Girls High School">
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-align-left"></i> Message Body</label>
                        <textarea id="emailBody" class="form-control" rows="10" style="font-family: monospace;">
Dear Parent/Guardian,

We are pleased to share the examination results for your child, [STUDENT_NAME], for [TERM] [ACADEMIC_YEAR].

Overall Performance: [OVERALL_GRADE]
Class Rank: [CLASS_RANK]/[TOTAL_STUDENTS]
Average Score: [AVERAGE_SCORE]%

Key Highlights:
- Best Subject: [BEST_SUBJECT] ([BEST_SCORE]%)
- Needs Improvement: [WEAK_SUBJECT] ([WEAK_SCORE]%)
- Attendance: [ATTENDANCE]%

Please find attached the detailed report card. We encourage you to discuss these results with your child and celebrate their achievements while identifying areas for improvement.

For any queries or to schedule a meeting with teachers, please contact the examination office.

Best regards,
Examination Office
Alliance Girls High School
                        </textarea>
                    </div>
                    
                    <div style="margin-top: 30px; display: flex; gap: 15px;">
                        <button class="btn btn-primary" id="previewEmailBtn">
                            <i class="fas fa-eye"></i> Preview Email
                        </button>
                        <button class="btn btn-outline" id="backToRecipientsBtn">
                            <i class="fas fa-arrow-left"></i> Back to Recipients
                        </button>
                    </div>
                </div>
                
                <div id="emailPreviewSection" style="display: none;">
                    <div class="email-preview" id="emailPreview">
                        <!-- Email preview will be generated here -->
                    </div>
                    
                    <div class="form-group" style="margin-top: 30px;">
                        <label><i class="fas fa-paper-plane"></i> Send Options</label>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 10px;">
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="sendOption" value="immediate" checked> Send Immediately
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="sendOption" value="schedule"> Schedule for
                                <input type="datetime-local" id="scheduleTime" class="form-control" style="width: 200px; margin-left: 10px;">
                            </label>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="btn btn-primary" id="sendEmailsBtn">
                            <i class="fas fa-paper-plane"></i> Send Emails
                        </button>
                        <button class="btn btn-secondary" id="testEmailBtn">
                            <i class="fas fa-vial"></i> Send Test Email
                        </button>
                        <button class="btn btn-outline" id="backToTemplateBtn2">
                            <i class="fas fa-arrow-left"></i> Back to Template
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Analysis Modal -->
    <div class="exam-modal" id="advancedAnalysisModal">
        <div class="exam-modal-content" style="max-width: 1400px;">
            <div class="exam-modal-header">
                <h3><i class="fas fa-brain"></i> Advanced Academic Analysis</h3>
                <button class="modal-close" id="analysisModalClose">&times;</button>
            </div>
            <div class="exam-modal-body">
                <div class="view-toggle" id="analysisViewToggle">
                    <button class="view-btn active" data-view="predictive">Predictive Analytics</button>
                    <button class="view-btn" data-view="correlation">Correlation Analysis</button>
                    <button class="view-btn" data-view="trend">Trend Analysis</button>
                    <button class="view-btn" data-view="anomaly">Anomaly Detection</button>
                </div>
                
                <div id="predictiveAnalysisSection">
                    <div class="form-group">
                        <label><i class="fas fa-crystal-ball"></i> Prediction Parameters</label>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 10px;">
                            <div>
                                <label>Student/Grade</label>
                                <select id="predictStudent" class="form-control">
                                    <option value="">Select Student (Optional)</option>
                                </select>
                            </div>
                            <div>
                                <label>Prediction Type</label>
                                <select id="predictionType" class="form-control">
                                    <option value="final_exam">Final Exam Performance</option>
                                    <option value="university_admission">University Admission Chance</option>
                                    <option value="subject_improvement">Subject Improvement Potential</option>
                                    <option value="overall_trend">Overall Academic Trend</option>
                                </select>
                            </div>
                            <div>
                                <label>Time Frame</label>
                                <select id="predictionTime" class="form-control">
                                    <option value="1">Next Term</option>
                                    <option value="2">Next 2 Terms</option>
                                    <option value="4">Next Year</option>
                                    <option value="8">Next 2 Years</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3><i class="fas fa-chart-line"></i> Performance Prediction</h3>
                        <canvas id="predictionChart" height="100"></canvas>
                    </div>
                    
                    <div class="analysis-cards">
                        <div class="analysis-card">
                            <h3><i class="fas fa-bullseye"></i> Prediction Accuracy</h3>
                            <div class="analysis-value" id="predictionAccuracy">87%</div>
                            <p>Based on historical data patterns and machine learning algorithms</p>
                        </div>
                        <div class="analysis-card">
                            <h3><i class="fas fa-exclamation-triangle"></i> Risk Factors Identified</h3>
                            <div class="analysis-value" id="riskFactors">3</div>
                            <p>Key areas requiring attention for optimal performance</p>
                        </div>
                        <div class="analysis-card">
                            <h3><i class="fas fa-rocket"></i> Improvement Potential</h3>
                            <div class="analysis-value" id="improvementPotential">+15%</div>
                            <p>Maximum achievable improvement with targeted interventions</p>
                        </div>
                    </div>
                </div>
                
                <div id="correlationAnalysisSection" style="display: none;">
                    <div class="chart-container">
                        <h3><i class="fas fa-project-diagram"></i> Subject Correlation Matrix</h3>
                        <canvas id="correlationChart" height="100"></canvas>
                    </div>
                    
                    <div class="analysis-cards">
                        <div class="analysis-card">
                            <h3><i class="fas fa-link"></i> Strongest Correlation</h3>
                            <div class="analysis-value" id="strongestCorrelation">Math-Physics</div>
                            <p>Correlation coefficient: 0.89</p>
                        </div>
                        <div class="analysis-card">
                            <h3><i class="fas fa-unlink"></i> Weakest Correlation</h3>
                            <div class="analysis-value" id="weakestCorrelation">Art-Chemistry</div>
                            <p>Correlation coefficient: 0.12</p>
                        </div>
                        <div class="analysis-card">
                            <h3><i class="fas fa-lightbulb"></i> Key Insight</h3>
                            <p>Students strong in Mathematics tend to perform well in Physics and Chemistry, suggesting transferable analytical skills.</p>
                        </div>
                    </div>
                </div>
                
                <div id="trendAnalysisSection" style="display: none;">
                    <div class="chart-container">
                        <h3><i class="fas fa-chart-area"></i> Performance Trends Over Time</h3>
                        <canvas id="trendChart" height="100"></canvas>
                    </div>
                    
                    <div class="analysis-cards">
                        <div class="analysis-card">
                            <h3><i class="fas fa-arrow-up"></i> Upward Trend</h3>
                            <div class="analysis-value" id="upwardTrend">42%</div>
                            <p>Percentage of students showing consistent improvement</p>
                        </div>
                        <div class="analysis-card">
                            <h3><i class="fas fa-arrow-down"></i> Downward Trend</h3>
                            <div class="analysis-value" id="downwardTrend">18%</div>
                            <p>Percentage of students showing consistent decline</p>
                        </div>
                        <div class="analysis-card">
                            <h3><i class="fas fa-wave-square"></i> Stable Performance</h3>
                            <div class="analysis-value" id="stableTrend">40%</div>
                            <p>Percentage of students maintaining consistent performance</p>
                        </div>
                    </div>
                </div>
                
                <div id="anomalyDetectionSection" style="display: none;">
                    <div class="chart-container">
                        <h3><i class="fas fa-radar"></i> Anomaly Detection Results</h3>
                        <canvas id="anomalyChart" height="100"></canvas>
                    </div>
                    
                    <div class="excel-table-container" style="max-height: 300px;">
                        <table class="excel-table" id="anomalyTable">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Anomaly Type</th>
                                    <th>Confidence</th>
                                    <th>Suggested Action</th>
                                </tr>
                            </thead>
                            <tbody id="anomalyTableBody">
                                <!-- Anomaly data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <button class="btn btn-primary" id="generateAnomalyReportBtn">
                            <i class="fas fa-file-medical-alt"></i> Generate Anomaly Report
                        </button>
                        <button class="btn btn-secondary" id="exportAnomalyDataBtn">
                            <i class="fas fa-download"></i> Export Anomaly Data
                        </button>
                        </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Left Navigation Pane -->
    <div class="sidebar" id="sidebar">
        <!-- Sidebar Header -->
        <div class="sidebar-header">
            <div class="badge-container">
                <img src="images/badge.png" alt="Alliance Girls High School Badge" class="school-badge" onerror="this.style.display='none'; document.querySelector('.badge-fallback').style.display='flex';">
                <div class="badge-fallback" style="display: none;">
                    <i class="fas fa-graduation-cap"></i>
                </div>
            </div>
            <div class="sidebar-title">
                <h1>Alama Hub</h1>
                <h2>Examination Office</h2>
            </div>
        </div>

        <!-- Navigation Menu -->
        <ul class="sidebar-nav">
            <li class="nav-section-title">Core Functions</li>
            <li class="nav-item">
                <a href="#" class="nav-link active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" id="compileResultsLink" data-section="compile">
                    <i class="fas fa-cloud"></i> Cloud Access
                    <span class="nav-badge" id="pendingResults">0</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" id="reportCardsLink" data-section="reports">
                    <i class="fas fa-file-certificate"></i> Report Cards
                    <span class="nav-badge" id="pendingReports">0</span>
                </a>
            </li>
            
            <li class="nav-section-title">Communication</li>
            <li class="nav-item">
                <a href="#" class="nav-link" id="emailParentsLink" data-section="email">
                    <i class="fas fa-envelope"></i> Email Parents
                    <span class="nav-badge" id="pendingEmails">0</span>
                </a>
            </li>
            
            <li class="nav-section-title">Advanced Analysis</li>
            <li class="nav-item">
                <a href="#" class="nav-link" id="advancedAnalysisLink" data-section="analysis">
                    <i class="fas fa-brain"></i> Advanced Analysis
                    <span class="nav-badge">AI</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" data-section="trends">
                    <i class="fas fa-chart-line"></i> Performance Trends
                </a>
            </li>
            
            <li class="nav-section-title">Management</li>
            <li class="nav-item">
                <a href="#" class="nav-link" data-section="teachers">
                    <i class="fas fa-chalkboard-teacher"></i> Teacher Performance
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" data-section="validation">
                    <i class="fas fa-check-double"></i> Data Validation
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link" data-section="audit">
                    <i class="fas fa-clipboard-check"></i> Audit Trail
                </a>
            </li>
            
            <li class="nav-section-title">Account</li>
            <li class="nav-item">
                <a href="#" class="nav-link" data-section="settings">
                    <i class="fas fa-cog"></i> Settings
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link logout-sidebar">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </li>
        </ul>
    </div>

    <!-- Main Content Area -->
    <div class="main-content" id="mainContent">
        <!-- Content will be dynamically loaded here -->
    </div>

    <script>
        // Initialize Examination Office Dashboard
        (function() {
            // Prevent multiple initializations
            if (window.examOfficeInitialized) return;
            window.examOfficeInitialized = true;
            
            console.log('Initializing Examination Office Dashboard...');
            
            // Initialize Supabase client
            let supabase;
            let currentUser = null;
            let userId = null;
            let userRole = 'Examination Officer';
            
            try {
                const supabaseUrl = 'https://eloqizcahwxavsbalxii.supabase.co';
                const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVsb3FpemNhaHd4YXZzYmFseGlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTQ4OTUsImV4cCI6MjA4MzI5MDg5NX0.SGogIbdShzCLv2TovpdS1BDf6GJx4mu0iz9s25BGRRQ';
                
                supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
                console.log('Supabase client initialized for Examination Office');
            } catch (error) {
                console.error('Failed to initialize Supabase:', error);
                alert('Failed to initialize Examination Office dashboard. Please refresh the page.');
                return;
            }

            // DOM Elements
            const hamburger = document.getElementById('hamburger');
            const sidebar = document.getElementById('sidebar');
            const navLinks = document.querySelectorAll('.nav-link');
            const userProfileTop = document.getElementById('userProfileTop');
            const userDropdown = document.getElementById('userDropdown');
            const dropdownArrow = document.getElementById('dropdownArrow');
            const logoutLink = document.getElementById('logoutLink');
            const logoutSidebarLinks = document.querySelectorAll('.logout-sidebar');
            const userNameElement = document.getElementById('userName');
            const userAvatarElement = document.getElementById('userAvatar');
            const userRoleElement = document.getElementById('userRole');
            const userIdElement = document.getElementById('userId');
            const pageTitleElement = document.getElementById('pageTitle');
            const pageSubtitleElement = document.getElementById('pageSubtitle');
            const mainContent = document.getElementById('mainContent');
            
            // Modal elements
            const compileResultsModal = document.getElementById('compileResultsModal');
            const compileModalClose = document.getElementById('compileModalClose');
            const reportCardsModal = document.getElementById('reportCardsModal');
            const reportCardsModalClose = document.getElementById('reportCardsModalClose');
            const emailParentsModal = document.getElementById('emailParentsModal');
            const emailModalClose = document.getElementById('emailModalClose');
            const advancedAnalysisModal = document.getElementById('advancedAnalysisModal');
            const analysisModalClose = document.getElementById('analysisModalClose');
            
            // Cloud Access modal buttons
            const accessCloudBtn = document.getElementById('accessCloudBtn');
            const exportResultsBtn = document.getElementById('exportResultsBtn');
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            const analysisBtn = document.getElementById('analysisBtn');
            const backToCloudBtn = document.getElementById('backToCloudBtn');
            const generateReportBtn = document.getElementById('generateReportBtn');
            const backToDataBtn = document.getElementById('backToDataBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const prevBtnBottom = document.getElementById('prevBtnBottom');
            const nextBtnBottom = document.getElementById('nextBtnBottom');
            const pageSizeSelect = document.getElementById('pageSize');

            // Links to open modals
            const compileResultsLink = document.getElementById('compileResultsLink');
            const reportCardsLink = document.getElementById('reportCardsLink');
            const emailParentsLink = document.getElementById('emailParentsLink');
            const advancedAnalysisLink = document.getElementById('advancedAnalysisLink');

            // NEW FILTER ELEMENTS
            const filterComputeBtn = document.getElementById('filterComputeBtn');
            const filterFormSection = document.getElementById('filterFormSection');
            const applyFilterBtn = document.getElementById('applyFilterBtn');
            const clearFilterBtn = document.getElementById('clearFilterBtn');
            const computeAggregatesBtn = document.getElementById('computeAggregatesBtn');
            const computationResultsSection = document.getElementById('computationResultsSection');
            const exportComputationResultsBtn = document.getElementById('exportComputationResultsBtn');
            const backToFiltersBtn = document.getElementById('backToFiltersBtn');

            // State variables
            let allStudents = [];
            let allScores = [];
            let gradingSystem = [];
            let subjectComponents = [];
            let teacherData = [];
            let compiledResults = [];
            let pendingResultsCount = 0;
            let pendingReportsCount = 0;
            let pendingEmailsCount = 0;
            let auditData = [];
            
            // Analysis variables
            let performanceCharts = {};
            let analysisData = {};

            // Pagination variables
            let currentPage = 1;
            let pageSize = 100;
            let totalPages = 1;
            let paginatedData = [];

            // NEW: Filter state
            let currentFilters = {};

            // Table column configuration - UPDATED with subject teacher and recorded_by fields
            const tableColumns = [
                { key: 'id', header: '#', width: '50px' },
                { key: 'admission_no', header: 'Admission', width: '100px' },
                { key: 'student_name', header: 'Student Name', width: '150px' },
                { key: 'grade', header: 'Grade', width: '80px' },
                { key: 'stream', header: 'Stream', width: '100px' },
                { key: 'subject_code', header: 'Subject Code', width: '120px' },
                { key: 'component_name', header: 'Component', width: '150px' },
                { key: 'subject_teacher', header: 'Subject Teacher', width: '150px' },
                { key: 'recorded_by', header: 'Recorded By', width: '150px' },
                { key: 'score', header: 'Score', width: '80px' },
                { key: 'percentage', header: 'Percentage', width: '100px' },
                { key: 'grade_letter', header: 'Grade', width: '80px' },
                { key: 'achievement_level', header: 'Achievement Level', width: '120px' },
                { key: 'achievement_description', header: 'Description', width: '150px' },
                { key: 'exam_type', header: 'Exam Type', width: '120px' },
                { key: 'term', header: 'Term', width: '100px' },
                { key: 'academic_year', header: 'Year', width: '100px' }
            ];

            // Function to get user data from Supabase
            async function loadUserData() {
                try {
                    console.log('Loading user data for Examination Office...');
                    
                    // Check if user is logged in
                    const { data: { user }, error: userError } = await supabase.auth.getUser();
                    
                    if (userError) {
                        console.error('Auth error:', userError);
                        redirectToLogin();
                        return;
                    }
                    
                    if (!user) {
                        console.error('No user found - redirecting to login');
                        redirectToLogin();
                        return;
                    }
                    
                    currentUser = user;
                    userId = user.id;
                    
                    console.log('Examination Officer authenticated:', user.id);
                    
                    // Set user display
                    updateUserDisplay(
                        user.user_metadata?.full_name || 'Examination Officer',
                        userRole,
                        user.user_metadata?.profile_image_url || null,
                        user.email
                    );
                    
                    // Load all data
                    await loadAllData();
                    
                    // Load dashboard content
                    loadDashboardContent();
                    
                } catch (error) {
                    console.error('Error loading user data:', error);
                    // Use localStorage as fallback
                    const savedName = localStorage.getItem('examOfficerName') || 'Examination Officer';
                    updateUserDisplay(savedName, userRole, null, 'exam@alliancegirls.ac.ke');
                }
            }

            // Function to redirect to login
            function redirectToLogin() {
                console.log('Redirecting to login page...');
                window.location.href = 'index.html';
            }

            // Function to format year input (xxxx-xxxx format)
            function formatYearInput(input, nextInputId, prevInputId) {
                // Remove any non-numeric characters
                input.value = input.value.replace(/\D/g, '');
                
                // Limit to 4 digits
                if (input.value.length > 4) {
                    input.value = input.value.substring(0, 4);
                }
                
                // Auto-advance to next input when 4 digits are entered
                if (input.value.length === 4 && nextInputId) {
                    document.getElementById(nextInputId).focus();
                }
                
                // Auto-advance to previous input when deleting and empty
                if (input.value.length === 0 && prevInputId && input.selectionStart === 0) {
                    document.getElementById(prevInputId).focus();
                }
            }

            // Function to get the full academic year from the split inputs
            function getFullAcademicYear(year1Id, year2Id) {
                const year1 = document.getElementById(year1Id)?.value || '';
                const year2 = document.getElementById(year2Id)?.value || '';
                
                if (year1 && year2) {
                    return `${year1}-${year2}`;
                } else if (year1) {
                    return `${year1}-${parseInt(year1) + 1}`;
                } else if (year2) {
                    return `${parseInt(year2) - 1}-${year2}`;
                }
                return '';
            }

            // Function to populate streams dropdown
            function populateStreams() {
                const streams = [...new Set(allStudents.map(student => student.stream).filter(Boolean))];
                const reportStreamSelect = document.getElementById('reportStream');
                const emailStreamSelect = document.getElementById('emailStream');
                
                if (reportStreamSelect) {
                    reportStreamSelect.innerHTML = '';
                    streams.forEach(stream => {
                        const option = document.createElement('option');
                        option.value = stream;
                        option.textContent = stream;
                        reportStreamSelect.appendChild(option);
                    });
                }
                
                if (emailStreamSelect) {
                    emailStreamSelect.innerHTML = '';
                    streams.forEach(stream => {
                        const option = document.createElement('option');
                        option.value = stream;
                        option.textContent = stream;
                        emailStreamSelect.appendChild(option);
                    });
                }
            }

            // Function to load all data needed for examination office
            async function loadAllData() {
                try {
                    console.log('Loading all data for Examination Office...');
                    
                    // Load grading system
                    await loadGradingSystem();
                    
                    // Load subject components
                    await loadSubjectComponents();
                    
                    // Load students
                    await loadAllStudents();
                    
                    // Load scores
                    await loadAllScores();
                    
                    // Load teachers
                    await loadTeachers();
                    
                    // Load audit data
                    await loadAuditData();
                    
                    // Calculate pending counts
                    calculatePendingCounts();
                    
                    console.log('All data loaded successfully');
                    
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            }

            // Function to load grading system
            async function loadGradingSystem() {
                try {
                    const { data, error } = await supabase
                        .from('grading_system')
                        .select('*')
                        .order('sort_order', { ascending: true });
                    
                    if (error) throw error;
                    
                    gradingSystem = data || [];
                    console.log('Grading system loaded:', gradingSystem.length, 'grades');
                    
                } catch (error) {
                    console.error('Error loading grading system:', error);
                    gradingSystem = [];
                }
            }

            // Function to load subject components
            async function loadSubjectComponents() {
                try {
                    const { data, error } = await supabase
                        .from('subject_components')
                        .select('*')
                        .order('subject_code, component_code', { ascending: true });
                    
                    if (error) throw error;
                    
                    subjectComponents = data || [];
                    console.log('Subject components loaded:', subjectComponents.length);
                    
                } catch (error) {
                    console.error('Error loading subject components:', error);
                    subjectComponents = [];
                }
            }

            // Function to load all students
            async function loadAllStudents() {
                try {
                    const { data, error } = await supabase
                        .from('students')
                        .select('*')
                        .order('admission_no', { ascending: true });
                    
                    if (error) throw error;
                    
                    allStudents = data || [];
                    console.log('Students loaded:', allStudents.length);
                    
                } catch (error) {
                    console.error('Error loading students:', error);
                    allStudents = [];
                }
            }

            // Function to load all scores from student_scores table
            async function loadAllScores() {
                try {
                    console.log('Loading scores from student_scores table...');
                    
                    // Simple query without relationships
                    const { data, error } = await supabase
                        .from('student_scores')
                        .select('*')
                        .limit(1000); // Increased limit for better data display
                    
                    if (error) {
                        console.error('Error loading scores:', error);
                        throw error;
                    }
                    
                    allScores = data || [];
                    console.log('Scores loaded from student_scores:', allScores.length, 'records');
                    
                    if (allScores.length > 0) {
                        // Log sample to understand structure
                        console.log('Sample score structure:', allScores[0]);
                        
                        // Check what data is available
                        const academicYears = [...new Set(allScores.map(score => score.academic_year).filter(Boolean))];
                        const examTypes = [...new Set(allScores.map(score => score.exam_type).filter(Boolean))];
                        
                        console.log('Available academic years in database:', academicYears);
                        console.log('Available exam types in database:', examTypes);
                    } else {
                        console.log('No scores found in the database');
                    }
                    
                } catch (error) {
                    console.error('Error loading scores from student_scores:', error);
                    allScores = [];
                }
            }

            // Function to load teachers
            async function loadTeachers() {
                try {
                    const { data, error } = await supabase
                        .from('teachers')
                        .select('*')
                        .order('full_name', { ascending: true });
                    
                    if (error) throw error;
                    
                    teacherData = data || [];
                    console.log('Teachers loaded:', teacherData.length);
                    
                } catch (error) {
                    console.error('Error loading teachers:', error);
                    teacherData = [];
                }
            }

            // Function to load audit data
            async function loadAuditData() {
                try {
                    const { data, error } = await supabase
                        .from('audit_logs')
                        .select('*')
                        .order('timestamp', { ascending: false })
                        .limit(100);
                    
                    if (error) throw error;
                    
                    auditData = data || [];
                    console.log('Audit data loaded:', auditData.length, 'entries');
                    
                } catch (error) {
                    console.error('Error loading audit data:', error);
                    auditData = [];
                }
            }

            // Function to calculate pending counts
            function calculatePendingCounts() {
                // Calculate pending results (scores from last 7 days not yet compiled)
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                
                const recentScores = allScores.filter(score => 
                    new Date(score.recorded_at) > oneWeekAgo
                );
                
                pendingResultsCount = recentScores.length;
                
                // Calculate pending reports (students without report cards for current term)
                pendingReportsCount = Math.floor(allStudents.length * 0.3); // 30% need reports
                
                // Calculate pending emails (parents not emailed in last month)
                pendingEmailsCount = Math.floor(allStudents.length * 0.4); // 40% need emails
                
                // Update badge counts
                updateBadgeCounts();
            }

            // Function to update badge counts
            function updateBadgeCounts() {
                const pendingResultsElement = document.getElementById('pendingResults');
                const pendingReportsElement = document.getElementById('pendingReports');
                const pendingEmailsElement = document.getElementById('pendingEmails');
                
                if (pendingResultsElement) pendingResultsElement.textContent = pendingResultsCount;
                if (pendingReportsElement) pendingReportsElement.textContent = pendingReportsCount;
                if (pendingEmailsElement) pendingEmailsElement.textContent = pendingEmailsCount;
            }

            // Function to get initials from full name
            function getInitials(fullName) {
                if (!fullName || fullName === 'Examination Officer') return 'EO';
                
                return fullName
                    .split(' ')
                    .map(name => name[0])
                    .join('')
                    .toUpperCase()
                    .substring(0, 2);
            }

            // Function to update user display
            function updateUserDisplay(fullName, role, profileImageUrl, email) {
                console.log('Updating user display:', {fullName, role});
                
                // Get initials for avatar
                const initials = getInitials(fullName);
                
                // Update all display elements
                if (userNameElement) userNameElement.textContent = fullName;
                if (userRoleElement) userRoleElement.textContent = role;
                if (userIdElement) userIdElement.textContent = `ID: ${userId ? userId.substring(0, 8) + '...' : 'Loading...'}`;
                
                // Clear the avatar element first
                userAvatarElement.innerHTML = '';
                
                // Handle profile image
                if (profileImageUrl) {
                    // Create image element
                    const img = document.createElement('img');
                    img.src = profileImageUrl;
                    img.alt = fullName;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '50%';
                    
                    // Add upload overlay
                    const overlay = document.createElement('div');
                    overlay.className = 'profile-upload-overlay';
                    overlay.innerHTML = '<i class="fas fa-camera"></i>';
                    
                    // Add elements to avatar
                    userAvatarElement.appendChild(img);
                    userAvatarElement.appendChild(overlay);
                    
                    // Remove background gradient
                    userAvatarElement.style.background = 'transparent';
                    
                } else {
                    // No image, show initials
                    userAvatarElement.style.background = 'linear-gradient(135deg, var(--exam-office-purple), var(--accent-blue))';
                    userAvatarElement.textContent = initials;
                    userAvatarElement.style.color = 'white';
                    userAvatarElement.style.display = 'flex';
                    userAvatarElement.style.alignItems = 'center';
                    userAvatarElement.style.justifyContent = 'center';
                    userAvatarElement.style.fontWeight = 'bold';
                    userAvatarElement.style.fontSize = '1.2rem';
                }
                
                // Save to localStorage
                localStorage.setItem('examOfficerName', fullName);
            }

            // Function to load dashboard content
            function loadDashboardContent(section = 'dashboard') {
                console.log('Loading section:', section);
                
                let content = '';
                let pageTitle = '';
                let pageSubtitle = '';
                
                switch(section) {
                    case 'dashboard':
                        pageTitle = 'Examination Office Dashboard';
                        pageSubtitle = 'Comprehensive Academic Oversight & Analysis';
                        content = generateDashboardContent();
                        break;
                    case 'compile':
                        pageTitle = 'Cloud Access';
                        pageSubtitle = 'Access and manage cloud examination data';
                        content = generateCloudAccessContent();
                        break;
                    case 'reports':
                        pageTitle = 'Report Cards';
                        pageSubtitle = 'Generate and manage student report cards';
                        content = generateReportsContent();
                        break;
                    case 'email':
                        pageTitle = 'Email Parents';
                        pageSubtitle = 'Communicate results and updates to parents';
                        content = generateEmailContent();
                        break;
                    case 'analysis':
                        pageTitle = 'Advanced Analysis';
                        pageSubtitle = 'AI-powered academic insights and predictions';
                        content = generateAnalysisContent();
                        break;
                    case 'trends':
                        pageTitle = 'Performance Trends';
                        pageSubtitle = 'Historical analysis and trend identification';
                        content = generateTrendsContent();
                        break;
                    case 'teachers':
                        pageTitle = 'Teacher Performance';
                        pageSubtitle = 'Monitor and analyze teacher effectiveness';
                        content = generateTeachersContent();
                        break;
                    case 'validation':
                        pageTitle = 'Data Validation';
                        pageSubtitle = 'Verify and validate academic data integrity';
                        content = generateValidationContent();
                        break;
                    case 'audit':
                        pageTitle = 'Audit Trail';
                        pageSubtitle = 'Track all examination office activities';
                        content = generateAuditContent();
                        break;
                    case 'settings':
                        pageTitle = 'Settings';
                        pageSubtitle = 'Configure examination office preferences';
                        content = generateSettingsContent();
                        break;
                    default:
                        pageTitle = section.charAt(0).toUpperCase() + section.slice(1);
                        pageSubtitle = `${pageTitle} Management`;
                        content = generateDefaultContent(section);
                }
                
                // Update page title
                if (pageTitleElement) pageTitleElement.textContent = pageTitle;
                if (pageSubtitleElement) pageSubtitleElement.textContent = pageSubtitle;
                
                // Update main content
                if (mainContent) {
                    mainContent.innerHTML = content;
                    
                    // Initialize charts if needed
                    if (section === 'dashboard') {
                        setTimeout(initializeDashboardCharts, 500);
                    }
                }
                
                // Update active nav link
                navLinks.forEach(link => {
                    if (link.getAttribute('data-section') === section) {
                        link.classList.add('active');
                    } else {
                        link.classList.remove('active');
                    }
                });
            }

            // Content generation functions
            function generateDashboardContent() {
                const totalStudents = allStudents.length;
                const totalScores = allScores.length;
                const avgScore = calculateAverageScore();
                const topPerformer = findTopPerformer();
                const weakestSubject = findWeakestSubject();
                
                return `
                    <div class="data-section">
                        <div class="section-title">
                            <h2><i class="fas fa-tachometer-alt"></i> Examination Office Dashboard</h2>
                            <div class="section-info">Real-time Academic Overview</div>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">Total Students</div>
                                <div class="stat-value">${totalStudents}</div>
                                <div style="font-size: 0.8rem; color: var(--muted-green);">
                                    ${allStudents.filter(s => s.gender === 'Female').length} Female | 
                                    ${allStudents.filter(s => s.gender === 'Male').length} Male
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Exam Records</div>
                                <div class="stat-value">${totalScores}</div>
                                <div style="font-size: 0.8rem; color: var(--muted-green);">
                                    ${new Set(allScores.map(s => s.student_id)).size} Students with scores
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Average Score</div>
                                <div class="stat-value">${avgScore}%</div>
                                <div style="font-size: 0.8rem; color: var(--muted-green);">
                                    ${calculateGradeFromScore(avgScore)} Grade
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Pending Actions</div>
                                <div class="stat-value">${pendingResultsCount + pendingReportsCount + pendingEmailsCount}</div>
                                <div style="font-size: 0.8rem; color: var(--muted-green);">
                                    Cloud: ${pendingResultsCount} | Reports: ${pendingReportsCount} | Emails: ${pendingEmailsCount}
                                </div>
                            </div>
                        </div>
                        
                        <div class="data-cards">
                            <div class="data-card">
                                <div class="card-header">
                                    <i class="fas fa-cloud"></i>
                                    <h3>Cloud Access</h3>
                                </div>
                                <div class="card-body">
                                    <p style="line-height: 1.6; color: #666; margin-bottom: 15px;">
                                        Access examination results stored in the cloud database with real-time synchronization.
                                    </p>
                                    <div class="info-row" style="margin-top: 15px;">
                                        <span class="info-label">Cloud Records:</span>
                                        <span class="info-value">${totalScores}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Last Synced:</span>
                                        <span class="info-value">${getLastCompiledDate()}</span>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <span>Access Cloud</span>
                                    <button class="btn btn-outline" onclick="openCompileResultsModal()">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="data-card">
                                <div class="card-header">
                                    <i class="fas fa-file-certificate"></i>
                                    <h3>Report Cards</h3>
                                </div>
                                <div class="card-body">
                                    <p style="line-height: 1.6; color: #666; margin-bottom: 15px;">
                                        Generate secure report cards with anti-forgery features and unique patterns.
                                    </p>
                                    <div class="info-row" style="margin-top: 15px;">
                                        <span class="info-label">Pending Reports:</span>
                                        <span class="info-value">${pendingReportsCount}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Last Generated:</span>
                                        <span class="info-value">${getLastReportDate()}</span>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <span>Generate Reports</span>
                                    <button class="btn btn-outline" onclick="openReportCardsModal()">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="data-card">
                                <div class="card-header">
                                    <i class="fas fa-envelope"></i>
                                    <h3>Parent Communication</h3>
                                </div>
                                <div class="card-body">
                                    <p style="line-height: 1.6; color: #666; margin-bottom: 15px;">
                                        Send automated emails to parents with personalized results and attachments.
                                    </p>
                                    <div class="info-row" style="margin-top: 15px;">
                                        <span class="info-label">Pending Emails:</span>
                                        <span class="info-value">${pendingEmailsCount}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Last Sent:</span>
                                        <span class="info-value">${getLastEmailDate()}</span>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <span>Email Parents</span>
                                    <button class="btn btn-outline" onclick="openEmailParentsModal()">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <h3><i class="fas fa-chart-bar"></i> Performance Distribution</h3>
                            <canvas id="dashboardChart" height="100"></canvas>
                        </div>
                        
                        <div class="analysis-cards">
                            <div class="analysis-card">
                                <h3><i class="fas fa-crown"></i> Top Performer</h3>
                                <div class="analysis-value">${topPerformer.name || 'N/A'}</div>
                                <p>${topPerformer.score ? `Average: ${topPerformer.score}%` : 'No data available'}</p>
                                <p style="font-size: 0.9rem; color: var(--muted-green);">
                                    ${topPerformer.stream ? `Stream: ${topPerformer.stream}` : ''}
                                </p>
                            </div>
                            <div class="analysis-card">
                                <h3><i class="fas fa-exclamation-circle"></i> Weakest Subject</h3>
                                <div class="analysis-value">${weakestSubject.name || 'N/A'}</div>
                                <p>${weakestSubject.score ? `Average: ${weakestSubject.score}%` : 'No data available'}</p>
                                <p style="font-size: 0.9rem; color: var(--muted-green);">
                                    ${weakestSubject.count ? `${weakestSubject.count} students below average` : ''}
                                </p>
                            </div>
                            <div class="analysis-card">
                                <h3><i class="fas fa-lightbulb"></i> Key Insight</h3>
                                <p>${generateInsight()}</p>
                                <div style="margin-top: 15px; font-size: 0.9rem; color: var(--exam-office-blue);">
                                    <i class="fas fa-bullseye"></i> Recommendation: ${generateRecommendation()}
                                </div>
                            </div>
                        </div>
                        
                        <div class="footer">
                            <p> 2026 Alliance Girls High School - Examination Office. Advanced Academic Analytics System.</p>
                            <div class="footer-links">
                                <a href="#" onclick="loadDashboardContent('audit')"><i class="fas fa-history"></i> Audit Log</a>
                                <a href="#" onclick="loadDashboardContent('validation')"><i class="fas fa-check-double"></i> Data Validation</a>
                                <a href="#" onclick="openAdvancedAnalysisModal()"><i class="fas fa-brain"></i> AI Analysis</a>
                            </div>
                        </div>
                    </div>
                `;
            }

            function generateCloudAccessContent() {
                return `
                    <div class="data-section">
                        <div class="section-title">
                            <h2><i class="fas fa-cloud"></i> Cloud Data Access</h2>
                            <div class="section-info">Access and manage examination data stored in the cloud</div>
                        </div>
                        
                        <div class="data-cards">
                            <div class="data-card">
                                <div class="card-header">
                                    <i class="fas fa-database"></i>
                                    <h3>Cloud Database</h3>
                                </div>
                                <div class="card-body">
                                    <p style="line-height: 1.6; color: #666; margin-bottom: 15px;">
                                        Direct access to the cloud database containing all examination records with real-time synchronization.
                                    </p>
                                    <ul style="color: #666; line-height: 1.6; padding-left: 20px;">
                                        <li>Real-time data access</li>
                                        <li>Secure cloud storage</li>
                                        <li>Automatic backups</li>
                                        <li>Multi-device access</li>
                                    </ul>
                                </div>
                                <div class="card-footer">
                                    <span>Access Data</span>
                                    <button class="btn btn-primary" onclick="openCompileResultsModal()">
                                        <i class="fas fa-cloud-download-alt"></i> Open
                                    </button>
                                </div>
                            </div>
                            
                            <div class="data-card">
                                <div class="card-header">
                                    <i class="fas fa-chart-pie"></i>
                                    <h3>Data Analytics</h3>
                                </div>
                                <div class="card-body">
                                    <p style="line-height: 1.6; color: #666; margin-bottom: 15px;">
                                        Advanced analytics and insights generated from cloud examination data.
                                    </p>
                                    <ul style="color: #666; line-height: 1.6; padding-left: 20px;">
                                        <li>Performance trends</li>
                                        <li>Predictive analytics</li>
                                        <li>Statistical analysis</li>
                                        <li>Correlation studies</li>
                                    </ul>
                                </div>
                                <div class="card-footer">
                                    <span>View Analytics</span>
                                    <button class="btn btn-outline" onclick="openAdvancedAnalysisModal()">
                                        <i class="fas fa-chart-line"></i> Analyze
                                    </button>
                                </div>
                            </div>
                            
                            <div class="data-card">
                                <div class="card-header">
                                    <i class="fas fa-file-export"></i>
                                    <h3>Export & Reports</h3>
                                </div>
                                <div class="card-body">
                                    <p style="line-height: 1.6; color: #666; margin-bottom: 15px;">
                                        Export cloud data in various formats and generate comprehensive reports.
                                    </p>
                                    <ul style="color: #666; line-height: 1.6; padding-left: 20px;">
                                        <li>Excel spreadsheets</li>
                                        <li>PDF reports</li>
                                        <li>JSON data exports</li>
                                        <li>Custom report formats</li>
                                    </ul>
                                </div>
                                <div class="card-footer">
                                    <span>Export Data</span>
                                    <button class="btn btn-outline" onclick="openCompileResultsModal()">
                                        <i class="fas fa-download"></i> Export
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 40px; background: white; padding: 25px; border-radius: 12px; box-shadow: var(--card-shadow);">
                            <h3 style="color: var(--exam-office-purple); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-cloud-upload-alt"></i> Cloud Features
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                                <div>
                                    <h4 style="color: var(--exam-office-blue); margin-bottom: 10px;">Data Access</h4>
                                    <ul style="color: #666; line-height: 1.6;">
                                        <li>Real-time data synchronization</li>
                                        <li>Secure cloud storage with encryption</li>
                                        <li>Automatic backup and recovery</li>
                                        <li>Multi-user concurrent access</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 style="color: var(--exam-office-blue); margin-bottom: 10px;">Data Analytics</h4>
                                    <ul style="color: #666; line-height: 1.6;">
                                        <li>Real-time performance dashboards</li>
                                        <li>Advanced statistical analysis</li>
                                        <li>Predictive analytics and forecasting</li>
                                        <li>Data visualization tools</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 style="color: var(--exam-office-blue); margin-bottom: 10px;">Security & Compliance</h4>
                                    <ul style="color: #666; line-height: 1.6;">
                                        <li>End-to-end encryption</li>
                                        <li>Role-based access control</li>
                                        <li>Audit trail and activity logging</li>
                                        <li>GDPR and data protection compliance</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="footer">
                            <p> 2026 Alliance Girls High School - Examination Office. Cloud Data Access System.</p>
                        </div>
                    </div>
                `;
            }

            function generateReportsContent() {
                return `
                    <div class="data-section">
                        <div class="section-title">
                            <h2><i class="fas fa-file-certificate"></i> Generate Report Cards</h2>
                            <div class="section-info">Create secure, tamper-proof report cards with advanced features</div>
                        </div>
                        
                        <div class="data-cards">
                            <div class="data-card">
                                <div class="card-header">
                                    <i class="fas fa-shield-alt"></i>
                                    <h3>Security Features</h3>
                                </div>
                                <div class="card-body">
                                    <p style="line-height: 1.6; color: #666; margin-bottom: 15px;">
                                        Advanced anti-forgery measures to ensure report card authenticity.
                                    </p>
                                    <ul style="color: #666; line-height: 1.6; padding-left: 20px;">
                                        <li>Unique QR codes for verification</li>
                                        <li>Micro-text patterns</li>
                                        <li>Holographic elements</li>
                                        <li>Digital signatures</li>
                                        <li>UV-reactive ink patterns</li>
                                    </ul>
                                </div>
                                <div class="card-footer">
                                    <span>Security Settings</span>
                                    <button class="btn btn-outline" onclick="openReportCardsModal()">
                                        <i class="fas fa-lock"></i> Configure
                                    </button>
                                </div>
                            </div>
                            
                            <div class="data-card">
                                <div class="card-header">
                                    <i class="fas fa-palette"></i>
                                    <h3>Custom Templates</h3>
                                </div>
                                <div class="card-body">
                                    <p style="line-height: 1.6; color: #666; margin-bottom: 15px;">
                                        Design and customize report card templates for different needs.
                                    </p>
                                    <ul style="color: #666; line-height: 1.6; padding-left: 20px;">
                                        <li>Multiple template designs</li>
                                        <li>Custom color schemes</li>
                                        <li>School branding integration</li>
                                        <li>Multi-language support</li>
                                    </ul>
                                </div>
                                <div class="card-footer">
                                    <span>Design Templates</span>
                                    <button class="btn btn-outline" onclick="openReportCardsModal()">
                                        <i class="fas fa-edit"></i> Design
                                    </button>
                                </div>
                            </div>
                            
                            <div class="data-card">
                                <div class="card-header">
                                    <i class="fas fa-print"></i>
                                    <h3>Batch Processing</h3>
                                </div>
                                <div class="card-body">
                                    <p style="line-height: 1.6; color: #666; margin-bottom: 15px;">
                                        Generate report cards in bulk for entire classes or streams.
                                    </p>
                                    <ul style="color: #666; line-height: 1.6; padding-left: 20px;">
                                        <li>Batch generation</li>
                                        <li>Scheduled printing</li>
                                        <li>Progress tracking</li>
                                        <li>Error handling</li>
                                    </ul>
                                </div>
                                <div class="card-footer">
                                    <span>Batch Operations</span>
                                    <button class="btn btn-primary" onclick="openReportCardsModal()">
                                        <i class="fas fa-play-circle"></i> Start Batch
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="report-card-preview" style="margin-top: 40px;">
                            <div class="report-card-header">
                                <h2 style="margin: 0; font-size: 2rem;">ALLIANCE GIRLS HIGH SCHOOL</h2>
                                <p style="margin: 5px 0; opacity: 0.9;">OFFICIAL REPORT CARD - SAMPLE</p>
                                <div style="margin-top: 15px; display: flex; justify-content: space-between; flex-wrap: wrap;">
                                    <div>
                                        <p><strong>Student:</strong> JANE DOE</p>
                                        <p><strong>Admission:</strong> 12345</p>
                                    </div>
                                    <div>
                                        <p><strong>Term:</strong> Term 1, 2025-2026</p>
                                        <p><strong>Grade:</strong> Grade 12 West</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="report-card-body">
                                <div class="report-card-section">
                                    <h4 style="color: var(--exam-office-purple); margin-bottom: 10px;">Academic Performance</h4>
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tr>
                                            <th style="text-align: left; padding: 5px 0;">Subject</th>
                                            <th style="text-align: center; padding: 5px 0;">Score</th>
                                            <th style="text-align: center; padding: 5px 0;">Grade</th>
                                        </tr>
                                        <tr>
                                            <td style="padding: 5px 0;">Mathematics</td>
                                            <td style="text-align: center; padding: 5px 0;">85%</td>
                                            <td style="text-align: center; padding: 5px 0; color: var(--primary-green); font-weight: bold;">A</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 5px 0;">English</td>
                                            <td style="text-align: center; padding: 5px 0;">78%</td>
                                            <td style="text-align: center; padding: 5px 0; color: var(--exam-office-blue); font-weight: bold;">B+</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 5px 0;">Physics</td>
                                            <td style="text-align: center; padding: 5px 0;">92%</td>
                                            <td style="text-align: center; padding: 5px 0; color: var(--primary-green); font-weight: bold;">A</td>
                                        </tr>
                                    </table>
                                </div>
                                
                                <div class="report-card-section">
                                    <h4 style="color: var(--exam-office-purple); margin-bottom: 10px;">Summary</h4>
                                    <p><strong>Overall Grade:</strong> A</p>
                                    <p><strong>Class Rank:</strong> 5/120</p>
                                    <p><strong>Attendance:</strong> 95%</p>
                                    <p><strong>Remarks:</strong> Excellent performance. Keep up the good work!</p>
                                </div>
                            </div>
                            
                            <div class="security-features">
                                <h4><i class="fas fa-shield-alt"></i> Security Features (Sample)</h4>
                                <p style="margin: 10px 0;">This report card includes multiple security features to prevent forgery:</p>
                                <ul style="margin: 10px 0; padding-left: 20px;">
                                    <li>Unique QR Code for verification</li>
                                    <li>Micro-text border patterns</li>
                                    <li>Serial Number: AGHS-RC-2025-12345</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="footer">
                            <p> 2026 Alliance Girls High School - Examination Office. Secure Report Card System.</p>
                        </div>
                    </div>
                `;
            }

            // Helper functions for dashboard
            function calculateAverageScore() {
                if (allScores.length === 0) return 0;
                const total = allScores.reduce((sum, score) => sum + (score.percentage_score || 0), 0);
                return (total / allScores.length).toFixed(1);
            }

            // Function to calculate grade from score using your grading system
            function calculateGradeFromScore(score) {
                if (!gradingSystem || gradingSystem.length === 0) {
                    console.log('No grading system available');
                    return 'N/A';
                }
                
                const numericScore = parseFloat(score);
                if (isNaN(numericScore)) {
                    console.log('Invalid score:', score);
                    return 'N/A';
                }
                
                console.log('Calculating grade for score:', numericScore);
                console.log('Available grades:', gradingSystem);
                
                // Find the appropriate grade
                for (const grade of gradingSystem) {
                    const minScore = parseFloat(grade.min_score);
                    const maxScore = parseFloat(grade.max_score);
                    
                    if (!isNaN(minScore) && !isNaN(maxScore)) {
                        if (numericScore >= minScore && numericScore <= maxScore) {
                            console.log('Found grade:', grade.grade, 'for score', numericScore);
                            return grade.grade;
                        }
                    }
                }
                
                console.log('No grade found for score:', numericScore);
                return 'N/A';
            }

            // Function to get achievement level and description
            function getAchievementLevelAndDescription(score) {
                if (!gradingSystem || gradingSystem.length === 0) {
                    return { level: 'N/A', description: 'N/A' };
                }
                
                const numericScore = parseFloat(score);
                if (isNaN(numericScore)) {
                    return { level: 'N/A', description: 'N/A' };
                }
                
                // Sort grading system by sort_order
                const sortedGrades = [...gradingSystem].sort((a, b) => b.sort_order - a.sort_order);
                
                for (const grade of sortedGrades) {
                    if (numericScore >= grade.min_score && numericScore <= grade.max_score) {
                        return {
                            level: grade.achievement_level || 'N/A',
                            description: grade.description || 'N/A'
                        };
                    }
                }
                
                return { level: 'Not Achieved', description: 'Did not meet minimum requirements' };
            }

            function findTopPerformer() {
                if (allStudents.length === 0 || allScores.length === 0) {
                    return { name: 'N/A', score: null, stream: '' };
                }
                
                // Group scores by student and calculate averages
                const studentAverages = {};
                allScores.forEach(score => {
                    if (!studentAverages[score.student_id]) {
                        studentAverages[score.student_id] = { total: 0, count: 0 };
                    }
                    studentAverages[score.student_id].total += score.percentage_score || 0;
                    studentAverages[score.student_id].count++;
                });
                
                // Find student with highest average
                let topStudentId = null;
                let topAverage = 0;
                
                Object.keys(studentAverages).forEach(studentId => {
                    const avg = studentAverages[studentId].total / studentAverages[studentId].count;
                    if (avg > topAverage) {
                        topAverage = avg;
                        topStudentId = studentId;
                    }
                });
                
                if (topStudentId) {
                    const student = allStudents.find(s => s.id === topStudentId);
                    return {
                        name: student ? student.full_name : 'Unknown Student',
                        score: topAverage.toFixed(1),
                        stream: student ? student.stream : ''
                    };
                }
                
                return { name: 'N/A', score: null, stream: '' };
            }

            function findWeakestSubject() {
                if (allScores.length === 0) {
                    return { name: 'N/A', score: null, count: 0 };
                }
                
                // Group scores by subject component
                const subjectScores = {};
                allScores.forEach(score => {
                    if (score.subject_component_id) {
                        const component = subjectComponents.find(c => c.id === score.subject_component_id);
                        if (component) {
                            const subjectCode = component.subject_code;
                            if (!subjectScores[subjectCode]) {
                                subjectScores[subjectCode] = { total: 0, count: 0 };
                            }
                            subjectScores[subjectCode].total += score.percentage_score || 0;
                            subjectScores[subjectCode].count++;
                        }
                    }
                });
                
                // Find subject with lowest average
                let weakestSubject = null;
                let lowestAverage = 100;
                
                Object.keys(subjectScores).forEach(subject => {
                    const avg = subjectScores[subject].total / subjectScores[subject].count;
                    if (avg < lowestAverage) {
                        lowestAverage = avg;
                        weakestSubject = subject;
                    }
                });
                
                if (weakestSubject) {
                    const belowAvgCount = allScores.filter(score => {
                        const component = subjectComponents.find(c => c.id === score.subject_component_id);
                        return component && component.subject_code === weakestSubject && 
                               (score.percentage_score || 0) < lowestAverage;
                    }).length;
                    
                    return {
                        name: weakestSubject,
                        score: lowestAverage.toFixed(1),
                        count: belowAvgCount
                    };
                }
                
                return { name: 'N/A', score: null, count: 0 };
            }

            function generateInsight() {
                const avgScore = calculateAverageScore();
                const grade = calculateGradeFromScore(avgScore);
                
                if (avgScore >= 80) {
                    return "Overall performance is excellent. Students are exceeding expectations across most subjects.";
                } else if (avgScore >= 70) {
                    return "Good overall performance. Focus on improving weaker subjects to reach excellence.";
                } else if (avgScore >= 60) {
                    return "Satisfactory performance. Consider targeted interventions for struggling students.";
                } else {
                    return "Performance needs improvement. Immediate action required for academic support.";
                }
            }

            function generateRecommendation() {
                const weakest = findWeakestSubject();
                if (weakest.name && weakest.name !== 'N/A') {
                    return `Focus on improving ${weakest.name} performance through targeted teaching strategies.`;
                }
                return "Maintain current teaching strategies while monitoring for any performance declines.";
            }

            function getLastCompiledDate() {
                // In production, you would fetch this from a database
                const dates = allScores.map(s => new Date(s.recorded_at));
                if (dates.length === 0) return 'Never';
                
                const latest = new Date(Math.max(...dates));
                return latest.toLocaleDateString();
            }

            function getLastReportDate() {
                // In production, you would fetch this from a database
                return '2025-03-15';
            }

            function getLastEmailDate() {
                // In production, you would fetch this from a database
                return '2025-03-10';
            }

            // Initialize dashboard charts
            function initializeDashboardCharts() {
                try {
                    const ctx = document.getElementById('dashboardChart');
                    if (!ctx) return;
                    
                    // Sample data - in production, you would use real data
                    const gradeDistribution = {
                        'A': Math.floor(Math.random() * 20) + 10,
                        'B': Math.floor(Math.random() * 30) + 20,
                        'C': Math.floor(Math.random() * 40) + 30,
                        'D': Math.floor(Math.random() * 20) + 10,
                        'E': Math.floor(Math.random() * 10) + 5
                    };
                    
                    performanceCharts.dashboard = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(gradeDistribution),
                            datasets: [{
                                label: 'Number of Students',
                                data: Object.values(gradeDistribution),
                                backgroundColor: [
                                    'rgba(16, 185, 129, 0.7)',
                                    'rgba(59, 130, 246, 0.7)',
                                    'rgba(245, 158, 11, 0.7)',
                                    'rgba(239, 68, 68, 0.7)',
                                    'rgba(107, 114, 128, 0.7)'
                                ],
                                borderColor: [
                                    'rgb(16, 185, 129)',
                                    'rgb(59, 130, 246)',
                                    'rgb(245, 158, 11)',
                                    'rgb(239, 68, 68)',
                                    'rgb(107, 114, 128)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                title: {
                                    display: true,
                                    text: 'Grade Distribution Across All Students',
                                    color: '#333',
                                    font: {
                                        size: 14
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Number of Students'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Grade'
                                    }
                                }
                            }
                        }
                    });
                    
                } catch (error) {
                    console.error('Error initializing dashboard chart:', error);
                }
            }

            // Modal opening functions
            function openCompileResultsModal() {
                compileResultsModal.classList.add('show');
                switchCompileView('cloud');
            }

            function openReportCardsModal() {
                reportCardsModal.classList.add('show');
                switchReportCardsView('selection');
                
                // Set current year as default in the manual input
                const currentYear = new Date().getFullYear();
                document.getElementById('reportAcademicYear1').value = currentYear;
                document.getElementById('reportAcademicYear2').value = currentYear + 1;
            }

            function openEmailParentsModal() {
                emailParentsModal.classList.add('show');
                switchEmailView('recipients');
            }

            function openAdvancedAnalysisModal() {
                advancedAnalysisModal.classList.add('show');
                switchAnalysisView('predictive');
            }

            // View switching functions
            function switchCompileView(view) {
                const viewBtns = document.querySelectorAll('#compileViewToggle .view-btn');
                viewBtns.forEach(btn => {
                    if (btn.dataset.view === view) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                
                // Show/hide sections
                document.getElementById('compileFiltersSection').style.display = view === 'cloud' ? 'block' : 'none';
                document.getElementById('compilePreviewSection').style.display = view === 'preview' ? 'block' : 'none';
                document.getElementById('compileAnalysisSection').style.display = view === 'analysis' ? 'block' : 'none';
                
                // If switching to preview, access cloud data
                if (view === 'preview') {
                    accessCloudData();
                }
            }

            function switchReportCardsView(view) {
                const viewBtns = document.querySelectorAll('#reportCardsViewToggle .view-btn');
                viewBtns.forEach(btn => {
                    if (btn.dataset.view === view) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                
                // Show/hide sections
                document.getElementById('reportCardsSelectionSection').style.display = view === 'selection' ? 'block' : 'none';
                document.getElementById('reportCardsTemplateSection').style.display = view === 'template' ? 'block' : 'none';
                document.getElementById('reportCardsPreviewSection').style.display = view === 'preview' ? 'block' : 'none';
                document.getElementById('reportCardsSecuritySection').style.display = view === 'security' ? 'block' : 'none';
            }

            function switchEmailView(view) {
                const viewBtns = document.querySelectorAll('#emailViewToggle .view-btn');
                viewBtns.forEach(btn => {
                    if (btn.dataset.view === view) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                
                // Show/hide sections
                document.getElementById('emailRecipientsSection').style.display = view === 'recipients' ? 'block' : 'none';
                document.getElementById('emailTemplateSection').style.display = view === 'template' ? 'block' : 'none';
                document.getElementById('emailPreviewSection').style.display = view === 'preview' ? 'block' : 'none';
            }

            function switchAnalysisView(view) {
                const viewBtns = document.querySelectorAll('#analysisViewToggle .view-btn');
                viewBtns.forEach(btn => {
                    if (btn.dataset.view === view) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
                
                // Show/hide sections
                document.getElementById('predictiveAnalysisSection').style.display = view === 'predictive' ? 'block' : 'none';
                document.getElementById('correlationAnalysisSection').style.display = view === 'correlation' ? 'block' : 'none';
                document.getElementById('trendAnalysisSection').style.display = view === 'trend' ? 'block' : 'none';
                document.getElementById('anomalyDetectionSection').style.display = view === 'anomaly' ? 'block' : 'none';
                
                // Initialize charts for the selected view
                setTimeout(() => {
                    initializeAnalysisCharts(view);
                }, 100);
            }

            // Function to access cloud data and display ALL data - UPDATED with subject teacher and recorded_by fields
            async function accessCloudData() {
                try {
                    // Update preview info
                    document.getElementById('previewAcademicYear').textContent = 'All Years';
                    document.getElementById('previewExamType').textContent = 'All';
                    document.getElementById('previewForm').textContent = 'All Grades';
                    document.getElementById('previewStream').textContent = 'All Streams';
                    
                    console.log('Accessing ALL cloud data from student_scores table...');
                    
                    // Show loading indicator
                    const tableBody = document.getElementById('resultsTableBody');
                    const tableHeader = document.getElementById('resultsTableHeader');
                    if (tableBody && tableHeader) {
                        tableHeader.innerHTML = '';
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="${tableColumns.length}" style="text-align: center; padding: 40px;">
                                    <div class="loading-spinner">
                                        <div class="spinner"></div>
                                    </div>
                                    <p style="margin-top: 15px; color: #666;">Accessing cloud data from database...</p>
                                </td>
                            </tr>
                        `;
                    }
                    
                    // STEP 1: Get ALL scores from student_scores
                    const { data: scoresData, error: scoresError } = await supabase
                        .from('student_scores')
                        .select('*');
                    
                    if (scoresError) {
                        console.error('Error fetching scores:', scoresError);
                        alert('Error loading data: ' + scoresError.message);
                        return;
                    }
                    
                    console.log('ALL scores data loaded:', scoresData?.length || 0, 'records');
                    
                    if (!scoresData || scoresData.length === 0) {
                        if (tableBody) {
                            tableBody.innerHTML = `
                                <tr>
                                    <td colspan="${tableColumns.length}" style="text-align: center; padding: 40px; color: #666;">
                                        <i class="fas fa-database" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                                        <h3>No data found in student_scores table</h3>
                                        <p>The cloud database table is empty. Add some scores first.</p>
                                    </td>
                                </tr>
                            `;
                        }
                        document.getElementById('previewRecordCount').textContent = '0';
                        // Hide pagination controls
                        document.getElementById('paginationControls').style.display = 'none';
                        document.getElementById('paginationControlsBottom').style.display = 'none';
                        return;
                    }
                    
                    // STEP 2: Get all subject_component_ids from scores
                    const componentIds = [...new Set(scoresData
                        .map(score => score.subject_component_id)
                        .filter(Boolean))];
                    
                    console.log('Component IDs found:', componentIds.length);
                    
                    // STEP 3: Fetch subject components
                    let componentsMap = {};
                    if (componentIds.length > 0) {
                        const { data: componentsData, error: componentsError } = await supabase
                            .from('subject_components')
                            .select('*')
                            .in('id', componentIds);
                        
                        if (!componentsError && componentsData) {
                            componentsData.forEach(component => {
                                componentsMap[component.id] = component;
                            });
                            console.log('Subject components loaded:', componentsData.length);
                        }
                    }
                    
                    // STEP 4: Get unique student IDs
                    const studentIds = [...new Set(scoresData.map(score => score.student_id).filter(Boolean))];
                    console.log('Unique student IDs:', studentIds.length);
                    
                    // STEP 5: Fetch student details
                    let studentsMap = {};
                    if (studentIds.length > 0) {
                        const { data: studentsData, error: studentsError } = await supabase
                            .from('students')
                            .select('*')
                            .in('id', studentIds);
                        
                        if (!studentsError && studentsData) {
                            studentsData.forEach(student => {
                                studentsMap[student.id] = student;
                            });
                            console.log('Students loaded:', studentsData.length);
                        }
                    }
                    
                    // STEP 6: Get teacher information - NEW SECTION
                    let teachersMap = {};
                    // Extract teacher IDs from components and scores
                    const teacherIdsFromComponents = [...new Set(Object.values(componentsMap)
                        .map(comp => comp.teacher_id)
                        .filter(Boolean))];

                    const teacherIdsFromScores = [...new Set(scoresData
                        .map(score => score.recorded_by)
                        .filter(Boolean))];

                    const allTeacherIds = [...new Set([...teacherIdsFromComponents, ...teacherIdsFromScores])];

                    if (allTeacherIds.length > 0) {
                        const { data: teachersData, error: teachersError } = await supabase
                            .from('teachers')
                            .select('*')
                            .in('id', allTeacherIds);
                        
                        if (!teachersError && teachersData) {
                            teachersData.forEach(teacher => {
                                teachersMap[teacher.id] = teacher;
                            });
                            console.log('Teachers loaded:', teachersData.length);
                        }
                    }
                    
                    // STEP 7: Prepare table data with achievement level and description - UPDATED with new fields
                    const tableData = [];
                    
                    scoresData.forEach((item, index) => {
                        const student = studentsMap[item.student_id];
                        const component = componentsMap[item.subject_component_id];
                        
                        // Calculate percentage
                        let percentageScore = item.percentage_score || 0;
                        if (item.score !== null && item.max_score && item.max_score > 0) {
                            percentageScore = (item.score / item.max_score) * 100;
                        }
                        
                        // Get achievement level and description
                        const achievementInfo = getAchievementLevelAndDescription(percentageScore);
                        
                        // Get subject details from component
                        let subjectCode = 'N/A';
                        let componentName = 'N/A';
                        let subjectTeacher = 'N/A';
                        
                        if (component) {
                            subjectCode = component.subject_code || 'N/A';
                            componentName = component.component_name || 'N/A';
                            
                            // Get subject teacher from component - NEW
                            if (component.teacher_id && teachersMap[component.teacher_id]) {
                                subjectTeacher = teachersMap[component.teacher_id].full_name || 'N/A';
                            } else if (component.teacher_id) {
                                subjectTeacher = `Teacher ID: ${component.teacher_id}`;
                            }
                        } else if (item.subject_code) {
                            // Fallback to subject_code from score if available
                            subjectCode = item.subject_code;
                        }
                        
                        // Get recorded by information - NEW
                        let recordedBy = 'N/A';
                        if (item.recorded_by) {
                            if (teachersMap[item.recorded_by]) {
                                recordedBy = teachersMap[item.recorded_by].full_name || `ID: ${item.recorded_by}`;
                            } else {
                                recordedBy = `ID: ${item.recorded_by}`;
                            }
                        }
                        
                        // Use exam_type if available, otherwise use term
                        const examType = item.exam_type || item.term || 'N/A';
                        
                        tableData.push({
                            id: index + 1,
                            student_id: item.student_id,
                            admission_no: student?.admission_no || 'N/A',
                            student_name: student?.full_name || 'Unknown Student',
                            grade: student?.form_grade || 'N/A',
                            stream: student?.stream || 'N/A',
                            subject_code: subjectCode,
                            component_name: componentName,
                            subject_teacher: subjectTeacher, // NEW FIELD
                            recorded_by: recordedBy, // NEW FIELD
                            score: item.score || 0,
                            max_score: item.max_score || component?.max_score || 0,
                            percentage: parseFloat(percentageScore.toFixed(2)),
                            grade_letter: calculateGradeFromScore(percentageScore),
                            achievement_level: achievementInfo.level,
                            achievement_description: achievementInfo.description,
                            exam_type: examType,
                            term: item.term || 'N/A',
                            academic_year: item.academic_year || 'N/A',
                            assessment_type: item.assessment_type || 'N/A',
                            remarks: item.remarks || '',
                            recorded_at: item.recorded_at ? new Date(item.recorded_at).toLocaleDateString() : 'N/A'
                        });
                    });
                    
                    // Update record count
                    document.getElementById('previewRecordCount').textContent = tableData.length;
                    
                    // Store compiled results for pagination
                    compiledResults = tableData;
                    
                    // Initialize pagination
                    currentPage = 1;
                    pageSize = parseInt(document.getElementById('pageSize')?.value || 100);
                    updatePagination();
                    
                    // Generate table with pagination
                    generatePaginatedTable();
                    
                    console.log('Table data prepared:', tableData.length, 'rows');
                    
                    // Show pagination controls
                    document.getElementById('paginationControls').style.display = 'flex';
                    document.getElementById('paginationControlsBottom').style.display = 'flex';
                    
                    // Populate filter dropdowns after loading data
                    populateFilterDropdowns();
                    
                } catch (error) {
                    console.error('Error accessing cloud data:', error);
                    alert('Error: ' + error.message);
                }
            }

            // NEW FUNCTIONS FOR FILTER AND COMPUTE

            // Function to populate filter dropdowns
            function populateFilterDropdowns() {
                // Populate streams
                const streams = [...new Set(allStudents.map(student => student.stream).filter(Boolean))];
                const filterStreamSelect = document.getElementById('filterStream');
                if (filterStreamSelect) {
                    filterStreamSelect.innerHTML = '<option value="">All Streams</option>';
                    streams.forEach(stream => {
                        const option = document.createElement('option');
                        option.value = stream;
                        option.textContent = stream;
                        filterStreamSelect.appendChild(option);
                    });
                }
                
                // Populate years from scores data
                const years = [...new Set(allScores.map(score => score.academic_year).filter(Boolean))];
                const filterYearSelect = document.getElementById('filterYear');
                if (filterYearSelect) {
                    filterYearSelect.innerHTML = '<option value="">All Years</option>';
                    years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        filterYearSelect.appendChild(option);
                    });
                }
                
                // Populate recorded by (teachers)
                const recordedByOptions = [];
                const teacherMap = {};
                
                // Get unique teacher IDs from scores
                const teacherIds = [...new Set(allScores.map(score => score.recorded_by).filter(Boolean))];
                teacherIds.forEach(teacherId => {
                    const teacher = teacherData.find(t => t.id === teacherId);
                    if (teacher) {
                        teacherMap[teacherId] = teacher.full_name;
                        recordedByOptions.push({
                            id: teacherId,
                            name: teacher.full_name
                        });
                    } else {
                        teacherMap[teacherId] = `Teacher ID: ${teacherId}`;
                        recordedByOptions.push({
                            id: teacherId,
                            name: `Teacher ID: ${teacherId}`
                        });
                    }
                });
                
                // Sort by name
                recordedByOptions.sort((a, b) => a.name.localeCompare(b.name));
                
                const filterRecordedBySelect = document.getElementById('filterRecordedBy');
                if (filterRecordedBySelect) {
                    filterRecordedBySelect.innerHTML = '<option value="">All Teachers</option>';
                    recordedByOptions.forEach(option => {
                        const optElement = document.createElement('option');
                        optElement.value = option.id;
                        optElement.textContent = option.name;
                        filterRecordedBySelect.appendChild(optElement);
                    });
                }
            }

            // Function to show/hide filter form
            function toggleFilterForm() {
                const isVisible = filterFormSection.style.display === 'block';
                filterFormSection.style.display = isVisible ? 'none' : 'block';
                computationResultsSection.style.display = 'none';
                
                // Update button text/icon
                if (isVisible) {
                    filterComputeBtn.innerHTML = '<i class="fas fa-filter"></i> Filter & Compute';
                    filterComputeBtn.classList.remove('btn-outline');
                    filterComputeBtn.classList.add('btn-warning');
                } else {
                    filterComputeBtn.innerHTML = '<i class="fas fa-times"></i> Close Filter';
                    filterComputeBtn.classList.remove('btn-warning');
                    filterComputeBtn.classList.add('btn-outline');
                }
            }

            // Function to apply filters to the data
            async function applyFilters() {
                const filterGrade = document.getElementById('filterGrade')?.value || '';
                const filterStream = document.getElementById('filterStream')?.value || '';
                const filterExamType = document.getElementById('filterExamType')?.value || '';
                const filterTerm = document.getElementById('filterTerm')?.value || '';
                const filterYear = document.getElementById('filterYear')?.value || '';
                const filterRecordedBy = document.getElementById('filterRecordedBy')?.value || '';

                // Show human-friendly Grade label in preview
                let previewGradeLabel = 'All Grades';
                if (filterGrade) {
                    if (filterGrade.startsWith('grade_')) {
                        const num = filterGrade.split('_')[1];
                        previewGradeLabel = `Grade ${num}`;
                    } else {
                        previewGradeLabel = filterGrade;
                    }
                }
                document.getElementById('previewAcademicYear').textContent = filterYear || 'All Years';
                document.getElementById('previewExamType').textContent = filterExamType || 'All';
                document.getElementById('previewForm').textContent = previewGradeLabel;
                document.getElementById('previewStream').textContent = filterStream || 'All Streams';

                // Reset to page 1 when applying filters
                currentPage = 1;

                // Store filter values globally
                currentFilters = {
                    grade: filterGrade,
                    stream: filterStream,
                    examType: filterExamType,
                    term: filterTerm,
                    year: filterYear,
                    recordedBy: filterRecordedBy
                };

                // Filter the data
                await filterAndUpdateData();

                // Hide filter form after applying
                toggleFilterForm();
            }

            // Function to filter data based on selected filters
            async function filterAndUpdateData() {
                try {
                    console.log('Applying filters:', currentFilters);
                    
                    // Show loading state
                    const tableBody = document.getElementById('resultsTableBody');
                    const tableHeader = document.getElementById('resultsTableHeader');
                    if (tableBody && tableHeader) {
                        tableHeader.innerHTML = '';
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="${tableColumns.length}" style="text-align: center; padding: 40px;">
                                    <div class="loading-spinner">
                                        <div class="spinner"></div>
                                    </div>
                                    <p style="margin-top: 15px; color: #666;">Filtering data...</p>
                                </td>
                            </tr>
                        `;
                    }
                    
                    // STEP 1: Build the query for student_scores
                    let query = supabase
                        .from('student_scores')
                        .select('*');
                    
                    // Apply filters
                    if (currentFilters.year) {
                        query = query.eq('academic_year', currentFilters.year);
                    }
                    
                    if (currentFilters.examType) {
                        query = query.eq('exam_type', currentFilters.examType);
                    }
                    
                    if (currentFilters.term) {
                        query = query.eq('term', currentFilters.term);
                    }
                    
                    if (currentFilters.recordedBy) {
                        query = query.eq('recorded_by', currentFilters.recordedBy);
                    }
                    
                    // Execute the query
                    const { data: filteredScores, error: scoresError } = await query;
                    
                    if (scoresError) {
                        console.error('Error fetching filtered scores:', scoresError);
                        alert('Error loading filtered data: ' + scoresError.message);
                        return;
                    }
                    
                    console.log('Filtered scores data loaded:', filteredScores?.length || 0, 'records');
                    
                    if (!filteredScores || filteredScores.length === 0) {
                        if (tableBody) {
                            tableBody.innerHTML = `
                                <tr>
                                    <td colspan="${tableColumns.length}" style="text-align: center; padding: 40px; color: #666;">
                                        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                                        <h3>No data found with selected filters</h3>
                                        <p>Try adjusting your filter criteria.</p>
                                    </td>
                                </tr>
                            `;
                        }
                        document.getElementById('previewRecordCount').textContent = '0';
                        // Hide pagination controls
                        document.getElementById('paginationControls').style.display = 'none';
                        document.getElementById('paginationControlsBottom').style.display = 'none';
                        
                        // Clear compiled results
                        compiledResults = [];
                        return;
                    }
                    
                    // STEP 2: Get student IDs from filtered scores
                    const studentIds = [...new Set(filteredScores.map(score => score.student_id).filter(Boolean))];
                    
                    // STEP 3: Fetch student details with additional filters if needed
                    let studentQuery = supabase
                        .from('students')
                        .select('*')
                        .in('id', studentIds);
                    
                    if (currentFilters.grade) {
                        studentQuery = studentQuery.eq('form_grade', currentFilters.grade);
                    }
                    
                    if (currentFilters.stream) {
                        studentQuery = studentQuery.eq('stream', currentFilters.stream);
                    }
                    
                    const { data: filteredStudents, error: studentsError } = await studentQuery;
                    
                    if (studentsError) {
                        console.error('Error fetching filtered students:', studentsError);
                        // Continue with all students if there's an error
                    }
                    
                    // Create students map
                    let studentsMap = {};
                    const validStudentIds = new Set();
                    
                    if (filteredStudents) {
                        filteredStudents.forEach(student => {
                            studentsMap[student.id] = student;
                            validStudentIds.add(student.id);
                        });
                    }
                    
                    // STEP 4: Filter scores based on student filters
                    const finalScores = filteredScores.filter(score => {
                        // If we have student filters and the student doesn't match, exclude the score
                        if ((currentFilters.grade || currentFilters.stream) && !validStudentIds.has(score.student_id)) {
                            return false;
                        }
                        return true;
                    });
                    
                    // STEP 5: Get subject components
                    const componentIds = [...new Set(finalScores
                        .map(score => score.subject_component_id)
                        .filter(Boolean))];
                    
                    let componentsMap = {};
                    if (componentIds.length > 0) {
                        const { data: componentsData, error: componentsError } = await supabase
                            .from('subject_components')
                            .select('*')
                            .in('id', componentIds);
                        
                        if (!componentsError && componentsData) {
                            componentsData.forEach(component => {
                                componentsMap[component.id] = component;
                            });
                        }
                    }
                    
                    // STEP 6: Get teacher information
                    let teachersMap = {};
                    const teacherIdsFromComponents = [...new Set(Object.values(componentsMap)
                        .map(comp => comp.teacher_id)
                        .filter(Boolean))];

                    const teacherIdsFromScores = [...new Set(finalScores
                        .map(score => score.recorded_by)
                        .filter(Boolean))];

                    const allTeacherIds = [...new Set([...teacherIdsFromComponents, ...teacherIdsFromScores])];

                    if (allTeacherIds.length > 0) {
                        const { data: teachersData, error: teachersError } = await supabase
                            .from('teachers')
                            .select('*')
                            .in('id', allTeacherIds);
                        
                        if (!teachersError && teachersData) {
                            teachersData.forEach(teacher => {
                                teachersMap[teacher.id] = teacher;
                            });
                        }
                    }
                    
                    // STEP 7: Prepare table data
                    const tableData = [];
                    
                    finalScores.forEach((item, index) => {
                        const student = studentsMap[item.student_id];
                        const component = componentsMap[item.subject_component_id];
                        
                        // Calculate percentage
                        let percentageScore = item.percentage_score || 0;
                        if (item.score !== null && item.max_score && item.max_score > 0) {
                            percentageScore = (item.score / item.max_score) * 100;
                        }
                        
                        // Get achievement level and description
                        const achievementInfo = getAchievementLevelAndDescription(percentageScore);
                        
                        // Get subject details from component
                        let subjectCode = 'N/A';
                        let componentName = 'N/A';
                        let subjectTeacher = 'N/A';
                        
                        if (component) {
                            subjectCode = component.subject_code || 'N/A';
                            componentName = component.component_name || 'N/A';
                            
                            // Get subject teacher from component
                            if (component.teacher_id && teachersMap[component.teacher_id]) {
                                subjectTeacher = teachersMap[component.teacher_id].full_name || 'N/A';
                            } else if (component.teacher_id) {
                                subjectTeacher = `Teacher ID: ${component.teacher_id}`;
                            }
                        } else if (item.subject_code) {
                            // Fallback to subject_code from score if available
                            subjectCode = item.subject_code;
                        }
                        
                        // Get recorded by information
                        let recordedBy = 'N/A';
                        if (item.recorded_by) {
                            if (teachersMap[item.recorded_by]) {
                                recordedBy = teachersMap[item.recorded_by].full_name || `ID: ${item.recorded_by}`;
                            } else {
                                recordedBy = `ID: ${item.recorded_by}`;
                            }
                        }
                        
                        // Use exam_type if available, otherwise use term
                        const examType = item.exam_type || item.term || 'N/A';
                        
                        tableData.push({
                            id: index + 1,
                            student_id: item.student_id,
                            admission_no: student?.admission_no || 'N/A',
                            student_name: student?.full_name || 'Unknown Student',
                            grade: student?.form_grade || 'N/A',
                            stream: student?.stream || 'N/A',
                            subject_code: subjectCode,
                            component_name: componentName,
                            subject_teacher: subjectTeacher,
                            recorded_by: recordedBy,
                            score: item.score || 0,
                            max_score: item.max_score || component?.max_score || 0,
                            percentage: parseFloat(percentageScore.toFixed(2)),
                            grade_letter: calculateGradeFromScore(percentageScore),
                            achievement_level: achievementInfo.level,
                            achievement_description: achievementInfo.description,
                            exam_type: examType,
                            term: item.term || 'N/A',
                            academic_year: item.academic_year || 'N/A',
                            assessment_type: item.assessment_type || 'N/A',
                            remarks: item.remarks || '',
                            recorded_at: item.recorded_at ? new Date(item.recorded_at).toLocaleDateString() : 'N/A'
                        });
                    });
                    
                    // Update record count
                    document.getElementById('previewRecordCount').textContent = tableData.length;
                    
                    // Store compiled results for pagination
                    compiledResults = tableData;
                    
                    // Initialize pagination
                    currentPage = 1;
                    pageSize = parseInt(document.getElementById('pageSize')?.value || 100);
                    updatePagination();
                    
                    // Generate table with pagination
                    generatePaginatedTable();
                    
                    console.log('Filtered table data prepared:', tableData.length, 'rows');
                    
                    // Show pagination controls
                    document.getElementById('paginationControls').style.display = 'flex';
                    document.getElementById('paginationControlsBottom').style.display = 'flex';
                    
                } catch (error) {
                    console.error('Error filtering data:', error);
                    alert('Error filtering data: ' + error.message);
                }
            }

            // Function to clear all filters
            function clearFilters() {
                // Reset all filter dropdowns
                document.getElementById('filterGrade').value = '';
                document.getElementById('filterStream').value = '';
                document.getElementById('filterExamType').value = '';
                document.getElementById('filterTerm').value = '';
                document.getElementById('filterYear').value = '';
                document.getElementById('filterRecordedBy').value = '';
                
                // Clear filter data
                currentFilters = {};
                
                // Reload all data without filters
                accessCloudData();
                
                // Update preview info
                document.getElementById('previewAcademicYear').textContent = 'All Years';
                document.getElementById('previewExamType').textContent = 'All';
                document.getElementById('previewForm').textContent = 'All Grades';
                document.getElementById('previewStream').textContent = 'All Streams';
                
                // Hide filter form
                toggleFilterForm();
            }

            // Enhanced Function to compute aggregates with comprehensive ranking
            function computeAggregates() {
                if (!compiledResults || compiledResults.length === 0) {
                    alert('No data available for computation. Please load data first.');
                    return;
                }
                
                // Show computation results section
                filterFormSection.style.display = 'none';
                computationResultsSection.style.display = 'block';
                
                // Calculate aggregates with comprehensive ranking
                const aggregates = calculateAggregates(compiledResults);
                
                // Display aggregates with ranking
                displayComputationResults(aggregates);
            }

            // Enhanced Function to calculate various aggregates with comprehensive ranking
            function calculateAggregates(data) {
                if (!data || data.length === 0) {
                    return {};
                }
                
                // Group data by student (admission_no)
                const studentGroups = {};
                const teacherGroups = {}; // Changed to use recorded_by instead of subject_teacher
                const subjectGroups = {};
                const streamGroups = {};
                const gradeGroups = {};
                
                // Process all data records
                data.forEach(item => {
                    const studentId = item.admission_no || item.student_id;
                    const teacherId = item.recorded_by || 'Unknown'; // Using recorded_by for teacher ranking
                    const subject = item.subject_code || 'Unknown';
                    const stream = item.stream || 'Unknown';
                    const grade = item.grade || 'Unknown';
                    const percentage = parseFloat(item.percentage) || 0;
                    
                    // Group by student
                    if (!studentGroups[studentId]) {
                        studentGroups[studentId] = {
                            name: item.student_name || 'Unknown',
                            totalScore: 0,
                            count: 0,
                            subjects: new Set(),
                            stream: stream,
                            grade: grade,
                            scores: [],
                            teacherCount: new Set() // Count unique teachers
                        };
                    }
                    studentGroups[studentId].totalScore += percentage;
                    studentGroups[studentId].count += 1;
                    studentGroups[studentId].scores.push(percentage);
                    studentGroups[studentId].subjects.add(subject);
                    studentGroups[studentId].teacherCount.add(teacherId);
                    
                    // Group by teacher (using recorded_by)
                    if (!teacherGroups[teacherId]) {
                        teacherGroups[teacherId] = {
                            name: teacherId, // Using recorded_by as teacher identifier
                            totalScore: 0,
                            count: 0,
                            students: new Set(),
                            subjects: new Set()
                        };
                    }
                    teacherGroups[teacherId].totalScore += percentage;
                    teacherGroups[teacherId].count += 1;
                    teacherGroups[teacherId].students.add(studentId);
                    teacherGroups[teacherId].subjects.add(subject);
                    
                    // Group by subject
                    if (!subjectGroups[subject]) {
                        subjectGroups[subject] = {
                            totalScore: 0,
                            count: 0,
                            students: new Set(),
                            teachers: new Set()
                        };
                    }
                    subjectGroups[subject].totalScore += percentage;
                    subjectGroups[subject].count += 1;
                    subjectGroups[subject].students.add(studentId);
                    subjectGroups[subject].teachers.add(teacherId);
                    
                    // Group by stream
                    if (!streamGroups[stream]) {
                        streamGroups[stream] = {
                            totalScore: 0,
                            count: 0,
                            students: new Set(),
                            subjects: new Set()
                        };
                    }
                    streamGroups[stream].totalScore += percentage;
                    streamGroups[stream].count += 1;
                    streamGroups[stream].students.add(studentId);
                    streamGroups[stream].subjects.add(subject);
                    
                    // Group by grade
                    if (!gradeGroups[grade]) {
                        gradeGroups[grade] = {
                            totalScore: 0,
                            count: 0,
                            students: new Set(),
                            streams: new Set()
                        };
                    }
                    gradeGroups[grade].totalScore += percentage;
                    gradeGroups[grade].count += 1;
                    gradeGroups[grade].students.add(studentId);
                    gradeGroups[grade].streams.add(stream);
                });
                
                // Calculate averages and prepare rankings
                
                // 1. Student ranking
                const studentRanking = Object.entries(studentGroups).map(([studentId, data]) => ({
                    id: studentId,
                    name: data.name,
                    average: data.count > 0 ? data.totalScore / data.count : 0,
                    totalScore: data.totalScore,
                    count: data.count,
                    stream: data.stream,
                    grade: data.grade,
                    subjectCount: data.subjects.size,
                    teacherCount: data.teacherCount.size,
                    scores: data.scores
                })).sort((a, b) => b.average - a.average);
                
                // Add rank positions
                studentRanking.forEach((student, index) => {
                    student.rank = index + 1;
                    student.position = getOrdinal(index + 1);
                });
                
                // 2. Teacher ranking (using recorded_by)
                const teacherRanking = Object.entries(teacherGroups).map(([teacherId, data]) => ({
                    id: teacherId,
                    name: data.name,
                    average: data.count > 0 ? data.totalScore / data.count : 0,
                    totalScore: data.totalScore,
                    count: data.count,
                    studentCount: data.students.size,
                    subjectCount: data.subjects.size
                })).sort((a, b) => b.average - a.average);
                
                // Add rank positions
                teacherRanking.forEach((teacher, index) => {
                    teacher.rank = index + 1;
                    teacher.position = getOrdinal(index + 1);
                });
                
                // 3. Subject ranking
                const subjectRanking = Object.entries(subjectGroups).map(([subject, data]) => ({
                    name: subject,
                    average: data.count > 0 ? data.totalScore / data.count : 0,
                    totalScore: data.totalScore,
                    count: data.count,
                    studentCount: data.students.size,
                    teacherCount: data.teachers.size
                })).sort((a, b) => b.average - a.average);
                
                // Add rank positions
                subjectRanking.forEach((subject, index) => {
                    subject.rank = index + 1;
                    subject.position = getOrdinal(index + 1);
                });
                
                // 4. Stream ranking
                const streamRanking = Object.entries(streamGroups).map(([stream, data]) => ({
                    name: stream,
                    average: data.count > 0 ? data.totalScore / data.count : 0,
                    totalScore: data.totalScore,
                    count: data.count,
                    studentCount: data.students.size,
                    subjectCount: data.subjects.size
                })).sort((a, b) => b.average - a.average);
                
                // Add rank positions
                streamRanking.forEach((stream, index) => {
                    stream.rank = index + 1;
                    stream.position = getOrdinal(index + 1);
                });
                
                // 5. Grade ranking
                const gradeRanking = Object.entries(gradeGroups).map(([grade, data]) => ({
                    name: grade,
                    average: data.count > 0 ? data.totalScore / data.count : 0,
                    totalScore: data.totalScore,
                    count: data.count,
                    studentCount: data.students.size,
                    streamCount: data.streams.size
                })).sort((a, b) => b.average - a.average);
                
                // Add rank positions
                gradeRanking.forEach((grade, index) => {
                    grade.rank = index + 1;
                    grade.position = getOrdinal(index + 1);
                });
                
                // Calculate overall statistics
                const allScores = data.map(item => parseFloat(item.percentage)).filter(score => !isNaN(score));
                
                const aggregates = {
                    totalRecords: data.length,
                    uniqueStudents: studentRanking.length,
                    uniqueTeachers: teacherRanking.length,
                    uniqueSubjects: subjectRanking.length,
                    uniqueStreams: streamRanking.length,
                    uniqueGrades: gradeRanking.length,
                    
                    // Rankings
                    studentRanking: studentRanking,
                    teacherRanking: teacherRanking,
                    subjectRanking: subjectRanking,
                    streamRanking: streamRanking,
                    gradeRanking: gradeRanking,
                    
                    // Top performers
                    topStudents: studentRanking.slice(0, 10),
                    topTeachers: teacherRanking.slice(0, 10),
                    topSubjects: subjectRanking.slice(0, 10),
                    topStreams: streamRanking.slice(0, 5),
                    
                    // Overall statistics
                    scores: allScores,
                    overallMean: allScores.length > 0 ? allScores.reduce((a, b) => a + b, 0) / allScores.length : 0,
                    highestScore: allScores.length > 0 ? Math.max(...allScores) : 0,
                    lowestScore: allScores.length > 0 ? Math.min(...allScores) : 0,
                    
                    // Grade distribution
                    gradeDistribution: {},
                    
                    // Additional insights
                    insights: {
                        strongestSubject: subjectRanking.length > 0 ? subjectRanking[0] : null,
                        strongestTeacher: teacherRanking.length > 0 ? teacherRanking[0] : null,
                        strongestStream: streamRanking.length > 0 ? streamRanking[0] : null,
                        strongestGrade: gradeRanking.length > 0 ? gradeRanking[0] : null,
                        topStudent: studentRanking.length > 0 ? studentRanking[0] : null
                    }
                };
                
                // Calculate standard deviation if we have scores
                if (allScores.length > 0) {
                    const squareDiffs = allScores.map(score => Math.pow(score - aggregates.overallMean, 2));
                    const avgSquareDiff = squareDiffs.reduce((a, b) => a + b, 0) / allScores.length;
                    aggregates.standardDeviation = Math.sqrt(avgSquareDiff);
                    
                    // Calculate median
                    const sortedScores = [...allScores].sort((a, b) => a - b);
                    const mid = Math.floor(sortedScores.length / 2);
                    aggregates.median = sortedScores.length % 2 !== 0 ? 
                        sortedScores[mid] : 
                        (sortedScores[mid - 1] + sortedScores[mid]) / 2;
                    
                    // Calculate quartiles
                    aggregates.firstQuartile = sortedScores[Math.floor(sortedScores.length * 0.25)];
                    aggregates.thirdQuartile = sortedScores[Math.floor(sortedScores.length * 0.75)];
                    
                    // Top 10% and bottom 10%
                    const top10Count = Math.ceil(allScores.length * 0.1);
                    const top10Scores = sortedScores.slice(-top10Count);
                    aggregates.top10Avg = top10Scores.reduce((a, b) => a + b, 0) / top10Scores.length;
                    
                    const bottom10Scores = sortedScores.slice(0, top10Count);
                    aggregates.bottom10Avg = bottom10Scores.reduce((a, b) => a + b, 0) / bottom10Scores.length;
                }
                
                // Calculate grade distribution
                data.forEach(item => {
                    const grade = item.grade_letter || 'N/A';
                    aggregates.gradeDistribution[grade] = (aggregates.gradeDistribution[grade] || 0) + 1;
                });
                
                return aggregates;
            }

            // Helper function to get ordinal position (1st, 2nd, 3rd, etc.)
            function getOrdinal(n) {
                const s = ["th", "st", "nd", "rd"];
                const v = n % 100;
                return n + (s[(v - 20) % 10] || s[v] || s[0]);
            }

            // Enhanced Function to display computation results with comprehensive ranking
            function displayComputationResults(aggregates) {
                const resultsGrid = document.getElementById('computationResultsGrid');
                if (!resultsGrid) return;
                
                resultsGrid.innerHTML = '';
                
                // Basic statistics
                resultsGrid.innerHTML += `
                    <div class="stat-card">
                        <div class="stat-label">Total Records</div>
                        <div class="stat-value">${aggregates.totalRecords}</div>
                        <div style="font-size: 0.8rem; color: var(--muted-green);">
                            ${aggregates.uniqueStudents} students | ${aggregates.uniqueTeachers} teachers
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-label">Overall Mean</div>
                        <div class="stat-value">${aggregates.overallMean ? aggregates.overallMean.toFixed(2) + '%' : 'N/A'}</div>
                        <div style="font-size: 0.8rem; color: var(--muted-green);">
                            Median: ${aggregates.median ? aggregates.median.toFixed(2) + '%' : 'N/A'}
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-label">Score Range</div>
                        <div class="stat-value">${aggregates.highestScore ? aggregates.highestScore.toFixed(2) + '%' : 'N/A'}</div>
                        <div style="font-size: 0.8rem; color: var(--muted-green);">
                            Min: ${aggregates.lowestScore ? aggregates.lowestScore.toFixed(2) + '%' : 'N/A'}
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-label">Std Deviation</div>
                        <div class="stat-value">${aggregates.standardDeviation ? aggregates.standardDeviation.toFixed(2) : 'N/A'}</div>
                        <div style="font-size: 0.8rem; color: var(--muted-green);">
                            ${aggregates.top10Avg ? 'Top 10%: ' + aggregates.top10Avg.toFixed(2) + '%' : ''}
                        </div>
                    </div>
                `;
                
                // Top Student
                if (aggregates.topStudents && aggregates.topStudents.length > 0) {
                    const topStudent = aggregates.topStudents[0];
                    resultsGrid.innerHTML += `
                        <div class="stat-card">
                            <div class="stat-label">Top Student (#${topStudent.rank})</div>
                            <div class="stat-value">${topStudent.name}</div>
                            <div style="font-size: 0.8rem; color: var(--muted-green);">
                                Avg: ${topStudent.average.toFixed(2)}% | Stream: ${topStudent.stream}
                            </div>
                        </div>
                    `;
                }
                
                // Top Teacher (using recorded_by)
                if (aggregates.topTeachers && aggregates.topTeachers.length > 0) {
                    const topTeacher = aggregates.topTeachers[0];
                    resultsGrid.innerHTML += `
                        <div class="stat-card">
                            <div class="stat-label">Top Teacher (#${topTeacher.rank})</div>
                            <div class="stat-value">${topTeacher.name.length > 15 ? topTeacher.name.substring(0, 12) + '...' : topTeacher.name}</div>
                            <div style="font-size: 0.8rem; color: var(--muted-green);">
                                Avg: ${topTeacher.average.toFixed(2)}% | Students: ${topTeacher.studentCount}
                            </div>
                        </div>
                    `;
                }
                
                // Top Subject
                if (aggregates.topSubjects && aggregates.topSubjects.length > 0) {
                    const topSubject = aggregates.topSubjects[0];
                    resultsGrid.innerHTML += `
                        <div class="stat-card">
                            <div class="stat-label">Top Subject (#${topSubject.rank})</div>
                            <div class="stat-value">${topSubject.name}</div>
                            <div style="font-size: 0.8rem; color: var(--muted-green);">
                                Avg: ${topSubject.average.toFixed(2)}% | Students: ${topSubject.studentCount}
                            </div>
                        </div>
                    `;
                }
                
                // Top Stream
                if (aggregates.topStreams && aggregates.topStreams.length > 0) {
                    const topStream = aggregates.topStreams[0];
                    resultsGrid.innerHTML += `
                        <div class="stat-card">
                            <div class="stat-label">Top Stream (#${topStream.rank})</div>
                            <div class="stat-value">${topStream.name}</div>
                            <div style="font-size: 0.8rem; color: var(--muted-green);">
                                Avg: ${topStream.average.toFixed(2)}% | Students: ${topStream.studentCount}
                            </div>
                        </div>
                    `;
                }
                
                // Add detailed rankings table after the stats cards
                resultsGrid.innerHTML += `
                    <div style="grid-column: 1 / -1; margin-top: 20px;">
                        <div class="view-toggle" style="margin-bottom: 15px;">
                            <button class="view-btn active" onclick="showRankingTable('students')">Students</button>
                            <button class="view-btn" onclick="showRankingTable('teachers')">Teachers</button>
                            <button class="view-btn" onclick="showRankingTable('subjects')">Subjects</button>
                            <button class="view-btn" onclick="showRankingTable('streams')">Streams</button>
                            <button class="view-btn" onclick="showRankingTable('grades')">Grades</button>
                        </div>
                        
                        <div id="rankingTableContainer" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <!-- Ranking tables will be dynamically loaded here -->
                        </div>
                    </div>
                `;
                
                // Store aggregates globally for ranking tables
                window.currentAggregates = aggregates;
                
                // Show student ranking table by default
                showRankingTable('students');
            }

            // Function to display ranking tables
            function showRankingTable(type) {
                const container = document.getElementById('rankingTableContainer');
                if (!container || !window.currentAggregates) return;
                
                // Update active button
                const viewToggle = container.parentElement.querySelector('.view-toggle');
                if (viewToggle) {
                    const buttons = viewToggle.querySelectorAll('.view-btn');
                    buttons.forEach(btn => btn.classList.remove('active'));
                    event.target.classList.add('active');
                }
                
                let tableHTML = '';
                let rankingData = [];
                let columns = [];
                
                switch(type) {
                    case 'students':
                        rankingData = window.currentAggregates.studentRanking;
                        columns = [
                            { key: 'rank', label: 'Rank', width: '80px' },
                            { key: 'name', label: 'Student Name', width: '200px' },
                            { key: 'id', label: 'Admission', width: '120px' },
                            { key: 'average', label: 'Average %', width: '100px', format: 'percent' },
                            { key: 'grade', label: 'Grade', width: '80px' },
                            { key: 'stream', label: 'Stream', width: '100px' },
                            { key: 'subjectCount', label: 'Subjects', width: '80px' }
                        ];
                        break;
                        
                    case 'teachers':
                        rankingData = window.currentAggregates.teacherRanking;
                        columns = [
                            { key: 'rank', label: 'Rank', width: '80px' },
                            { key: 'name', label: 'Teacher Name', width: '200px' },
                            { key: 'average', label: 'Avg Score %', width: '100px', format: 'percent' },
                            { key: 'studentCount', label: 'Students', width: '80px' },
                            { key: 'subjectCount', label: 'Subjects', width: '80px' },
                            { key: 'count', label: 'Records', width: '80px' }
                        ];
                        break;
                        
                    case 'subjects':
                        rankingData = window.currentAggregates.subjectRanking;
                        columns = [
                            { key: 'rank', label: 'Rank', width: '80px' },
                            { key: 'name', label: 'Subject', width: '150px' },
                            { key: 'average', label: 'Avg Score %', width: '100px', format: 'percent' },
                            { key: 'studentCount', label: 'Students', width: '80px' },
                            { key: 'teacherCount', label: 'Teachers', width: '80px' },
                            { key: 'count', label: 'Records', width: '80px' }
                        ];
                        break;
                        
                    case 'streams':
                        rankingData = window.currentAggregates.streamRanking;
                        columns = [
                            { key: 'rank', label: 'Rank', width: '80px' },
                            { key: 'name', label: 'Stream', width: '120px' },
                            { key: 'average', label: 'Avg Score %', width: '100px', format: 'percent' },
                            { key: 'studentCount', label: 'Students', width: '80px' },
                            { key: 'subjectCount', label: 'Subjects', width: '80px' },
                            { key: 'count', label: 'Records', width: '80px' }
                        ];
                        break;
                        
                    case 'grades':
                        rankingData = window.currentAggregates.gradeRanking;
                        columns = [
                            { key: 'rank', label: 'Rank', width: '80px' },
                            { key: 'name', label: 'Grade', width: '100px' },
                            { key: 'average', label: 'Avg Score %', width: '100px', format: 'percent' },
                            { key: 'studentCount', label: 'Students', width: '80px' },
                            { key: 'streamCount', label: 'Streams', width: '80px' },
                            { key: 'count', label: 'Records', width: '80px' }
                        ];
                        break;
                }
                
                if (rankingData.length === 0) {
                    tableHTML = `<p style="text-align: center; color: #666; padding: 40px;">No ${type} data available</p>`;
                } else {
                    // Limit to top 20 for display
                    const displayData = rankingData.slice(0, 20);
                    
                    tableHTML = `
                        <div style="overflow-x: auto; max-height: 400px; border: 1px solid #ddd; border-radius: 8px;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                <thead style="background-color: var(--exam-office-purple); color: white; position: sticky; top: 0;">
                                    <tr>
                                        ${columns.map(col => `<th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd; min-width: ${col.width};">${col.label}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${displayData.map((item, index) => {
                                        const rowColor = index < 3 ? 
                                            index === 0 ? '#e8f5e9' : // Gold
                                            index === 1 ? '#f1f8e9' : // Silver
                                            '#f9fbe7' : // Bronze
                                            index % 2 === 0 ? '#f9f9f9' : 'white';
                                        
                                        return `
                                            <tr style="background-color: ${rowColor};">
                                                ${columns.map(col => {
                                                    let cellValue = item[col.key] || '';
                                                    if (col.format === 'percent' && typeof cellValue === 'number') {
                                                        cellValue = cellValue.toFixed(2) + '%';
                                                    }
                                                    if (col.key === 'rank') {
                                                        // Add medal emojis for top 3
                                                        if (item.rank === 1) cellValue = ' ' + cellValue;
                                                        else if (item.rank === 2) cellValue = ' ' + cellValue;
                                                        else if (item.rank === 3) cellValue = ' ' + cellValue;
                                                    }
                                                    return `<td style="padding: 8px 10px; border-bottom: 1px solid #eee; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${cellValue}">${cellValue}</td>`;
                                                }).join('')}
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        ${rankingData.length > 20 ? `<p style="text-align: center; color: #666; margin-top: 10px;">Showing top 20 of ${rankingData.length} ${type}</p>` : ''}
                    `;
                }
                
                container.innerHTML = `
                    <h4 style="color: var(--exam-office-purple); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-trophy"></i> ${type.charAt(0).toUpperCase() + type.slice(1)} Ranking
                    </h4>
                    ${tableHTML}
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn btn-outline" onclick="exportRankingToExcel('${type}')" style="font-size: 0.9rem; padding: 5px 10px;">
                            <i class="fas fa-file-excel"></i> Export ${type}
                        </button>
                        <button class="btn btn-outline" onclick="exportRankingToPDF('${type}')" style="font-size: 0.9rem; padding: 5px 10px;">
                            <i class="fas fa-file-pdf"></i> Export ${type}
                        </button>
                    </div>
                `;
            }

            // Function to export ranking to Excel
            function exportRankingToExcel(type) {
                if (!window.currentAggregates) return;
                
                let rankingData = [];
                let fileName = '';
                
                switch(type) {
                    case 'students':
                        rankingData = window.currentAggregates.studentRanking;
                        fileName = 'Student_Ranking';
                        break;
                    case 'teachers':
                        rankingData = window.currentAggregates.teacherRanking;
                        fileName = 'Teacher_Ranking';
                        break;
                    case 'subjects':
                        rankingData = window.currentAggregates.subjectRanking;
                        fileName = 'Subject_Ranking';
                        break;
                    case 'streams':
                        rankingData = window.currentAggregates.streamRanking;
                        fileName = 'Stream_Ranking';
                        break;
                    case 'grades':
                        rankingData = window.currentAggregates.gradeRanking;
                        fileName = 'Grade_Ranking';
                        break;
                }
                
                if (rankingData.length === 0) {
                    alert(`No ${type} data to export.`);
                    return;
                }
                
                try {
                    const exportData = rankingData.map((item, index) => {
                        const exportItem = {
                            Rank: item.rank,
                            Position: item.position || ''
                        };
                        
                        switch(type) {
                            case 'students':
                                Object.assign(exportItem, {
                                    'Student Name': item.name,
                                    'Admission Number': item.id,
                                    'Average Score %': item.average.toFixed(2),
                                    'Grade': item.grade,
                                    'Stream': item.stream,
                                    'Number of Subjects': item.subjectCount,
                                    'Number of Teachers': item.teacherCount,
                                    'Total Records': item.count
                                });
                                break;
                            case 'teachers':
                                Object.assign(exportItem, {
                                    'Teacher Name': item.name,
                                    'Average Score %': item.average.toFixed(2),
                                    'Number of Students': item.studentCount,
                                    'Number of Subjects': item.subjectCount,
                                    'Total Records': item.count
                                });
                                break;
                            case 'subjects':
                                Object.assign(exportItem, {
                                    'Subject': item.name,
                                    'Average Score %': item.average.toFixed(2),
                                    'Number of Students': item.studentCount,
                                    'Number of Teachers': item.teacherCount,
                                    'Total Records': item.count
                                });
                                break;
                            case 'streams':
                                Object.assign(exportItem, {
                                    'Stream': item.name,
                                    'Average Score %': item.average.toFixed(2),
                                    'Number of Students': item.studentCount,
                                    'Number of Subjects': item.subjectCount,
                                    'Total Records': item.count
                                });
                                break;
                            case 'grades':
                                Object.assign(exportItem, {
                                    'Grade': item.name,
                                    'Average Score %': item.average.toFixed(2),
                                    'Number of Students': item.studentCount,
                                    'Number of Streams': item.streamCount,
                                    'Total Records': item.count
                                });
                                break;
                        }
                        
                        return exportItem;
                    });
                    
                    const ws = XLSX.utils.json_to_sheet(exportData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, `${type} Ranking`);
                    
                    const filename = `${fileName}_${new Date().toISOString().split('T')[0]}.xlsx`;
                    XLSX.writeFile(wb, filename);
                    
                    console.log(`Ranking exported to Excel: ${filename}`);
                    
                } catch (error) {
                    console.error(`Error exporting ${type} ranking to Excel:`, error);
                    alert(`Error exporting ${type} ranking. Please try again.`);
                }
            }

            // Function to export ranking to PDF
            function exportRankingToPDF(type) {
                if (!window.currentAggregates) return;
                
                let rankingData = [];
                let title = '';
                
                switch(type) {
                    case 'students':
                        rankingData = window.currentAggregates.studentRanking;
                        title = 'Student Ranking';
                        break;
                    case 'teachers':
                        rankingData = window.currentAggregates.teacherRanking;
                        title = 'Teacher Ranking';
                        break;
                    case 'subjects':
                        rankingData = window.currentAggregates.subjectRanking;
                        title = 'Subject Ranking';
                        break;
                    case 'streams':
                        rankingData = window.currentAggregates.streamRanking;
                        title = 'Stream Ranking';
                        break;
                    case 'grades':
                        rankingData = window.currentAggregates.gradeRanking;
                        title = 'Grade Ranking';
                        break;
                }
                
                if (rankingData.length === 0) {
                    alert(`No ${type} data to export.`);
                    return;
                }
                
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    
                    // Add title
                    doc.setFontSize(16);
                    doc.text('ALLIANCE GIRLS HIGH SCHOOL', 20, 20);
                    doc.setFontSize(14);
                    doc.text(title, 20, 30);
                    
                    // Add information
                    doc.setFontSize(10);
                    doc.text(`Generated on: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, 20, 40);
                    doc.text(`Total ${type}: ${rankingData.length}`, 20, 45);
                    
                    // Prepare table data (limit to first 50 for PDF)
                    const tableData = rankingData.slice(0, 50).map(item => {
                        const row = [item.rank.toString()];
                        
                        switch(type) {
                            case 'students':
                                row.push(
                                    item.name.substring(0, 20),
                                    item.average.toFixed(2) + '%',
                                    item.grade || '',
                                    item.stream || '',
                                    item.subjectCount.toString()
                                );
                                break;
                            case 'teachers':
                                row.push(
                                    item.name.substring(0, 20),
                                    item.average.toFixed(2) + '%',
                                    item.studentCount.toString(),
                                    item.subjectCount.toString()
                                );
                                break;
                            case 'subjects':
                                row.push(
                                    item.name.substring(0, 20),
                                    item.average.toFixed(2) + '%',
                                    item.studentCount.toString(),
                                    item.teacherCount.toString()
                                );
                                break;
                            case 'streams':
                                row.push(
                                    item.name.substring(0, 15),
                                    item.average.toFixed(2) + '%',
                                    item.studentCount.toString(),
                                    item.subjectCount.toString()
                                );
                                break;
                            case 'grades':
                                row.push(
                                    item.name.substring(0, 10),
                                    item.average.toFixed(2) + '%',
                                    item.studentCount.toString(),
                                    item.streamCount.toString()
                                );
                                break;
                        }
                        
                        return row;
                    });
                    
                    // Add table headers
                    const headers = ['Rank'];
                    switch(type) {
                        case 'students':
                            headers.push('Student Name', 'Average %', 'Grade', 'Stream', 'Subjects');
                            break;
                        case 'teachers':
                            headers.push('Teacher Name', 'Average %', 'Students', 'Subjects');
                            break;
                        case 'subjects':
                            headers.push('Subject', 'Average %', 'Students', 'Teachers');
                            break;
                        case 'streams':
                            headers.push('Stream', 'Average %', 'Students', 'Subjects');
                            break;
                        case 'grades':
                            headers.push('Grade', 'Average %', 'Students', 'Streams');
                            break;
                    }
                    
                    // Generate table
                    doc.autoTable({
                        head: [headers],
                        body: tableData,
                        startY: 55,
                        styles: {
                            fontSize: 8,
                            cellPadding: 2
                        },
                        headStyles: {
                            fillColor: [41, 128, 185],
                            textColor: 255,
                            fontSize: 9,
                            fontStyle: 'bold'
                        },
                        alternateRowStyles: {
                            fillColor: [245, 245, 245]
                        }
                    });
                    
                    const filename = `${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                    doc.save(filename);
                    
                    console.log(`Ranking exported to PDF: ${filename}`);
                    
                } catch (error) {
                    console.error(`Error exporting ${type} ranking to PDF:`, error);
                    alert(`Error exporting ${type} ranking. Please try again.`);
                }
            }

            // Function to export computation results
            function exportComputationResults() {
                if (!compiledResults || compiledResults.length === 0) {
                    alert('No computation results to export.');
                    return;
                }
                
                try {
                    const aggregates = calculateAggregates(compiledResults);
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Add title
                    doc.setFontSize(16);
                    doc.text('ALLIANCE GIRLS HIGH SCHOOL', 20, 20);
                    doc.setFontSize(14);
                    doc.text('Computation Results Report', 20, 30);
                    
                    // Add filter information
                    doc.setFontSize(10);
                    let yPosition = 45;
                    
                    doc.text('Filter Criteria:', 20, yPosition);
                    yPosition += 8;
                    
                    if (currentFilters.grade) doc.text(`Grade: ${currentFilters.grade}`, 25, yPosition);
                    if (currentFilters.stream) doc.text(`Stream: ${currentFilters.stream}`, 25, yPosition);
                    if (currentFilters.examType) doc.text(`Exam Type: ${currentFilters.examType}`, 25, yPosition);
                    if (currentFilters.term) doc.text(`Term: ${currentFilters.term}`, 25, yPosition);
                    if (currentFilters.year) doc.text(`Year: ${currentFilters.year}`, 25, yPosition);
                    if (currentFilters.recordedBy) doc.text(`Recorded By: ${currentFilters.recordedBy}`, 25, yPosition);
                    
                    yPosition += 15;
                    
                    // Add summary statistics
                    doc.setFontSize(12);
                    doc.text('Summary Statistics:', 20, yPosition);
                    yPosition += 10;
                    
                    const stats = [
                        ['Total Records:', aggregates.totalRecords.toString()],
                        ['Unique Students:', aggregates.uniqueStudents.toString()],
                        ['Unique Subjects:', aggregates.uniqueSubjects.toString()],
                        ['Overall Mean:', aggregates.overallMean ? aggregates.overallMean.toFixed(2) + '%' : 'N/A'],
                        ['Standard Deviation:', aggregates.standardDeviation ? aggregates.standardDeviation.toFixed(2) : 'N/A'],
                        ['Highest Score:', aggregates.highestScore ? aggregates.highestScore.toFixed(2) + '%' : 'N/A'],
                        ['Lowest Score:', aggregates.lowestScore ? aggregates.lowestScore.toFixed(2) + '%' : 'N/A'],
                        ['Median:', aggregates.median ? aggregates.median.toFixed(2) + '%' : 'N/A']
                    ];
                    
                    doc.setFontSize(10);
                    stats.forEach(stat => {
                        doc.text(stat[0], 25, yPosition);
                        doc.text(stat[1], 120, yPosition);
                        yPosition += 8;
                    });
                    
                    yPosition += 10;
                    
                    // Add grade distribution
                    if (aggregates.gradeDistribution && Object.keys(aggregates.gradeDistribution).length > 0) {
                        doc.setFontSize(12);
                        doc.text('Grade Distribution:', 20, yPosition);
                        yPosition += 10;
                        
                        doc.setFontSize(10);
                        Object.entries(aggregates.gradeDistribution)
                            .sort((a, b) => b[1] - a[1])
                            .forEach(([grade, count], index) => {
                                if (index % 2 === 0) {
                                    doc.text(`${grade}: ${count}`, 25, yPosition);
                                } else {
                                    doc.text(`${grade}: ${count}`, 100, yPosition);
                                    yPosition += 8;
                                }
                            });
                        
                        if (Object.keys(aggregates.gradeDistribution).length % 2 !== 0) {
                            yPosition += 8;
                        }
                    }
                    
                    yPosition += 10;
                    
                    // Add top performing subjects
                    const subjectAverages = Object.entries(aggregates.subjectPerformance || {})
                        .map(([subject, data]) => ({
                            subject,
                            average: data.count > 0 ? data.total / data.count : 0
                        }))
                        .sort((a, b) => b.average - a.average)
                        .slice(0, 5);
                    
                    if (subjectAverages.length > 0) {
                        doc.setFontSize(12);
                        doc.text('Top Performing Subjects:', 20, yPosition);
                        yPosition += 10;
                        
                        doc.setFontSize(10);
                        subjectAverages.forEach((item, index) => {
                            doc.text(`${index + 1}. ${item.subject}: ${item.average.toFixed(2)}%`, 25, yPosition);
                            yPosition += 8;
                        });
                    }
                    
                    // Generate filename
                    const filename = `Computation_Results_${new Date().toISOString().split('T')[0]}.pdf`;
                    
                    // Save file
                    doc.save(filename);
                    
                    console.log(`Computation results exported: ${filename}`);
                    
                } catch (error) {
                    console.error('Error exporting computation results:', error);
                    alert('Error exporting computation results. Please try again.');
                }
            }

            // Function to go back to filters from computation results
            function backToFilters() {
                computationResultsSection.style.display = 'none';
                filterFormSection.style.display = 'block';
            }

            // Function to update pagination
            function updatePagination() {
                if (!compiledResults || compiledResults.length === 0) {
                    totalPages = 1;
                    paginatedData = [];
                    return;
                }
                
                totalPages = Math.ceil(compiledResults.length / pageSize);
                
                // Ensure current page is valid
                if (currentPage > totalPages) currentPage = totalPages;
                if (currentPage < 1) currentPage = 1;
                
                // Get data for current page
                const startIndex = (currentPage - 1) * pageSize;
                const endIndex = startIndex + pageSize;
                paginatedData = compiledResults.slice(startIndex, endIndex);
                
                // Update page info
                const pageInfoElement = document.getElementById('pageInfo');
                const pageInfoBottomElement = document.getElementById('pageInfoBottom');
                if (pageInfoElement) {
                    pageInfoElement.textContent = `Page ${currentPage} of ${totalPages} (${compiledResults.length} records)`;
                }
                if (pageInfoBottomElement) {
                    pageInfoBottomElement.textContent = `Page ${currentPage} of ${totalPages} (${compiledResults.length} records)`;
                }
                
                // Update page numbers
                updatePageNumbers();
                
                // Enable/disable previous/next buttons
                const prevBtn = document.getElementById('prevBtn');
                const prevBtnBottom = document.getElementById('prevBtnBottom');
                const nextBtn = document.getElementById('nextBtn');
                const nextBtnBottom = document.getElementById('nextBtnBottom');
                
                if (prevBtn) prevBtn.disabled = currentPage === 1;
                if (prevBtnBottom) prevBtnBottom.disabled = currentPage === 1;
                if (nextBtn) nextBtn.disabled = currentPage === totalPages;
                if (nextBtnBottom) nextBtnBottom.disabled = currentPage === totalPages;
            }

            // Function to update page numbers display
            function updatePageNumbers() {
                const pageNumbersContainer = document.getElementById('pageNumbers');
                const pageNumbersBottomContainer = document.getElementById('pageNumbersBottom');
                
                if (!pageNumbersContainer || !pageNumbersBottomContainer) return;
                
                // Clear existing page numbers
                pageNumbersContainer.innerHTML = '';
                pageNumbersBottomContainer.innerHTML = '';
                
                // Calculate which page numbers to show
                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPages, currentPage + 2);
                
                // Adjust if we're near the beginning
                if (currentPage <= 3) {
                    endPage = Math.min(totalPages, 5);
                }
                
                // Adjust if we're near the end
                if (currentPage >= totalPages - 2) {
                    startPage = Math.max(1, totalPages - 4);
                }
                
                // Add page number buttons
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                    pageBtn.textContent = i;
                    pageBtn.onclick = () => goToPage(i);
                    
                    const pageBtnBottom = document.createElement('button');
                    pageBtnBottom.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                    pageBtnBottom.textContent = i;
                    pageBtnBottom.onclick = () => goToPage(i);
                    
                    pageNumbersContainer.appendChild(pageBtn);
                    pageNumbersBottomContainer.appendChild(pageBtnBottom);
                }
            }

            // Function to go to specific page
            function goToPage(page) {
                if (page < 1 || page > totalPages) return;
                currentPage = page;
                updatePagination();
                generatePaginatedTable();
                
                // Scroll to top of table
                const tableContainer = document.querySelector('.excel-table-wrapper');
                if (tableContainer) {
                    tableContainer.scrollTop = 0;
                }
            }

            // Function to change page
            function changePage(delta) {
                goToPage(currentPage + delta);
            }

            // Function to change page size
            function changePageSize() {
                const newPageSize = parseInt(document.getElementById('pageSize')?.value || 100);
                if (newPageSize !== pageSize) {
                    pageSize = newPageSize;
                    currentPage = 1;
                    updatePagination();
                    generatePaginatedTable();
                }
            }

            // Function to generate paginated table
            function generatePaginatedTable() {
                const tableHeader = document.getElementById('resultsTableHeader');
                const tableBody = document.getElementById('resultsTableBody');
                
                if (!tableHeader || !tableBody) return;
                
                // Clear existing content
                tableHeader.innerHTML = '';
                tableBody.innerHTML = '';
                
                // Create header row
                const headerRow = document.createElement('tr');
                
                tableColumns.forEach((column, index) => {
                    const th = document.createElement('th');
                    th.textContent = column.header;
                    th.style.minWidth = column.width;
                    th.style.whiteSpace = 'nowrap';
                    th.style.overflow = 'hidden';
                    th.style.textOverflow = 'ellipsis';
                    
                    // Make first column sticky
                    if (index === 0) {
                        th.classList.add('fixed-column-header');
                    }
                    
                    headerRow.appendChild(th);
                });
                
                tableHeader.appendChild(headerRow);
                
                // Create data rows for current page
                if (paginatedData.length === 0) {
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = tableColumns.length;
                    td.textContent = 'No data available for this page';
                    td.style.textAlign = 'center';
                    td.style.padding = '40px';
                    td.style.color = '#666';
                    tr.appendChild(td);
                    tableBody.appendChild(tr);
                } else {
                    paginatedData.forEach((row, index) => {
                        const tr = document.createElement('tr');
                        
                        // Calculate actual index in full dataset
                        const actualIndex = (currentPage - 1) * pageSize + index + 1;
                        
                        tableColumns.forEach((column, cellIndex) => {
                            const td = document.createElement('td');
                            let cellValue = '';
                            
                            // Special handling for certain columns
                            if (column.key === 'id') {
                                cellValue = actualIndex;
                            } else if (column.key === 'score') {
                                cellValue = `${row.score}/${row.max_score}`;
                            } else if (column.key === 'percentage') {
                                cellValue = `${row.percentage}%`;
                            } else {
                                cellValue = row[column.key] || '';
                            }
                            
                            td.textContent = cellValue;
                            td.style.whiteSpace = 'nowrap';
                            td.style.overflow = 'hidden';
                            td.style.textOverflow = 'ellipsis';
                            td.title = cellValue; // Show full text on hover
                            
                            // Alternate row background
                            if (index % 2 === 0) {
                                td.style.backgroundColor = '#f9f9f9';
                            }
                            
                            // Make first column sticky
                            if (cellIndex === 0) {
                                td.classList.add('fixed-column');
                            }
                            
                            // Style based on content
                            if (column.key === 'percentage') {
                                const percentage = parseFloat(row.percentage);
                                if (!isNaN(percentage)) {
                                    if (percentage >= 80) {
                                        td.style.color = '#075824';
                                        td.style.fontWeight = 'bold';
                                    } else if (percentage >= 60) {
                                        td.style.color = '#333687';
                                    } else if (percentage >= 40) {
                                        td.style.color = '#ff9800';
                                    } else {
                                        td.style.color = '#C62828';
                                    }
                                }
                            }
                            
                            if (column.key === 'grade_letter') {
                                const grade = row.grade_letter;
                                if (grade === 'A' || grade === 'A-') {
                                    td.style.color = '#075824';
                                    td.style.fontWeight = 'bold';
                                } else if (grade === 'B+' || grade === 'B' || grade === 'B-') {
                                    td.style.color = '#333687';
                                } else if (grade === 'C+' || grade === 'C' || grade === 'C-') {
                                    td.style.color = '#ff9800';
                                } else if (grade === 'D' || grade === 'D+') {
                                    td.style.color = '#C62828';
                                } else if (grade === 'E') {
                                    td.style.color = '#C62828';
                                    td.style.fontWeight = 'bold';
                                }
                            }
                            
                            if (column.key === 'achievement_level') {
                                const level = row.achievement_level;
                                if (level === 'Excellent') {
                                    td.style.color = '#075824';
                                    td.style.fontWeight = 'bold';
                                } else if (level === 'Good') {
                                    td.style.color = '#333687';
                                } else if (level === 'Satisfactory') {
                                    td.style.color = '#ff9800';
                                } else if (level === 'Needs Improvement' || level === 'Not Achieved') {
                                    td.style.color = '#C62828';
                                }
                            }
                            
                            tr.appendChild(td);
                        });
                        
                        tableBody.appendChild(tr);
                    });
                }
            }

            // Function to calculate and display statistics
            function calculateAndDisplayStatistics(data) {
                if (data.length === 0) {
                    // Reset statistics
                    document.getElementById('overallMean').textContent = '0.00';
                    document.getElementById('stdDev').textContent = '0.00';
                    document.getElementById('top10Avg').textContent = '0.00';
                    document.getElementById('bottom10Avg').textContent = '0.00';
                    return;
                }
                
                // Extract all percentage scores
                const percentageScores = data
                    .map(row => parseFloat(row.percentage))
                    .filter(score => !isNaN(score));
                
                if (percentageScores.length === 0) return;
                
                // Calculate statistics
                const mean = percentageScores.reduce((a, b) => a + b, 0) / percentageScores.length;
                const sortedScores = [...percentageScores].sort((a, b) => a - b);
                
                // Standard deviation
                const squareDiffs = percentageScores.map(score => Math.pow(score - mean, 2));
                const avgSquareDiff = squareDiffs.reduce((a, b) => a + b, 0) / percentageScores.length;
                const stdDev = Math.sqrt(avgSquareDiff);
                
                // Top 10%
                const top10Count = Math.ceil(percentageScores.length * 0.1);
                const top10Scores = sortedScores.slice(-top10Count);
                const top10Avg = top10Scores.reduce((a, b) => a + b, 0) / top10Scores.length;
                
                // Bottom 10%
                const bottom10Scores = sortedScores.slice(0, top10Count);
                const bottom10Avg = bottom10Scores.reduce((a, b) => a + b, 0) / bottom10Scores.length;
                
                // Update statistics display
                document.getElementById('overallMean').textContent = mean.toFixed(2);
                document.getElementById('stdDev').textContent = stdDev.toFixed(2);
                document.getElementById('top10Avg').textContent = top10Avg.toFixed(2);
                document.getElementById('bottom10Avg').textContent = bottom10Avg.toFixed(2);
                
                // Update performance chart
                updatePerformanceChart(percentageScores);
            }

            // Function to update performance chart
            function updatePerformanceChart(scores) {
                const ctx = document.getElementById('performanceChart');
                if (!ctx) return;
                
                // Destroy existing chart if it exists
                if (performanceCharts.performance) {
                    performanceCharts.performance.destroy();
                }
                
                // Create score ranges
                const ranges = [
                    { label: '90-100', min: 90, max: 100 },
                    { label: '80-89', min: 80, max: 89 },
                    { label: '70-79', min: 70, max: 79 },
                    { label: '60-69', min: 60, max: 69 },
                    { label: '50-59', min: 50, max: 59 },
                    { label: '0-49', min: 0, max: 49 }
                ];
                
                const distribution = ranges.map(range => 
                    scores.filter(score => score >= range.min && score <= range.max).length
                );
                
                performanceCharts.performance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ranges.map(r => r.label),
                        datasets: [{
                            label: 'Number of Students',
                            data: distribution,
                            backgroundColor: [
                                'rgba(16, 185, 129, 0.7)',
                                'rgba(59, 130, 246, 0.7)',
                                'rgba(245, 158, 11, 0.7)',
                                'rgba(239, 68, 68, 0.7)',
                                'rgba(156, 39, 176, 0.7)',
                                'rgba(107, 114, 128, 0.7)'
                            ],
                            borderColor: [
                                'rgb(16, 185, 129)',
                                'rgb(59, 130, 246)',
                                'rgb(245, 158, 11)',
                                'rgb(239, 68, 68)',
                                'rgb(156, 39, 176)',
                                'rgb(107, 114, 128)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Score Distribution',
                                color: '#333',
                                font: { size: 14 }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Students'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Score Range'
                                }
                            }
                        }
                    }
                });
            }

            // Function to export results to Excel - UPDATED with new fields
            function exportResultsToExcel() {
                if (!compiledResults || compiledResults.length === 0) {
                    alert('No data to export. Please access cloud data first.');
                    return;
                }

                try {
                    // Prepare data for Excel export - UPDATED with new fields
                    const exportData = compiledResults.map(result => ({
                        'Student ID': result.student_id,
                        'Admission Number': result.admission_no,
                        'Student Name': result.student_name,
                        'Grade': result.grade,
                        'Stream': result.stream,
                        'Subject Code': result.subject_code,
                        'Component Name': result.component_name,
                        'Subject Teacher': result.subject_teacher,
                        'Recorded By': result.recorded_by,
                        'Max Score': result.max_score,
                        'Score': result.score,
                        'Percentage': result.percentage,
                        'Grade Letter': result.grade_letter,
                        'Achievement Level': result.achievement_level,
                        'Achievement Description': result.achievement_description,
                        'Exam Type': result.exam_type,
                        'Term': result.term,
                        'Academic Year': result.academic_year,
                        'Assessment Type': result.assessment_type,
                        'Remarks': result.remarks,
                        'Recorded At': result.recorded_at
                    }));

                    // Create worksheet
                    const ws = XLSX.utils.json_to_sheet(exportData);

                    // Auto-size columns - UPDATED with new column widths
                    const colWidths = [
                        { wch: 12 }, // Student ID
                        { wch: 18 }, // Admission Number
                        { wch: 25 }, // Student Name
                        { wch: 8 },  // Grade
                        { wch: 8 },  // Stream
                        { wch: 12 }, // Subject Code
                        { wch: 20 }, // Component Name
                        { wch: 18 }, // Subject Teacher
                        { wch: 18 }, // Recorded By
                        { wch: 10 }, // Max Score
                        { wch: 8 },  // Score
                        { wch: 12 }, // Percentage
                        { wch: 12 }, // Grade Letter
                        { wch: 18 }, // Achievement Level
                        { wch: 25 }, // Achievement Description
                        { wch: 15 }, // Exam Type
                        { wch: 15 }, // Term
                        { wch: 15 }, // Academic Year
                        { wch: 18 }, // Assessment Type
                        { wch: 20 }, // Remarks
                        { wch: 20 }  // Recorded At
                    ];
                    ws['!cols'] = colWidths;

                    // Create workbook
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Examination Results');

                    // Generate filename with current date
                    const filename = `Cloud_Examination_Data_${new Date().toISOString().split('T')[0]}.xlsx`;

                    // Save file
                    XLSX.writeFile(wb, filename);
                    
                    console.log(`Data exported to Excel: ${filename}`);
                    
                } catch (error) {
                    console.error('Error exporting to Excel:', error);
                    alert('Error exporting data to Excel. Please try again.');
                }
            }

            // Function to export results to PDF - UPDATED with new fields
            function exportResultsToPDF() {
                if (!compiledResults || compiledResults.length === 0) {
                    alert('No data to export. Please access cloud data first.');
                    return;
                }

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('l', 'mm', 'a4'); // landscape orientation
                    
                    // Add title
                    doc.setFontSize(16);
                    doc.text('ALLIANCE GIRLS HIGH SCHOOL', 14, 20);
                    doc.setFontSize(14);
                    doc.text('Cloud Examination Data Report', 14, 30);
                    
                    // Add information
                    doc.setFontSize(10);
                    doc.text(`Generated on: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, 14, 40);
                    doc.text(`Total Records: ${compiledResults.length}`, 14, 45);
                    
                    // Prepare table data (limited for PDF) - UPDATED with new fields
                    const tableData = compiledResults.slice(0, 100).map(result => [
                        result.admission_no,
                        result.student_name.substring(0, 15),
                        result.grade + ' ' + result.stream,
                        result.subject_code,
                        result.component_name.substring(0, 15),
                        result.subject_teacher.substring(0, 15),
                        result.recorded_by.substring(0, 15),
                        result.score + '/' + result.max_score,
                        result.percentage + '%',
                        result.grade_letter,
                        result.achievement_level.substring(0, 15),
                        result.exam_type.substring(0, 10),
                        result.term,
                        result.academic_year
                    ]);
                    
                    // Add table headers - UPDATED with new headers
                    const headers = [
                        'Admission', 'Name', 'Class', 'Subject', 
                        'Component', 'Teacher', 'Recorded By',
                        'Score', '%', 'Grade', 'Achievement', 'Exam Type', 'Term', 'Year'
                    ];
                    
                    // Generate table
                    doc.autoTable({
                        head: [headers],
                        body: tableData,
                        startY: 55,
                        styles: {
                            fontSize: 8,
                            cellPadding: 2
                        },
                        headStyles: {
                            fillColor: [41, 128, 185],
                            textColor: 255,
                            fontSize: 9,
                            fontStyle: 'bold'
                        },
                        alternateRowStyles: {
                            fillColor: [245, 245, 245]
                        },
                        columnStyles: {
                            0: { cellWidth: 25 }, // Admission
                            1: { cellWidth: 35 }, // Name
                            2: { cellWidth: 20 }, // Class
                            3: { cellWidth: 20 }, // Subject
                            4: { cellWidth: 25 }, // Component
                            5: { cellWidth: 20 }, // Teacher
                            6: { cellWidth: 20 }, // Recorded By
                            7: { cellWidth: 20 }, // Score
                            8: { cellWidth: 15 }, // Percentage
                            9: { cellWidth: 15 }, // Grade
                            10: { cellWidth: 25 }, // Achievement
                            11: { cellWidth: 20 }, // Exam Type
                            12: { cellWidth: 15 }, // Term
                            13: { cellWidth: 20 }  // Year
                        }
                    });
                    
                    // Generate filename
                    const filename = `Cloud_Examination_Data_${new Date().toISOString().split('T')[0]}.pdf`;
                    
                    // Save file
                    doc.save(filename);
                    
                    console.log(`Data exported to PDF: ${filename}`);
                    
                } catch (error) {
                    console.error('Error exporting to PDF:', error);
                    alert('Error exporting data to PDF. Please try again.');
                }
            }

            // Function to generate statistical report (PDF)
            function generateStatisticalReport() {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Add title
                    doc.setFontSize(16);
                    doc.text('ALLIANCE GIRLS HIGH SCHOOL', 20, 20);
                    doc.setFontSize(14);
                    doc.text('Statistical Analysis Report', 20, 30);
                    
                    // Add information
                    doc.setFontSize(10);
                    doc.text(`Generated on: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, 20, 40);
                    doc.text(`Total Records: ${compiledResults.length}`, 20, 45);
                    
                    let yPosition = 60;
                    
                    // Add statistics
                    doc.setFontSize(12);
                    doc.text('Summary Statistics:', 20, yPosition);
                    yPosition += 10;
                    
                    const stats = [
                        ['Total Records:', compiledResults.length.toString()],
                        ['Mean Score:', document.getElementById('overallMean')?.textContent || '0.00'],
                        ['Standard Deviation:', document.getElementById('stdDev')?.textContent || '0.00'],
                        ['Top 10% Average:', document.getElementById('top10Avg')?.textContent || '0.00'],
                        ['Bottom 10% Average:', document.getElementById('bottom10Avg')?.textContent || '0.00']
                    ];
                    
                    doc.setFontSize(10);
                    stats.forEach(stat => {
                        doc.text(stat[0], 25, yPosition);
                        doc.text(stat[1], 120, yPosition);
                        yPosition += 8;
                    });
                    
                    yPosition += 10;
                    
                    // Add grade distribution if available
                    doc.setFontSize(12);
                    doc.text('Grade Distribution:', 20, yPosition);
                    yPosition += 10;
                    
                    // Count grades
                    const gradeCount = {};
                    compiledResults.forEach(result => {
                        const grade = result.grade_letter;
                        gradeCount[grade] = (gradeCount[grade] || 0) + 1;
                    });
                    
                    doc.setFontSize(10);
                    Object.entries(gradeCount).forEach(([grade, count], index) => {
                        if (index % 2 === 0) {
                            doc.text(`${grade}: ${count}`, 25, yPosition);
                        } else {
                            doc.text(`${grade}: ${count}`, 100, yPosition);
                            yPosition += 8;
                        }
                    });
                    
                    // Generate filename
                    const filename = `Statistical_Report_${new Date().toISOString().split('T')[0]}.pdf`;
                    
                    // Save file
                    doc.save(filename);
                    
                    console.log(`Statistical report exported: ${filename}`);
                    
                } catch (error) {
                    console.error('Error generating statistical report:', error);
                    alert('Error generating statistical report. Please try again.');
                }
            }

            // Generate other content functions (truncated for brevity)
            function generateEmailContent() {
                return `
                    <div class="data-section">
                        <div class="section-title">
                            <h2><i class="fas fa-envelope"></i> Email Parents/Guardians</h2>
                            <div class="section-info">Automated communication system for parent engagement</div>
                        </div>
                        
                        <div class="data-cards">
                            <div class="data-card">
                                <div class="card-header">
                                    <i class="fas fa-users"></i>
                                    <h3>Recipient Management</h3>
                                </div>
                                <div class="card-body">
                                    <p style="line-height: 1.6; color: #666; margin-bottom: 15px;">
                                        Select and manage parent/guardian contacts for targeted communication.
                                    </p>
                                    <ul style="color: #666; line-height: 1.6; padding-left: 20px;">
                                        <li>Filter by grade/stream/performance</li>
                                        <li>Import contact lists</li>
                                        <li>Verify email addresses</li>
                                        <li>Manage opt-outs</li>
                                    </ul>
                                </div>
                                <div class="card-footer">
                                    <span>Manage Contacts</span>
                                    <button class="btn btn-primary" onclick="openEmailParentsModal()">
                                        <i class="fas fa-address-book"></i> Open
                                    </button>
                                </div>
                            </div>
                            
                            <div class="data-card">
                                <div class="card-header">
                                    <i class="fas fa-envelope-open-text"></i>
                                    <h3>Template Library</h3>
                                </div>
                                <div class="card-body">
                                    <p style="line-height: 1.6; color: #666; margin-bottom: 15px;">
                                        Pre-designed email templates for different communication needs.
                                    </p>
                                    <ul style="color: #666; line-height: 1.6; padding-left: 20px;">
                                        <li>Exam results notifications</li>
                                        <li>Progress reports</li>
                                        <li>Meeting invitations</li>
                                        <li>Urgent announcements</li>
                                    </ul>
                                </div>
                                <div class="card-footer">
                                    <span>Browse Templates</span>
                                    <button class="btn btn-outline" onclick="openEmailParentsModal()">
                                        <i class="fas fa-folder-open"></i> View
                                    </button>
                                </div>
                            </div>
                            
                            <div class="data-card">
                                <div class="card-header">
                                    <i class="fas fa-paper-plane"></i>
                                    <h3>Send & Schedule</h3>
                                </div>
                                <div class="card-body">
                                    <p style="line-height: 1.6; color: #666; margin-bottom: 15px;">
                                        Send emails immediately or schedule for optimal delivery times.
                                    </p>
                                    <ul style="color: #666; line-height: 1.6; padding-left: 20px;">
                                        <li>Bulk email sending</li>
                                        <li>Scheduled delivery</li>
                                        <li>Delivery tracking</li>
                                        <li>Bounce handling</li>
                                    </ul>
                                </div>
                                <div class="card-footer">
                                    <span>Send Emails</span>
                                    <button class="btn btn-success" onclick="openEmailParentsModal()">
                                        <i class="fas fa-paper-plane"></i> Compose
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="footer">
                            <p> 2026 Alliance Girls High School - Examination Office. Secure Parent Communication System.</p>
                        </div>
                    </div>
                `;
            }

            function generateAnalysisContent() {
                return `
                    <div class="data-section">
                        <div class="section-title">
                            <h2><i class="fas fa-brain"></i> Advanced Academic Analysis</h2>
                            <div class="section-info">AI-powered insights, predictions, and anomaly detection</div>
                        </div>
                        
                        <div class="analysis-cards">
                            <div class="analysis-card">
                                <h3><i class="fas fa-crystal-ball"></i> Predictive Analytics</h3>
                                <p>Forecast student performance, identify at-risk students, and predict future trends based on historical data patterns.</p>
                                <div style="margin-top: 15px;">
                                    <button class="btn btn-primary" onclick="openAdvancedAnalysisModal()">
                                        <i class="fas fa-chart-line"></i> Run Predictions
                                    </button>
                                </div>
                            </div>
                            
                            <div class="analysis-card">
                                <h3><i class="fas fa-project-diagram"></i> Correlation Analysis</h3>
                                <p>Discover relationships between subjects, identify transferable skills, and optimize teaching strategies based on data-driven insights.</p>
                                <div style="margin-top: 15px;">
                                    <button class="btn btn-outline" onclick="openAdvancedAnalysisModal()">
                                        <i class="fas fa-link"></i> Analyze Correlations
                                    </button>
                                </div>
                            </div>
                            
                            <div class="analysis-card">
                                <h3><i class="fas fa-exclamation-triangle"></i> Anomaly Detection</h3>
                                <p>Identify unusual patterns, potential grading errors, or inconsistencies in examination data that require further investigation.</p>
                                <div style="margin-top: 15px;">
                                    <button class="btn btn-danger" onclick="openAdvancedAnalysisModal()">
                                        <i class="fas fa-radar"></i> Detect Anomalies
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="footer">
                            <p> 2026 Alliance Girls High School - Examination Office. Advanced AI Analytics System.</p>
                        </div>
                    </div>
                `;
            }

            // Generate remaining content functions (truncated)
            function generateTrendsContent() {
                return `<div class="data-section"><h2>Performance Trends</h2></div>`;
            }
            
            function generateTeachersContent() {
                return `<div class="data-section"><h2>Teacher Performance</h2></div>`;
            }
            
            function generateValidationContent() {
                return `<div class="data-section"><h2>Data Validation</h2></div>`;
            }
            
            function generateAuditContent() {
                return `<div class="data-section"><h2>Audit Trail</h2></div>`;
            }
            
            function generateSettingsContent() {
                return `<div class="data-section"><h2>Settings</h2></div>`;
            }
            
            function generateDefaultContent(section) {
                return `<div class="data-section"><h2>${section}</h2></div>`;
            }

            // Initialize dashboard
            function initializeDashboard() {
                console.log('Starting Examination Office dashboard initialization...');
                
                // Load user data
                loadUserData();
                
                // Set up event listeners
                setupEventListeners();
                
                console.log('Examination Office dashboard initialization complete');
            }

            // Setup event listeners
            function setupEventListeners() {
                // Hamburger menu
                if (hamburger) {
                    hamburger.addEventListener('click', () => {
                        sidebar.classList.toggle('open');
                    });
                }

                // User dropdown
                if (userProfileTop) {
                    userProfileTop.addEventListener('click', (e) => {
                        e.stopPropagation();
                        userDropdown.classList.toggle('show');
                        dropdownArrow.classList.toggle('fa-chevron-down');
                        dropdownArrow.classList.toggle('fa-chevron-up');
                    });
                }

                // Navigation links
                if (navLinks.length > 0) {
                    navLinks.forEach(link => {
                        link.addEventListener('click', (e) => {
                            if (link.classList.contains('logout-sidebar')) {
                                e.preventDefault();
                                handleLogout();
                                return;
                            }
                            
                            e.preventDefault();
                            
                            const section = link.getAttribute('data-section');
                            if (section) {
                                loadDashboardContent(section);
                            }
                            
                            // Close sidebar on mobile after selection
                            if (window.innerWidth <= 1024) {
                                sidebar.classList.remove('open');
                            }
                        });
                    });
                }

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (userProfileTop && userDropdown && 
                        !userProfileTop.contains(e.target) && !userDropdown.contains(e.target)) {
                        userDropdown.classList.remove('show');
                        dropdownArrow.classList.remove('fa-chevron-up');
                        dropdownArrow.classList.add('fa-chevron-down');
                    }
                    
                    // Close sidebar when clicking outside on mobile
                    if (window.innerWidth <= 1024 && 
                        sidebar && sidebar.classList.contains('open') && 
                        !sidebar.contains(e.target) && 
                        e.target !== hamburger) {
                        sidebar.classList.remove('open');
                    }
                });

                // Logout handlers
                if (logoutLink) {
                    logoutLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        handleLogout();
                    });
                }

                if (logoutSidebarLinks.length > 0) {
                    logoutSidebarLinks.forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            handleLogout();
                        });
                    });
                }

                // Modal close buttons
                if (compileModalClose) {
                    compileModalClose.addEventListener('click', () => {
                        compileResultsModal.classList.remove('show');
                        // Reset pagination when closing modal
                        currentPage = 1;
                        pageSize = 100;
                    });
                }

                if (reportCardsModalClose) {
                    reportCardsModalClose.addEventListener('click', () => {
                        reportCardsModal.classList.remove('show');
                    });
                }

                if (emailModalClose) {
                    emailModalClose.addEventListener('click', () => {
                        emailParentsModal.classList.remove('show');
                    });
                }

                if (analysisModalClose) {
                    analysisModalClose.addEventListener('click', () => {
                        advancedAnalysisModal.classList.remove('show');
                    });
                }

                // Close modals when clicking outside
                document.addEventListener('click', (e) => {
                    if (compileResultsModal && compileResultsModal.classList.contains('show') && 
                        !compileResultsModal.contains(e.target) && !e.target.closest('#compileResultsLink')) {
                        compileResultsModal.classList.remove('show');
                        // Reset pagination when closing modal
                        currentPage = 1;
                        pageSize = 100;
                    }
                    
                    if (reportCardsModal && reportCardsModal.classList.contains('show') && 
                        !reportCardsModal.contains(e.target) && !e.target.closest('#reportCardsLink')) {
                        reportCardsModal.classList.remove('show');
                    }
                    
                    if (emailParentsModal && emailParentsModal.classList.contains('show') && 
                        !emailParentsModal.contains(e.target) && !e.target.closest('#emailParentsLink')) {
                        emailParentsModal.classList.remove('show');
                    }
                    
                    if (advancedAnalysisModal && advancedAnalysisModal.classList.contains('show') && 
                        !advancedAnalysisModal.contains(e.target) && !e.target.closest('#advancedAnalysisLink')) {
                        advancedAnalysisModal.classList.remove('show');
                    }
                });

                // Link modal openers
                if (compileResultsLink) {
                    compileResultsLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        openCompileResultsModal();
                        loadDashboardContent('compile');
                    });
                }

                if (reportCardsLink) {
                    reportCardsLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        openReportCardsModal();
                        loadDashboardContent('reports');
                    });
                }

                if (emailParentsLink) {
                    emailParentsLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        openEmailParentsModal();
                        loadDashboardContent('email');
                    });
                }

                if (advancedAnalysisLink) {
                    advancedAnalysisLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        openAdvancedAnalysisModal();
                        loadDashboardContent('analysis');
                    });
                }

                // Cloud Access modal buttons
                if (accessCloudBtn) {
                    accessCloudBtn.addEventListener('click', () => {
                        switchCompileView('preview');
                    });
                }

                if (exportResultsBtn) {
                    exportResultsBtn.addEventListener('click', exportResultsToExcel);
                }

                if (exportPdfBtn) {
                    exportPdfBtn.addEventListener('click', exportResultsToPDF);
                }

                if (analysisBtn) {
                    analysisBtn.addEventListener('click', () => {
                        switchCompileView('analysis');
                        // Calculate and display statistics when switching to analysis view
                        setTimeout(() => {
                            calculateAndDisplayStatistics(compiledResults);
                        }, 100);
                    });
                }

                if (backToCloudBtn) {
                    backToCloudBtn.addEventListener('click', () => {
                        switchCompileView('cloud');
                    });
                }

                if (generateReportBtn) {
                    generateReportBtn.addEventListener('click', generateStatisticalReport);
                }

                if (backToDataBtn) {
                    backToDataBtn.addEventListener('click', () => {
                        switchCompileView('preview');
                    });
                }

                // NEW FILTER EVENT LISTENERS
                if (filterComputeBtn) {
                    filterComputeBtn.addEventListener('click', toggleFilterForm);
                }

                if (applyFilterBtn) {
                    applyFilterBtn.addEventListener('click', applyFilters);
                }

                if (clearFilterBtn) {
                    clearFilterBtn.addEventListener('click', clearFilters);
                }

                if (computeAggregatesBtn) {
                    computeAggregatesBtn.addEventListener('click', computeAggregates);
                }

                if (exportComputationResultsBtn) {
                    exportComputationResultsBtn.addEventListener('click', exportComputationResults);
                }

                if (backToFiltersBtn) {
                    backToFiltersBtn.addEventListener('click', backToFilters);
                }

                // Pagination buttons
                if (prevBtn) {
                    prevBtn.addEventListener('click', () => changePage(-1));
                }

                if (nextBtn) {
                    nextBtn.addEventListener('click', () => changePage(1));
                }

                if (prevBtnBottom) {
                    prevBtnBottom.addEventListener('click', () => changePage(-1));
                }

                if (nextBtnBottom) {
                    nextBtnBottom.addEventListener('click', () => changePage(1));
                }

                if (pageSizeSelect) {
                    pageSizeSelect.addEventListener('change', changePageSize);
                }

                // View toggle event listeners
                document.addEventListener('click', (e) => {
                    // Cloud access view toggle
                    if (e.target.closest('#compileViewToggle') && e.target.classList.contains('view-btn')) {
                        const view = e.target.dataset.view;
                        switchCompileView(view);
                    }
                    
                    // Report cards view toggle
                    if (e.target.closest('#reportCardsViewToggle') && e.target.classList.contains('view-btn')) {
                        const view = e.target.dataset.view;
                        switchReportCardsView(view);
                    }
                    
                    // Email view toggle
                    if (e.target.closest('#emailViewToggle') && e.target.classList.contains('view-btn')) {
                        const view = e.target.dataset.view;
                        switchEmailView(view);
                    }
                    
                    // Analysis view toggle
                    if (e.target.closest('#analysisViewToggle') && e.target.classList.contains('view-btn')) {
                        const view = e.target.dataset.view;
                        switchAnalysisView(view);
                    }
                });
            }

            // Handle logout
            async function handleLogout() {
                if (confirm('Are you sure you want to logout from the Examination Office?')) {
                    try {
                        const { error } = await supabase.auth.signOut();
                        if (error) throw error;
                        
                        // Clear localStorage
                        localStorage.removeItem('examOfficerName');
                        
                        console.log('Logout successful, redirecting to login...');
                        
                        // Redirect to login page
                        window.location.href = 'index.html';
                    } catch (error) {
                        console.error('Logout error:', error);
                        alert('Error during logout. Please try again.');
                    }
                }
            }

            // Make functions available globally
            window.loadDashboardContent = loadDashboardContent;
            window.openCompileResultsModal = openCompileResultsModal;
            window.openReportCardsModal = openReportCardsModal;
            window.openEmailParentsModal = openEmailParentsModal;
            window.openAdvancedAnalysisModal = openAdvancedAnalysisModal;
            window.switchCompileView = switchCompileView;
            window.switchReportCardsView = switchReportCardsView;
            window.switchEmailView = switchEmailView;
            window.switchAnalysisView = switchAnalysisView;
            window.accessCloudData = accessCloudData;
            window.exportResultsToExcel = exportResultsToExcel;
            window.exportResultsToPDF = exportResultsToPDF;
            window.generateStatisticalReport = generateStatisticalReport;
            window.changePage = changePage;
            window.changePageSize = changePageSize;
            window.goToPage = goToPage;

            // NEW: Ranking functions
            window.computeAggregates = computeAggregates;
            window.showRankingTable = showRankingTable;
            window.exportRankingToExcel = exportRankingToExcel;
            window.exportRankingToPDF = exportRankingToPDF;

            // Start initialization when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeDashboard);
            } else {
                initializeDashboard();
            }

        })();
    </script>
</body>
</html>