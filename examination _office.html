<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combine Results - Alliance Girls High School</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-green: #075824;
            --secondary-green: #377437;
            --accent-green: #9BAE30;
            --muted-green: #5D8B70;
            --accent-blue: #333687;
            --background-light: #F4F4F4;
            --text-light: #FFFFFF;
            --sidebar-width: 280px;
            --card-shadow: 0 5px 20px rgba(0,0,0,0.08);
            --hover-shadow: 0 15px 30px rgba(0,0,0,0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-light);
            color: #333;
            min-height: 100vh;
            display: flex;
            overflow-x: hidden;
        }

        /* Top Header with User Profile */
        .top-header {
            position: fixed;
            top: 0;
            right: 0;
            left: var(--sidebar-width);
            background-color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            z-index: 999;
            transition: left 0.3s ease;
        }

        .page-title h1 {
            color: var(--primary-green);
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .page-title p {
            color: var(--muted-green);
            font-size: 0.9rem;
        }

        .user-profile-top {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 8px 15px;
            background-color: rgba(7, 88, 36, 0.05);
            border-radius: 50px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .user-profile-top:hover {
            background-color: rgba(7, 88, 36, 0.1);
        }

        .user-avatar-top {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-green), var(--accent-green));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            overflow: hidden;
            position: relative;
            border: 3px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        .user-avatar-top img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-info-top h4 {
            color: var(--primary-green);
            font-size: 0.95rem;
            margin-bottom: 2px;
        }

        .user-info-top p {
            color: var(--muted-green);
            font-size: 0.8rem;
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 30px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            padding: 15px;
            min-width: 200px;
            display: none;
            z-index: 1001;
        }

        .user-dropdown.show {
            display: block;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            color: #555;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .dropdown-item:hover {
            background-color: rgba(7, 88, 36, 0.05);
            color: var(--primary-green);
        }

        .dropdown-item i {
            margin-right: 10px;
            width: 20px;
        }

        /* Sidebar Header */
        .sidebar-header {
            background-color: var(--primary-green);
            color: var(--text-light);
            padding: 25px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .badge-container {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-color: white;
            border: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
            margin: 0 auto 15px;
        }

        .school-badge {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 8px;
        }

        .badge-fallback {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-green);
            color: white;
            font-size: 28px;
        }

        .sidebar-title h1 {
            font-size: 1.8rem;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .sidebar-title h2 {
            font-size: 1rem;
            font-weight: 400;
            opacity: 0.9;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: var(--sidebar-width);
            background-color: white;
            box-shadow: 3px 0 15px rgba(0, 0, 0, 0.08);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1000;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .sidebar-nav {
            list-style: none;
            padding: 0;
        }

        .nav-section-title {
            padding: 20px 25px 10px;
            font-size: 0.85rem;
            color: var(--muted-green);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            border-bottom: 1px solid #eee;
            margin: 0 15px;
        }

        .nav-item {
            margin-bottom: 3px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 16px 25px;
            color: #555;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            position: relative;
        }

        .nav-link:hover {
            background-color: rgba(7, 88, 36, 0.05);
            color: var(--primary-green);
            border-left-color: var(--accent-green);
        }

        .nav-link.active {
            background-color: rgba(7, 88, 36, 0.1);
            color: var(--primary-green);
            font-weight: 600;
            border-left-color: var(--primary-green);
        }

        .nav-link i {
            margin-right: 15px;
            width: 22px;
            text-align: center;
            font-size: 1.2rem;
        }

        /* Main content area */
        .main-content {
            flex: 1;
            padding: 100px 40px 40px;
            margin-left: var(--sidebar-width);
            display: flex;
            flex-direction: column;
            transition: margin-left 0.3s ease;
            width: calc(100% - var(--sidebar-width));
        }

        /* Data display sections */
        .data-section {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto 40px;
        }

        .section-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(7, 88, 36, 0.1);
        }

        .section-title h2 {
            color: var(--primary-green);
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title h2 i {
            color: var(--accent-green);
        }

        .section-info {
            color: var(--muted-green);
            font-size: 1rem;
        }

        /* Form Controls */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--primary-green);
            font-weight: 600;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px rgba(155, 174, 48, 0.1);
        }

        /* Action Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary-green);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-green);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(7, 88, 36, 0.2);
        }

        .btn-secondary {
            background-color: var(--accent-blue);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #2a2c6e;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(51, 54, 135, 0.2);
        }

        .btn-outline {
            background-color: transparent;
            color: var(--primary-green);
            border: 2px solid var(--primary-green);
        }

        .btn-outline:hover {
            background-color: rgba(7, 88, 36, 0.05);
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.9rem;
        }

        /* Hamburger menu for mobile */
        .hamburger {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1100;
            background-color: var(--primary-green);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 30px 20px;
            color: var(--muted-green);
            font-size: 0.9rem;
            margin-top: 60px;
            width: 100%;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            background: white;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .footer p {
            max-width: 800px;
            width: 100%;
            text-align: center;
            line-height: 1.5;
            margin: 0 auto 15px;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
            flex-wrap: wrap;
            max-width: 800px;
            width: 100%;
        }

        /* Excel-like Spreadsheet Styles */
        .excel-container {
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .excel-toolbar {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .excel-search {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .excel-search input {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            width: 250px;
        }

        .excel-stats {
            display: flex;
            gap: 20px;
            color: var(--muted-green);
            font-size: 0.9rem;
        }

        .excel-table-container {
            overflow-x: auto;
            max-height: 600px;
            border: 1px solid #dee2e6;
        }

        .excel-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        .excel-table th {
            background-color: var(--primary-green);
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            border: 1px solid rgba(255, 255, 255, 0.2);
            user-select: none;
        }

        .excel-table td {
            padding: 10px 15px;
            border: 1px solid #dee2e6;
            transition: background-color 0.2s;
        }

        .excel-table tr:hover td {
            background-color: rgba(7, 88, 36, 0.05);
        }

        .excel-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .excel-table .header-cell {
            position: relative;
            cursor: pointer;
        }

        .excel-table .header-cell:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .excel-table .sort-icon {
            margin-left: 5px;
            opacity: 0.7;
        }

        .cell-editable {
            cursor: pointer;
            position: relative;
        }

        .cell-editable:hover {
            background-color: rgba(155, 174, 48, 0.1);
        }

        .cell-editing {
            background-color: #fffde7;
            border: 2px solid var(--accent-green) !important;
        }

        .cell-input {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            font: inherit;
            padding: 2px;
            outline: none;
        }

        .excel-pagination {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-info {
            color: var(--muted-green);
            font-size: 0.9rem;
        }

        .page-btn {
            width: 35px;
            height: 35px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .page-btn:hover:not(:disabled) {
            background-color: var(--primary-green);
            color: white;
            border-color: var(--primary-green);
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .excel-filters {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 0.9rem;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px;
            background: white;
            border-radius: 12px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(7, 88, 36, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-green);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* No Data Message */
        .no-data {
            text-align: center;
            padding: 60px 30px;
            background: white;
            border-radius: 12px;
        }

        .no-data i {
            font-size: 4rem;
            color: var(--muted-green);
            opacity: 0.3;
            margin-bottom: 20px;
        }

        .no-data h3 {
            color: var(--primary-green);
            margin-bottom: 15px;
        }

        .no-data p {
            max-width: 500px;
            margin: 0 auto;
            color: #666;
        }

        /* Setup Database Message */
        .setup-database {
            text-align: center;
            padding: 60px 30px;
            background: white;
            border-radius: 12px;
        }

        .setup-database i {
            font-size: 4rem;
            color: var(--muted-green);
            opacity: 0.3;
            margin-bottom: 20px;
        }

        .setup-database h3 {
            color: var(--primary-green);
            margin-bottom: 15px;
        }

        .setup-database p {
            max-width: 600px;
            margin: 0 auto 25px;
            color: #666;
            line-height: 1.6;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 100px 20px 40px;
                width: 100%;
            }

            .top-header {
                left: 0;
            }

            .hamburger {
                display: flex;
            }
            
            .excel-toolbar, .excel-pagination {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                max-width: 320px;
            }

            .top-header {
                padding: 15px 20px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .user-profile-top {
                align-self: flex-end;
                margin-top: 10px;
            }

            .excel-search input {
                width: 200px;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 120px 15px 30px;
            }

            .user-info-top {
                display: none;
            }
            
            .excel-stats {
                flex-direction: column;
                gap: 5px;
            }
            
            .excel-filters {
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
            }
            
            .filter-select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Hamburger Menu for Mobile -->
    <div class="hamburger" id="hamburger">
        <i class="fas fa-bars"></i>
    </div>

    <!-- Top Header with User Profile -->
    <div class="top-header" id="topHeader">
        <div class="page-title">
            <h1 id="pageTitle">Combine Results</h1>
            <p id="pageSubtitle">Examination Office - Alliance Girls High School</p>
        </div>
        
        <div class="user-profile-top" id="userProfileTop">
            <div class="user-avatar-top" id="userAvatar">
                EX
            </div>
            <div class="user-info-top">
                <h4 id="userName">Examination Officer</h4>
                <p id="userRole">Examination Office</p>
            </div>
            <i class="fas fa-chevron-down" id="dropdownArrow"></i>
        </div>
        
        <!-- User Dropdown Menu -->
        <div class="user-dropdown" id="userDropdown">
            <a href="#" class="dropdown-item">
                <i class="fas fa-user-edit"></i> Edit Profile
            </a>
            <a href="#" class="dropdown-item">
                <i class="fas fa-cog"></i> Settings
            </a>
            <a href="#" class="dropdown-item">
                <i class="fas fa-question-circle"></i> Help & Support
            </a>
            <div style="height: 1px; background-color: #eee; margin: 10px 0;"></div>
            <a href="#" class="dropdown-item" id="logoutLink">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </div>

    <!-- Left Navigation Pane -->
    <div class="sidebar" id="sidebar">
        <!-- Sidebar Header -->
        <div class="sidebar-header">
            <div class="badge-container">
                <div class="badge-fallback">
                    <i class="fas fa-graduation-cap"></i>
                </div>
            </div>
            <div class="sidebar-title">
                <h1>Examination Office</h1>
                <h2>Full Control Panel</h2>
            </div>
        </div>

        <!-- Navigation Menu -->
        <ul class="sidebar-nav">
            <li class="nav-section-title">Exam Control</li>
            <li class="nav-item">
                <a href="examination_office.html" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a href="examination_office.html#start-exam" class="nav-link">
                    <i class="fas fa-play-circle"></i> Start Exam Session
                </a>
            </li>
            <li class="nav-item">
                <a href="subject_management.html" class="nav-link">
                    <i class="fas fa-book"></i> Subject Management
                </a>
            </li>
            <li class="nav-item">
                <a href="examination_office.html#close-exam" class="nav-link">
                    <i class="fas fa-stop-circle"></i> Close Exam Sessions
                </a>
            </li>
            
            <li class="nav-section-title">Reporting & Communication</li>
            <li class="nav-item">
                <a href="examination_office.html#reports" class="nav-link">
                    <i class="fas fa-file-alt"></i> Generate Report Cards
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link active">
                    <i class="fas fa-cogs"></i> Combine Results
                </a>
            </li>
            <li class="nav-item">
                <a href="examination_office.html#email-parents" class="nav-link">
                    <i class="fas fa-envelope"></i> Email Parents
                </a>
            </li>
            <li class="nav-item">
                <a href="examination_office.html#analytics" class="nav-link">
                    <i class="fas fa-chart-bar"></i> Analytics & Insights
                </a>
            </li>
            
            <li class="nav-section-title">Help</li>
            <li class="nav-item">
                <a href="examination_office.html#help" class="nav-link">
                    <i class="fas fa-question-circle"></i> Help Center
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link logout-sidebar">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </li>
        </ul>
    </div>

    <!-- Main Content Area -->
    <div class="main-content" id="mainContent">
        <div class="data-section">
            <div class="section-title">
                <h2><i class="fas fa-cogs"></i> Combine Examination Results</h2>
                <div class="section-info">View and combine student performance data from all forms</div>
            </div>

            <!-- Filter Controls -->
            <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: var(--card-shadow); margin-bottom: 30px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div class="form-group">
                        <label>Form/Grade</label>
                        <select id="filterForm" class="filter-select">
                            <option value="">All Forms</option>
                            <option value="Form 3">Form 3</option>
                            <option value="Form 4">Form 4</option>
                            <option value="Grade 10">Grade 10</option>
                            <option value="Grade 11">Grade 11</option>
                            <option value="Grade 12">Grade 12</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Stream</label>
                        <select id="filterStream" class="filter-select">
                            <option value="">All Streams</option>
                            <option value="North">North</option>
                            <option value="South">South</option>
                            <option value="East">East</option>
                            <option value="West">West</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Subject</label>
                        <select id="filterSubject" class="filter-select">
                            <option value="">All Subjects</option>
                            <!-- Options will be loaded dynamically -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Exam Type</label>
                        <select id="filterExamType" class="filter-select">
                            <option value="">All Exam Types</option>
                            <option value="Term 1">Term 1</option>
                            <option value="Term 2">Term 2</option>
                            <option value="Term 3">Term 3</option>
                            <option value="Mock">Mock</option>
                            <option value="Final">Final</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button class="btn btn-primary" id="applyFilters">
                        <i class="fas fa-filter"></i> Apply Filters
                    </button>
                    <button class="btn btn-outline" id="clearFilters">
                        <i class="fas fa-times"></i> Clear Filters
                    </button>
                    <button class="btn btn-secondary" id="fetchData">
                        <i class="fas fa-sync-alt"></i> Refresh Data
                    </button>
                </div>
            </div>

            <!-- Excel-like Spreadsheet -->
            <div class="excel-container" id="excelContainer">
                <!-- Toolbar -->
                <div class="excel-toolbar">
                    <div class="excel-search">
                        <input type="text" id="searchInput" placeholder="Search in all columns...">
                        <button class="btn btn-sm btn-outline" id="searchBtn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    
                    <div class="excel-stats">
                        <span id="rowCount">Loading...</span>
                        <span id="filteredCount"></span>
                    </div>
                    
                    <div class="excel-filters">
                        <select id="sortColumn" class="filter-select">
                            <option value="">Sort by...</option>
                        </select>
                        <select id="sortDirection" class="filter-select">
                            <option value="asc">Ascending</option>
                            <option value="desc">Descending</option>
                        </select>
                    </div>
                </div>

                <!-- Loading State -->
                <div class="loading-spinner" id="loadingSpinner">
                    <div class="spinner"></div>
                    <div style="margin-left: 15px; color: var(--primary-green);">Loading student performance data...</div>
                </div>

                <!-- No Data State -->
                <div class="no-data" id="noDataMessage" style="display: none;">
                    <i class="fas fa-database"></i>
                    <h3>No Performance Data Found</h3>
                    <p>No student performance records found in the database. Please ensure marks have been submitted.</p>
                    <button class="btn btn-primary" onclick="fetchStudentPerformance()" style="margin-top: 20px;">
                        <i class="fas fa-sync-alt"></i> Try Again
                    </button>
                </div>

                <!-- Setup Database Message -->
                <div class="setup-database" id="setupDatabaseMessage" style="display: none;">
                    <i class="fas fa-tools"></i>
                    <h3>Database Table Not Found</h3>
                    <p>The <code>student_performance</code> table doesn't exist in your database. Click the button below to create the table automatically.</p>
                    <p style="font-size: 0.9rem; color: var(--muted-green); margin-bottom: 25px;">
                        The table will be created with the correct structure for storing student performance data.
                    </p>
                    <button class="btn btn-primary" id="createTableBtn" style="margin-top: 20px;">
                        <i class="fas fa-plus-circle"></i> Create Performance Table
                    </button>
                    <button class="btn btn-outline" onclick="checkTableExists()" style="margin-top: 10px;">
                        <i class="fas fa-redo"></i> Check Again
                    </button>
                </div>

                <!-- Excel Table -->
                <div class="excel-table-container" id="tableContainer" style="display: none;">
                    <table class="excel-table" id="excelTable">
                        <thead id="tableHeader">
                            <!-- Header will be populated by JavaScript -->
                        </thead>
                        <tbody id="tableBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="excel-pagination" id="paginationContainer" style="display: none;">
                    <div class="pagination-controls">
                        <button class="page-btn" id="firstPage">
                            <i class="fas fa-angle-double-left"></i>
                        </button>
                        <button class="page-btn" id="prevPage">
                            <i class="fas fa-angle-left"></i>
                        </button>
                        <span class="page-info" id="pageInfo">Page 1 of 1</span>
                        <button class="page-btn" id="nextPage">
                            <i class="fas fa-angle-right"></i>
                        </button>
                        <button class="page-btn" id="lastPage">
                            <i class="fas fa-angle-double-right"></i>
                        </button>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: var(--muted-green); font-size: 0.9rem;">Rows per page:</span>
                        <select id="rowsPerPage" class="filter-select">
                            <option value="20">20</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                            <option value="200">200</option>
                            <option value="500">500</option>
                        </select>
                        
                        <button class="btn btn-success" id="exportCsv">
                            <i class="fas fa-file-csv"></i> Export to CSV
                        </button>
                        <button class="btn btn-primary" id="exportSummary">
                            <i class="fas fa-chart-bar"></i> Export Summary
                        </button>
                    </div>
                </div>
            </div>

            <!-- Data Summary -->
            <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: var(--card-shadow); margin-bottom: 40px;">
                <h3 style="color: var(--primary-green); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-chart-bar"></i> Data Summary
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div style="text-align: center; padding: 20px; background: rgba(7, 88, 36, 0.05); border-radius: 8px;">
                        <div style="font-size: 2.5rem; color: var(--primary-green); font-weight: bold;" id="totalStudents">0</div>
                        <div style="color: var(--muted-green); margin-top: 5px;">Total Students</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: rgba(7, 88, 36, 0.05); border-radius: 8px;">
                        <div style="font-size: 2.5rem; color: var(--primary-green); font-weight: bold;" id="totalSubjects">0</div>
                        <div style="color: var(--muted-green); margin-top: 5px;">Subjects</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: rgba(7, 88, 36, 0.05); border-radius: 8px;">
                        <div style="font-size: 2.5rem; color: var(--primary-green); font-weight: bold;" id="avgScore">0%</div>
                        <div style="color: var(--muted-green); margin-top: 5px;">Avg Percentage</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: rgba(7, 88, 36, 0.05); border-radius: 8px;">
                        <div style="font-size: 2.5rem; color: var(--primary-green); font-weight: bold;" id="dataUpdated">-</div>
                        <div style="color: var(--muted-green); margin-top: 5px;">Last Updated</div>
                    </div>
                </div>
                
                <!-- Grade Distribution -->
                <div style="margin-top: 30px;">
                    <h4 style="color: var(--secondary-green); margin-bottom: 15px;">Grade Distribution</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div style="text-align: center; padding: 15px; background: rgba(220, 53, 69, 0.1); border-radius: 8px;">
                            <div style="font-size: 1.8rem; color: #dc3545; font-weight: bold;" id="gradeA">0</div>
                            <div style="color: #666; margin-top: 5px;">Grade A</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(255, 193, 7, 0.1); border-radius: 8px;">
                            <div style="font-size: 1.8rem; color: #ffc107; font-weight: bold;" id="gradeB">0</div>
                            <div style="color: #666; margin-top: 5px;">Grade B</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(40, 167, 69, 0.1); border-radius: 8px;">
                            <div style="font-size: 1.8rem; color: #28a745; font-weight: bold;" id="gradeC">0</div>
                            <div style="color: #666; margin-top: 5px;">Grade C</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(108, 117, 125, 0.1); border-radius: 8px;">
                            <div style="font-size: 1.8rem; color: #6c757d; font-weight: bold;" id="gradeD">0</div>
                            <div style="color: #666; margin-top: 5px;">Grade D</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(23, 162, 184, 0.1); border-radius: 8px;">
                            <div style="font-size: 1.8rem; color: #17a2b8; font-weight: bold;" id="gradeE">0</div>
                            <div style="color: #666; margin-top: 5px;">Grade E</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="footer">
                <p>Â© 2026 Alliance Girls High School - Examination Office. All rights reserved.</p>
                <div class="footer-links">
                    <a href="#">Privacy Policy</a>
                    <a href="#">Terms of Service</a>
                    <a href="#">Help Center</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Combine Results Page
        (function() {
            // Prevent multiple initializations
            if (window.combineResultsInitialized) return;
            window.combineResultsInitialized = true;
            
            console.log('Initializing Combine Results Page...');
            
            // Initialize Supabase client
            let supabase;
            let currentUser = null;
            let studentPerformanceData = [];
            let filteredData = [];
            let columns = [];
            let currentPage = 1;
            let rowsPerPage = 50;
            let totalPages = 1;
            let sortConfig = { column: '', direction: 'asc' };
            
            try {
                const supabaseUrl = 'https://eloqizcahwxavsbalxii.supabase.co';
                const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVsb3FpemNhaHd4YXZzYmFseGlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTQ4OTUsImV4cCI6MjA4MzI5MDg5NX0.SGogIbdShzCLv2TovpdS1BDf6GJx4mu0iz9s25BGRRQ';
                
                supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
                console.log('Supabase client initialized for Combine Results');
            } catch (error) {
                console.error('Failed to initialize Supabase:', error);
                alert('Failed to initialize application. Please refresh the page.');
                return;
            }

            // DOM Elements
            const hamburger = document.getElementById('hamburger');
            const sidebar = document.getElementById('sidebar');
            const userProfileTop = document.getElementById('userProfileTop');
            const userDropdown = document.getElementById('userDropdown');
            const dropdownArrow = document.getElementById('dropdownArrow');
            const logoutLink = document.getElementById('logoutLink');
            const logoutSidebarLinks = document.querySelectorAll('.logout-sidebar');
            
            // Filter elements
            const filterForm = document.getElementById('filterForm');
            const filterStream = document.getElementById('filterStream');
            const filterSubject = document.getElementById('filterSubject');
            const filterExamType = document.getElementById('filterExamType');
            const applyFilters = document.getElementById('applyFilters');
            const clearFilters = document.getElementById('clearFilters');
            const fetchData = document.getElementById('fetchData');
            
            // Excel spreadsheet elements
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            const rowCount = document.getElementById('rowCount');
            const filteredCount = document.getElementById('filteredCount');
            const sortColumn = document.getElementById('sortColumn');
            const sortDirection = document.getElementById('sortDirection');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const noDataMessage = document.getElementById('noDataMessage');
            const setupDatabaseMessage = document.getElementById('setupDatabaseMessage');
            const createTableBtn = document.getElementById('createTableBtn');
            const tableContainer = document.getElementById('tableContainer');
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');
            const paginationContainer = document.getElementById('paginationContainer');
            const firstPage = document.getElementById('firstPage');
            const prevPage = document.getElementById('prevPage');
            const nextPage = document.getElementById('nextPage');
            const lastPage = document.getElementById('lastPage');
            const pageInfo = document.getElementById('pageInfo');
            const rowsPerPageSelect = document.getElementById('rowsPerPage');
            const exportCsv = document.getElementById('exportCsv');
            const exportSummary = document.getElementById('exportSummary');
            
            // Summary elements
            const totalStudents = document.getElementById('totalStudents');
            const totalSubjects = document.getElementById('totalSubjects');
            const avgScore = document.getElementById('avgScore');
            const dataUpdated = document.getElementById('dataUpdated');
            const gradeA = document.getElementById('gradeA');
            const gradeB = document.getElementById('gradeB');
            const gradeC = document.getElementById('gradeC');
            const gradeD = document.getElementById('gradeD');
            const gradeE = document.getElementById('gradeE');

            // Function to load user data
            async function loadUserData() {
                try {
                    console.log('Loading examination officer data...');
                    
                    // Check if user is logged in
                    const { data: { user }, error: userError } = await supabase.auth.getUser();
                    
                    if (userError) {
                        console.error('Auth error:', userError);
                        redirectToLogin();
                        return;
                    }
                    
                    if (!user) {
                        console.error('No user found - redirecting to login');
                        redirectToLogin();
                        return;
                    }
                    
                    currentUser = user;
                    console.log('Examination officer authenticated:', user.id);
                    
                    // Initialize page
                    initializePage();
                    
                } catch (error) {
                    console.error('Error loading user data:', error);
                }
            }

            // Function to redirect to login
            function redirectToLogin() {
                window.location.href = 'index.html';
            }

            // Function to initialize the page
            async function initializePage() {
                console.log('Initializing Combine Results page...');
                
                // First check if the table exists
                await checkTableExists();
                
                // Setup event listeners
                setupEventListeners();
                
                console.log('Combine Results page initialized successfully');
            }

            // Function to check if table exists
            async function checkTableExists() {
                try {
                    console.log('Checking if student_performance table exists...');
                    
                    // Hide all containers
                    loadingSpinner.style.display = 'flex';
                    noDataMessage.style.display = 'none';
                    setupDatabaseMessage.style.display = 'none';
                    tableContainer.style.display = 'none';
                    paginationContainer.style.display = 'none';
                    
                    rowCount.textContent = 'Checking database...';
                    
                    // Try to query the table with a simple select
                    const { data, error } = await supabase
                        .from('student_performance')
                        .select('admission_no')
                        .limit(1);
                    
                    if (error) {
                        console.log('Table does not exist or error:', error.message);
                        
                        if (error.code === 'PGRST116' || error.message.includes('does not exist')) {
                            // Table doesn't exist, show setup message
                            showSetupDatabaseMessage();
                        } else {
                            // Other error
                            console.error('Error checking table:', error);
                            showNoDataMessage();
                        }
                    } else {
                        console.log('Table exists, proceeding with data fetch...');
                        // Table exists, proceed with normal flow
                        await loadDropdownOptions();
                        await fetchStudentPerformance();
                    }
                    
                } catch (error) {
                    console.error('Error in checkTableExists:', error);
                    showNoDataMessage();
                }
            }

            // Function to show setup database message
            function showSetupDatabaseMessage() {
                loadingSpinner.style.display = 'none';
                noDataMessage.style.display = 'none';
                setupDatabaseMessage.style.display = 'block';
                tableContainer.style.display = 'none';
                paginationContainer.style.display = 'none';
            }

            // Function to create the student_performance table
            async function createPerformanceTable() {
                try {
                    createTableBtn.disabled = true;
                    createTableBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Table...';
                    
                    console.log('Creating student_performance table...');
                    
                    // Show SQL to create table (for manual execution in Supabase SQL editor)
                    const createTableSQL = `
CREATE TABLE IF NOT EXISTS student_performance (
    id BIGSERIAL PRIMARY KEY,
    admission_no VARCHAR(50) NOT NULL,
    student_name VARCHAR(200) NOT NULL,
    stream VARCHAR(50),
    form_grade VARCHAR(50) NOT NULL,
    subject_code VARCHAR(50) NOT NULL,
    exam_type VARCHAR(50) NOT NULL,
    marks_obtained DECIMAL(5,2),
    max_score DECIMAL(5,2) DEFAULT 100.00,
    percentage DECIMAL(5,2),
    grade VARCHAR(2),
    exam_date DATE,
    teacher_name VARCHAR(200),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Create indexes for better performance
CREATE INDEX idx_student_performance_admission ON student_performance(admission_no);
CREATE INDEX idx_student_performance_form ON student_performance(form_grade);
CREATE INDEX idx_student_performance_subject ON student_performance(subject_code);
CREATE INDEX idx_student_performance_exam_type ON student_performance(exam_type);
CREATE INDEX idx_student_performance_stream ON student_performance(stream);
`;
                    
                    // Since we can't execute SQL directly from the client,
                    // we'll create the table by inserting a dummy record
                    // This will auto-create the table if RLS policies allow
                    console.log('Attempting to auto-create table by inserting dummy record...');
                    
                    const { data, error } = await supabase
                        .from('student_performance')
                        .insert([{
                            admission_no: 'TEST001',
                            student_name: 'Test Student',
                            stream: 'North',
                            form_grade: 'Form 3',
                            subject_code: 'MATH',
                            exam_type: 'Term 1',
                            marks_obtained: 85.5,
                            max_score: 100,
                            percentage: 85.5,
                            grade: 'A',
                            exam_date: new Date().toISOString().split('T')[0],
                            teacher_name: 'Test Teacher'
                        }])
                        .select();
                    
                    if (error) {
                        console.error('Error creating table:', error);
                        
                        // Show manual SQL creation instructions
                        alert(`Unable to create table automatically. Please run this SQL in your Supabase SQL Editor:\n\n${createTableSQL}\n\nAfter creating the table, refresh this page.`);
                    } else {
                        console.log('Table created successfully');
                        alert('Table created successfully! Now fetching data...');
                        
                        // Now fetch the data
                        await loadDropdownOptions();
                        await fetchStudentPerformance();
                    }
                    
                } catch (error) {
                    console.error('Error in createPerformanceTable:', error);
                    alert('Error creating table. Please check console for details.');
                } finally {
                    createTableBtn.disabled = false;
                    createTableBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Create Performance Table';
                }
            }

            // Function to load dropdown options from existing data
            async function loadDropdownOptions() {
                try {
                    // Load unique subjects from existing data
                    const { data: subjectsData, error: subjectsError } = await supabase
                        .from('student_performance')
                        .select('subject_code')
                        .order('subject_code');
                    
                    if (!subjectsError && subjectsData) {
                        // Get unique subjects
                        const uniqueSubjects = [...new Set(subjectsData.map(item => item.subject_code).filter(Boolean))];
                        filterSubject.innerHTML = '<option value="">All Subjects</option>' +
                            uniqueSubjects.map(subject => 
                                `<option value="${subject}">${subject}</option>`
                            ).join('');
                    }
                    
                    // Load unique exam types
                    const { data: examTypesData, error: examTypesError } = await supabase
                        .from('student_performance')
                        .select('exam_type')
                        .order('exam_type');
                    
                    if (!examTypesError && examTypesData) {
                        // Get unique exam types
                        const uniqueExamTypes = [...new Set(examTypesData.map(item => item.exam_type).filter(Boolean))];
                        // Update the exam type dropdown if we found new ones
                        if (uniqueExamTypes.length > 0) {
                            let currentOptions = Array.from(filterExamType.options).map(opt => opt.value);
                            uniqueExamTypes.forEach(type => {
                                if (!currentOptions.includes(type)) {
                                    filterExamType.innerHTML += `<option value="${type}">${type}</option>`;
                                }
                            });
                        }
                    }
                    
                } catch (error) {
                    console.error('Error loading dropdown options:', error);
                }
            }

            // Main function to fetch student performance data
            async function fetchStudentPerformance() {
                try {
                    console.log('Fetching student performance data from database...');
                    
                    // Show loading spinner
                    loadingSpinner.style.display = 'flex';
                    noDataMessage.style.display = 'none';
                    setupDatabaseMessage.style.display = 'none';
                    tableContainer.style.display = 'none';
                    paginationContainer.style.display = 'none';
                    rowCount.textContent = 'Loading data...';
                    
                    // Build query
                    let query = supabase
                        .from('student_performance')
                        .select('*');
                    
                    // Apply filters if any
                    const formFilter = filterForm.value;
                    const streamFilter = filterStream.value;
                    const subjectFilter = filterSubject.value;
                    const examTypeFilter = filterExamType.value;
                    
                    if (formFilter) {
                        query = query.eq('form_grade', formFilter);
                    }
                    if (streamFilter) {
                        query = query.eq('stream', streamFilter);
                    }
                    if (subjectFilter) {
                        query = query.eq('subject_code', subjectFilter);
                    }
                    if (examTypeFilter) {
                        query = query.eq('exam_type', examTypeFilter);
                    }
                    
                    // Execute query
                    const { data, error } = await query.order('exam_date', { ascending: false });
                    
                    if (error) {
                        console.error('Error fetching student performance:', error);
                        throw error;
                    }
                    
                    console.log(`Fetched ${data?.length || 0} student performance records`);
                    
                    // Process data
                    studentPerformanceData = data || [];
                    filteredData = [...studentPerformanceData];
                    
                    // Extract columns from data
                    if (studentPerformanceData.length > 0) {
                        extractColumns();
                        updateSummary();
                        renderExcelTable();
                    } else {
                        showNoDataMessage();
                    }
                    
                } catch (error) {
                    console.error('Error in fetchStudentPerformance:', error);
                    showNoDataMessage();
                }
            }

            // Function to extract columns from data
            function extractColumns() {
                if (studentPerformanceData.length === 0) return;
                
                // Get all unique keys from the first few records
                const sampleRecord = studentPerformanceData[0];
                columns = Object.keys(sampleRecord);
                
                // Define column display names and order based on your table structure
                const columnDisplayNames = {
                    id: 'ID',
                    admission_no: 'Admission No',
                    student_name: 'Student Name',
                    stream: 'Stream',
                    form_grade: 'Form/Grade',
                    subject_code: 'Subject Code',
                    exam_type: 'Exam Type',
                    marks_obtained: 'Marks Obtained',
                    max_score: 'Max Score',
                    percentage: 'Percentage',
                    grade: 'Grade',
                    exam_date: 'Exam Date',
                    teacher_name: 'Teacher Name',
                    created_at: 'Created At',
                    updated_at: 'Updated At'
                };
                
                // Sort columns in a logical order
                const columnOrder = [
                    'admission_no', 'student_name', 'form_grade', 'stream', 
                    'subject_code', 'exam_type', 'marks_obtained', 'max_score', 
                    'percentage', 'grade', 'exam_date', 'teacher_name',
                    'created_at', 'updated_at', 'id'
                ];
                
                // Reorder columns based on the defined order
                columns = columnOrder.filter(col => sampleRecord.hasOwnProperty(col));
                
                // Update sort dropdown
                updateSortDropdown();
            }

            // Function to update sort dropdown
            function updateSortDropdown() {
                sortColumn.innerHTML = '<option value="">Sort by...</option>';
                
                columns.forEach(column => {
                    const displayName = getColumnDisplayName(column);
                    if (displayName) {
                        sortColumn.innerHTML += `<option value="${column}">${displayName}</option>`;
                    }
                });
            }

            // Function to get column display name
            function getColumnDisplayName(column) {
                const displayNames = {
                    'admission_no': 'Admission No',
                    'student_name': 'Student Name',
                    'stream': 'Stream',
                    'form_grade': 'Form/Grade',
                    'subject_code': 'Subject Code',
                    'exam_type': 'Exam Type',
                    'marks_obtained': 'Marks Obtained',
                    'max_score': 'Max Score',
                    'percentage': 'Percentage',
                    'grade': 'Grade',
                    'exam_date': 'Exam Date',
                    'teacher_name': 'Teacher Name',
                    'created_at': 'Created At',
                    'updated_at': 'Updated At'
                };
                
                return displayNames[column] || column.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            }

            // Function to update data summary
            function updateSummary() {
                if (studentPerformanceData.length === 0) {
                    totalStudents.textContent = '0';
                    totalSubjects.textContent = '0';
                    avgScore.textContent = '0%';
                    dataUpdated.textContent = '-';
                    gradeA.textContent = '0';
                    gradeB.textContent = '0';
                    gradeC.textContent = '0';
                    gradeD.textContent = '0';
                    gradeE.textContent = '0';
                    return;
                }
                
                // Calculate unique students
                const uniqueStudents = new Set(studentPerformanceData.map(item => item.admission_no));
                totalStudents.textContent = uniqueStudents.size;
                
                // Calculate unique subjects
                const uniqueSubjects = new Set(studentPerformanceData.map(item => item.subject_code));
                totalSubjects.textContent = uniqueSubjects.size;
                
                // Calculate average percentage
                const percentages = studentPerformanceData
                    .filter(item => item.percentage && !isNaN(item.percentage))
                    .map(item => parseFloat(item.percentage));
                
                const avg = percentages.length > 0 ? 
                    Math.round(percentages.reduce((a, b) => a + b, 0) / percentages.length) : 0;
                avgScore.textContent = avg + '%';
                
                // Get last updated timestamp
                const latestTimestamp = studentPerformanceData
                    .map(item => new Date(item.updated_at || item.created_at || item.exam_date))
                    .filter(date => !isNaN(date.getTime()))
                    .sort((a, b) => b - a)[0];
                
                if (latestTimestamp) {
                    dataUpdated.textContent = latestTimestamp.toLocaleDateString();
                }
                
                // Calculate grade distribution
                const grades = studentPerformanceData
                    .filter(item => item.grade)
                    .map(item => item.grade.toUpperCase());
                
                gradeA.textContent = grades.filter(g => g === 'A').length;
                gradeB.textContent = grades.filter(g => g === 'B').length;
                gradeC.textContent = grades.filter(g => g === 'C').length;
                gradeD.textContent = grades.filter(g => g === 'D').length;
                gradeE.textContent = grades.filter(g => g === 'E').length;
            }

            // Function to render Excel-like table
            function renderExcelTable() {
                // Hide loading, show table
                loadingSpinner.style.display = 'none';
                noDataMessage.style.display = 'none';
                setupDatabaseMessage.style.display = 'none';
                tableContainer.style.display = 'block';
                paginationContainer.style.display = 'flex';
                
                // Apply search filter if any
                applySearchFilter();
                
                // Apply sorting if configured
                if (sortConfig.column) {
                    applySorting();
                }
                
                // Update row counts
                rowCount.textContent = `Total Records: ${studentPerformanceData.length}`;
                filteredCount.textContent = filteredData.length === studentPerformanceData.length ? 
                    '' : `Filtered: ${filteredData.length}`;
                
                // Calculate pagination
                totalPages = Math.ceil(filteredData.length / rowsPerPage);
                if (currentPage > totalPages) {
                    currentPage = Math.max(1, totalPages);
                }
                
                // Update pagination controls
                updatePagination();
                
                // Render table header
                renderTableHeader();
                
                // Render table body
                renderTableBody();
            }

            // Function to apply search filter
            function applySearchFilter() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                
                if (!searchTerm) {
                    filteredData = [...studentPerformanceData];
                    return;
                }
                
                filteredData = studentPerformanceData.filter(row => {
                    return Object.values(row).some(value => {
                        if (value === null || value === undefined) return false;
                        return value.toString().toLowerCase().includes(searchTerm);
                    });
                });
            }

            // Function to apply sorting
            function applySorting() {
                if (!sortConfig.column) return;
                
                filteredData.sort((a, b) => {
                    let aValue = a[sortConfig.column];
                    let bValue = b[sortConfig.column];
                    
                    // Handle null/undefined values
                    if (aValue === null || aValue === undefined) aValue = '';
                    if (bValue === null || bValue === undefined) bValue = '';
                    
                    // Convert to string for comparison
                    aValue = aValue.toString();
                    bValue = bValue.toString();
                    
                    // Try to convert to numbers if possible
                    const aNum = parseFloat(aValue);
                    const bNum = parseFloat(bValue);
                    
                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        aValue = aNum;
                        bValue = bNum;
                    }
                    
                    if (sortConfig.direction === 'asc') {
                        return aValue < bValue ? -1 : aValue > bValue ? 1 : 0;
                    } else {
                        return aValue > bValue ? -1 : aValue < bValue ? 1 : 0;
                    }
                });
            }

            // Function to update pagination
            function updatePagination() {
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
                
                firstPage.disabled = currentPage === 1;
                prevPage.disabled = currentPage === 1;
                nextPage.disabled = currentPage === totalPages;
                lastPage.disabled = currentPage === totalPages;
                
                // Update page buttons display
                if (totalPages === 0) {
                    paginationContainer.style.display = 'none';
                }
            }

            // Function to render table header
            function renderTableHeader() {
                let headerHTML = '<tr>';
                
                columns.forEach(column => {
                    const displayName = getColumnDisplayName(column);
                    if (displayName) {
                        const isSorted = column === sortConfig.column;
                        const sortIcon = isSorted ? 
                            (sortConfig.direction === 'asc' ? 
                                '<i class="fas fa-sort-up sort-icon"></i>' : 
                                '<i class="fas fa-sort-down sort-icon"></i>') : 
                            '<i class="fas fa-sort sort-icon"></i>';
                        
                        headerHTML += `
                            <th class="header-cell" data-column="${column}">
                                ${displayName} ${sortIcon}
                            </th>
                        `;
                    }
                });
                
                headerHTML += '</tr>';
                tableHeader.innerHTML = headerHTML;
                
                // Add click handlers for sorting
                document.querySelectorAll('.header-cell').forEach(th => {
                    th.addEventListener('click', () => {
                        const column = th.dataset.column;
                        
                        if (sortConfig.column === column) {
                            // Toggle direction
                            sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
                        } else {
                            // New column, default to ascending
                            sortConfig.column = column;
                            sortConfig.direction = 'asc';
                        }
                        
                        // Update UI
                        sortColumn.value = column;
                        sortDirection.value = sortConfig.direction;
                        
                        // Re-render table
                        renderExcelTable();
                    });
                });
            }

            // Function to render table body
            function renderTableBody() {
                // Calculate start and end indices for current page
                const startIndex = (currentPage - 1) * rowsPerPage;
                const endIndex = Math.min(startIndex + rowsPerPage, filteredData.length);
                const pageData = filteredData.slice(startIndex, endIndex);
                
                let bodyHTML = '';
                
                pageData.forEach((row, rowIndex) => {
                    bodyHTML += '<tr>';
                    
                    columns.forEach(column => {
                        let cellValue = row[column];
                        
                        // Format special columns
                        if ((column === 'marks_obtained' || column === 'max_score' || column === 'percentage') 
                            && cellValue !== null && cellValue !== undefined) {
                            const numValue = parseFloat(cellValue);
                            if (!isNaN(numValue)) {
                                if (column === 'percentage') {
                                    cellValue = numValue.toFixed(1) + '%';
                                } else {
                                    cellValue = numValue.toFixed(1);
                                }
                            }
                        } else if ((column === 'created_at' || column === 'updated_at' || column === 'exam_date') && cellValue) {
                            try {
                                const date = new Date(cellValue);
                                if (!isNaN(date.getTime())) {
                                    if (column === 'exam_date') {
                                        cellValue = date.toLocaleDateString();
                                    } else {
                                        cellValue = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                                    }
                                }
                            } catch (e) {
                                // Keep original value if date parsing fails
                            }
                        }
                        
                        // Default for null/undefined
                        if (cellValue === null || cellValue === undefined) {
                            cellValue = '';
                        }
                        
                        // Add data attribute for searching
                        bodyHTML += `<td data-column="${column}" data-value="${String(cellValue).replace(/"/g, '&quot;')}">${cellValue}</td>`;
                    });
                    
                    bodyHTML += '</tr>';
                });
                
                tableBody.innerHTML = bodyHTML;
                
                // If no data on current page, show message
                if (pageData.length === 0 && filteredData.length > 0) {
                    bodyHTML = `<tr><td colspan="${columns.length}" style="text-align: center; padding: 40px; color: var(--muted-green);">
                        No data to display for this page
                    </td></tr>`;
                    tableBody.innerHTML = bodyHTML;
                }
            }

            // Function to show no data message
            function showNoDataMessage() {
                loadingSpinner.style.display = 'none';
                noDataMessage.style.display = 'block';
                setupDatabaseMessage.style.display = 'none';
                tableContainer.style.display = 'none';
                paginationContainer.style.display = 'none';
                
                totalStudents.textContent = '0';
                totalSubjects.textContent = '0';
                avgScore.textContent = '0%';
                dataUpdated.textContent = '-';
                gradeA.textContent = '0';
                gradeB.textContent = '0';
                gradeC.textContent = '0';
                gradeD.textContent = '0';
                gradeE.textContent = '0';
            }

            // Function to export to CSV
            function exportToCSV() {
                if (filteredData.length === 0) {
                    alert('No data to export.');
                    return;
                }
                
                try {
                    // Create CSV content
                    let csvContent = '';
                    
                    // Add header row
                    const headers = columns.map(col => `"${getColumnDisplayName(col)}"`);
                    csvContent += headers.join(',') + '\n';
                    
                    // Add data rows
                    filteredData.forEach(row => {
                        const rowData = columns.map(col => {
                            let value = row[col];
                            
                            // Format values for CSV
                            if (value === null || value === undefined) {
                                value = '';
                            } else if (typeof value === 'string') {
                                // Escape quotes and wrap in quotes
                                value = value.replace(/"/g, '""');
                                value = `"${value}"`;
                            } else if (typeof value === 'object') {
                                value = JSON.stringify(value).replace(/"/g, '""');
                                value = `"${value}"`;
                            } else {
                                // For numbers, just convert to string
                                value = value.toString();
                            }
                            
                            return value;
                        });
                        
                        csvContent += rowData.join(',') + '\n';
                    });
                    
                    // Create blob and download
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    
                    // Generate filename with timestamp
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/[:]/g, '-');
                    const filename = `student_performance_${timestamp}.csv`;
                    
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    console.log(`CSV exported: ${filename}, ${filteredData.length} records`);
                    alert(`CSV file downloaded: ${filename}\n${filteredData.length} records exported.`);
                    
                } catch (error) {
                    console.error('Error exporting CSV:', error);
                    alert('Error exporting to CSV. Please try again.');
                }
            }

            // Function to export summary statistics
            function exportSummaryStatistics() {
                if (studentPerformanceData.length === 0) {
                    alert('No data to export.');
                    return;
                }
                
                try {
                    // Calculate summary statistics
                    const uniqueStudents = new Set(studentPerformanceData.map(item => item.admission_no));
                    const uniqueSubjects = new Set(studentPerformanceData.map(item => item.subject_code));
                    
                    const percentages = studentPerformanceData
                        .filter(item => item.percentage && !isNaN(item.percentage))
                        .map(item => parseFloat(item.percentage));
                    const avgPercentage = percentages.length > 0 ? 
                        Math.round(percentages.reduce((a, b) => a + b, 0) / percentages.length) : 0;
                    
                    const grades = studentPerformanceData
                        .filter(item => item.grade)
                        .map(item => item.grade.toUpperCase());
                    
                    // Create summary CSV content
                    let csvContent = 'Category,Value\n';
                    csvContent += `Total Records,${studentPerformanceData.length}\n`;
                    csvContent += `Unique Students,${uniqueStudents.size}\n`;
                    csvContent += `Unique Subjects,${uniqueSubjects.size}\n`;
                    csvContent += `Average Percentage,${avgPercentage}%\n`;
                    csvContent += `Grade A Count,${grades.filter(g => g === 'A').length}\n`;
                    csvContent += `Grade B Count,${grades.filter(g => g === 'B').length}\n`;
                    csvContent += `Grade C Count,${grades.filter(g => g === 'C').length}\n`;
                    csvContent += `Grade D Count,${grades.filter(g => g === 'D').length}\n`;
                    csvContent += `Grade E Count,${grades.filter(g => g === 'E').length}\n`;
                    
                    // Add filter information
                    csvContent += '\nCurrent Filters\n';
                    csvContent += `Form/Grade,${filterForm.value || 'All'}\n`;
                    csvContent += `Stream,${filterStream.value || 'All'}\n`;
                    csvContent += `Subject,${filterSubject.value || 'All'}\n`;
                    csvContent += `Exam Type,${filterExamType.value || 'All'}\n`;
                    csvContent += `Search Term,${searchInput.value || 'None'}\n`;
                    csvContent += `Export Date,${new Date().toLocaleString()}\n`;
                    
                    // Create blob and download
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    
                    // Generate filename with timestamp
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/[:]/g, '-');
                    const filename = `performance_summary_${timestamp}.csv`;
                    
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    console.log(`Summary exported: ${filename}`);
                    alert(`Summary CSV file downloaded: ${filename}`);
                    
                } catch (error) {
                    console.error('Error exporting summary:', error);
                    alert('Error exporting summary. Please try again.');
                }
            }

            // Function to setup event listeners
            function setupEventListeners() {
                // Hamburger menu
                if (hamburger) {
                    hamburger.addEventListener('click', () => {
                        sidebar.classList.toggle('open');
                    });
                }

                // User dropdown
                if (userProfileTop) {
                    userProfileTop.addEventListener('click', (e) => {
                        e.stopPropagation();
                        userDropdown.classList.toggle('show');
                        dropdownArrow.classList.toggle('fa-chevron-down');
                        dropdownArrow.classList.toggle('fa-chevron-up');
                    });
                }

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (userProfileTop && userDropdown && 
                        !userProfileTop.contains(e.target) && !userDropdown.contains(e.target)) {
                        userDropdown.classList.remove('show');
                        dropdownArrow.classList.remove('fa-chevron-up');
                        dropdownArrow.classList.add('fa-chevron-down');
                    }
                    
                    // Close sidebar when clicking outside on mobile
                    if (window.innerWidth <= 1024 && 
                        sidebar && sidebar.classList.contains('open') && 
                        !sidebar.contains(e.target) && 
                        e.target !== hamburger) {
                        sidebar.classList.remove('open');
                    }
                });

                // Logout handlers
                if (logoutLink) {
                    logoutLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        handleLogout();
                    });
                }

                if (logoutSidebarLinks.length > 0) {
                    logoutSidebarLinks.forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            handleLogout();
                        });
                    });
                }

                // Filter controls
                if (applyFilters) {
                    applyFilters.addEventListener('click', () => {
                        currentPage = 1;
                        fetchStudentPerformance();
                    });
                }

                if (clearFilters) {
                    clearFilters.addEventListener('click', () => {
                        filterForm.value = '';
                        filterStream.value = '';
                        filterSubject.value = '';
                        filterExamType.value = '';
                        searchInput.value = '';
                        sortConfig = { column: '', direction: 'asc' };
                        sortColumn.value = '';
                        currentPage = 1;
                        fetchStudentPerformance();
                    });
                }

                if (fetchData) {
                    fetchData.addEventListener('click', () => {
                        currentPage = 1;
                        fetchStudentPerformance();
                    });
                }

                // Create table button
                if (createTableBtn) {
                    createTableBtn.addEventListener('click', createPerformanceTable);
                }

                // Search functionality
                if (searchInput) {
                    // Search on Enter key
                    searchInput.addEventListener('keyup', (e) => {
                        if (e.key === 'Enter') {
                            applySearchAndRender();
                        }
                    });
                    
                    // Clear search on Escape
                    searchInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape') {
                            searchInput.value = '';
                            applySearchAndRender();
                        }
                    });
                }

                if (searchBtn) {
                    searchBtn.addEventListener('click', () => {
                        applySearchAndRender();
                    });
                }

                // Sort functionality
                if (sortColumn) {
                    sortColumn.addEventListener('change', () => {
                        if (sortColumn.value) {
                            sortConfig.column = sortColumn.value;
                            renderExcelTable();
                        }
                    });
                }

                if (sortDirection) {
                    sortDirection.addEventListener('change', () => {
                        sortConfig.direction = sortDirection.value;
                        renderExcelTable();
                    });
                }

                // Pagination controls
                if (firstPage) {
                    firstPage.addEventListener('click', () => {
                        if (currentPage > 1) {
                            currentPage = 1;
                            renderExcelTable();
                        }
                    });
                }

                if (prevPage) {
                    prevPage.addEventListener('click', () => {
                        if (currentPage > 1) {
                            currentPage--;
                            renderExcelTable();
                        }
                    });
                }

                if (nextPage) {
                    nextPage.addEventListener('click', () => {
                        if (currentPage < totalPages) {
                            currentPage++;
                            renderExcelTable();
                        }
                    });
                }

                if (lastPage) {
                    lastPage.addEventListener('click', () => {
                        if (currentPage < totalPages) {
                            currentPage = totalPages;
                            renderExcelTable();
                        }
                    });
                }

                // Rows per page
                if (rowsPerPageSelect) {
                    rowsPerPageSelect.addEventListener('change', () => {
                        rowsPerPage = parseInt(rowsPerPageSelect.value);
                        currentPage = 1;
                        renderExcelTable();
                    });
                }

                // Export to CSV
                if (exportCsv) {
                    exportCsv.addEventListener('click', exportToCSV);
                }

                // Export summary
                if (exportSummary) {
                    exportSummary.addEventListener('click', exportSummaryStatistics);
                }
            }

            // Function to apply search and re-render table
            function applySearchAndRender() {
                currentPage = 1;
                renderExcelTable();
            }

            // Handle logout
            async function handleLogout() {
                if (confirm('Are you sure you want to logout?')) {
                    try {
                        const { error } = await supabase.auth.signOut();
                        if (error) throw error;
                        
                        console.log('Logout successful, redirecting to login...');
                        
                        // Redirect to login page
                        window.location.href = 'index.html';
                    } catch (error) {
                        console.error('Logout error:', error);
                        alert('Error during logout. Please try again.');
                    }
                }
            }

            // Make functions available globally
            window.fetchStudentPerformance = fetchStudentPerformance;
            window.checkTableExists = checkTableExists;

            // Start initialization when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', loadUserData);
            } else {
                loadUserData();
            }

        })();
    </script>
</body>
</html>